<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFFFFF">

    <title>大学杯 配信ツール</title>
    <link rel="icon" href="../icons/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Zen+Kaku+Gothic+New:wght@500;700;900&display=swap"
        rel="stylesheet">

    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />

    <style>
        /* --- テーマ定義 (Friendly Brutalism) --- */
        :root {
            --color-main: #1F2937;
            --color-bg: #F3F4F6;
            --color-panel: #FFFFFF;
            --color-shadow: #D1D5DB;
            --color-warning-bg: #FEF08A;
            --color-warning-text: #854D0E;
            --color-warning-border: #EAB308;
        }

        /* --- PWA対応のコアレイアウト --- */
        html {
            height: 100%;
            overflow: hidden;
            /* バウンス防止 */
        }

        body {
            font-family: 'Zen Kaku Gothic New', 'Kosugi Maru', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-main);

            /* 画面を完全に固定する設定 */
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            /* 引っ張り更新などを無効化 */

            display: flex;
            justify-content: center;
        }

        /* セーフエリア対応ユーティリティ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .pt-safe {
            padding-top: env(safe-area-inset-top, 0px);
        }

        /* アプリ本体のコンテナ */
        #app-container {
            width: 100%;
            max-width: 1080px;
            background-color: #FFFFFF;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
            font-size: 24px;
        }

        /* --- ナビゲーションボタン --- */
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6B7280;
            transition: all 0.2s ease;
            background-color: #FFFFFF;
            border-right: 2px solid var(--color-main);
            height: 100%;
            position: relative;
            flex: 1;
        }

        .nav-btn:last-child {
            border-right: none;
        }

        .nav-btn:hover {
            background-color: #F3F4F6;
            color: var(--color-main);
        }

        /* アクティブ状態 */
        .nav-btn.active {
            background-color: var(--color-main);
            color: #FFFFFF;
        }

        .nav-btn.active .material-symbols-rounded {
            color: #FFFFFF;
        }

        .nav-btn.active .nav-label {
            color: #FFFFFF;
        }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 900;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
            text-transform: uppercase;
        }

        /* --- メインコンテンツエリア --- */
        iframe {
            border: none;
            width: 100%;
            height: 100%;
            background-color: #F9FAFB;
        }

        /* --- ヘッダー要素 --- */
        .header-icon-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-main);
            background: #fff;
            color: var(--color-main);
            transition: all 0.2s;
            border-radius: 0.5rem;
        }

        .header-icon-btn:hover {
            background: var(--color-main);
            color: #fff;
        }

        #header-trouble-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            background-color: var(--color-warning-bg);
            color: var(--color-warning-text);
            border: 2px solid var(--color-main);
            border-radius: 0.5rem;
            white-space: nowrap;
            /* 折り返し防止 */
        }

        #header-trouble-status.hidden {
            display: none !important;
        }

        /* --- モーダル --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: #FFFFFF;
            width: 90%;
            max-width: 480px;
            border: 2px solid var(--color-main);
            box-shadow: 8px 8px 0 var(--color-main);
            padding: 0;
            border-radius: 1rem;
        }

        .input-brutal {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #D1D5DB;
            background-color: #F9FAFB;
            font-weight: 700;
            color: var(--color-main);
            transition: border-color 0.2s;
            border-radius: 0.5rem;
        }

        .input-brutal:focus {
            outline: none;
            border-color: var(--color-main);
            background-color: #FFF;
            box-shadow: 2px 2px 0 var(--color-shadow);
        }

        .btn-brutal {
            background-color: var(--color-main);
            color: white;
            font-weight: 900;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--color-main);
            transition: all 0.2s;
            border-radius: 0.5rem;
            box-shadow: 2px 2px 0 var(--color-shadow);
        }

        .btn-brutal:hover {
            background-color: white;
            color: var(--color-main);
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--color-shadow);
        }

        /* --- 通知バナー --- */
        #chat-notification {
            border: 2px solid var(--color-main);
            background: #FFFFFF;
            box-shadow: 4px 4px 0 var(--color-shadow);
            border-radius: 0.75rem;
        }

        @keyframes slideInDown {
            from {
                transform: translate(-50%, -120%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .notification-animate {
            animation: slideInDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>

<body>

    <div id="chat-notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-[95%] max-w-[480px] 
                p-4 cursor-pointer flex items-start gap-4 transition-transform">

        <div class="flex-shrink-0 text-blue-600 mt-1">
            <span class="material-symbols-rounded">chat</span>
        </div>

        <div class="flex-1 min-w-0">
            <div class="flex justify-between items-baseline mb-1">
                <p id="notif-sender" class="text-sm font-black text-gray-900 uppercase tracking-wider">Sender</p>
                <p class="text-xs font-bold text-gray-400">NOW</p>
            </div>
            <p id="notif-text" class="text-base font-bold text-gray-700 leading-snug line-clamp-2">Message content</p>
        </div>

        <button class="close-notification-btn text-gray-400 hover:text-gray-900"
            onclick="event.stopPropagation(); hideNotification();">
            <span class="material-symbols-rounded">close</span>
        </button>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6 border-b-2 border-gray-100">
                <h2 class="text-2xl font-black tracking-tight">USER SETTINGS</h2>
                <p class="text-xs font-bold text-gray-400 mt-1">表示名とロールの設定</p>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="username-input"
                        class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-wider">DISPLAY
                        NAME</label>
                    <input type="text" id="username-input" placeholder="名前を入力" class="input-brutal">
                </div>
                <div>
                    <label class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-wider">ROLE</label>
                    <div class="relative">
                        <select id="role-select" class="input-brutal appearance-none cursor-pointer">
                            <option value="運営">運営</option>
                            <option value="配信担当">配信担当</option>
                            <option value="実況">実況</option>
                            <option value="解説">解説</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                            <span class="material-symbols-rounded">expand_more</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t-2 border-gray-100 flex justify-end rounded-b-2xl">
                <button id="save-settings-btn" class="btn-brutal w-full md:w-auto">SAVE CHANGES</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header class="flex-shrink-0 bg-white border-b-2 border-gray-900 z-20 pt-safe">
            <div class="flex justify-between items-center px-4 py-3 h-16 relative">

                <div class="flex gap-2">
                    <a href="../index.html" class="header-icon-btn" title="ホームに戻る">
                        <span class="material-symbols-rounded">home</span>
                    </a>
                    <button id="global-settings-btn" class="header-icon-btn" title="ユーザー設定">
                        <span class="material-symbols-rounded">settings</span>
                    </button>
                </div>

                <h1 id="header-title"
                    class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 
                                        text-lg md:text-2xl font-black text-gray-900 tracking-tight whitespace-nowrap transition-opacity duration-300 text-center">
                    画面リモコン
                </h1>

                <div class="flex items-center justify-end min-w-[88px]">
                    <div id="header-trouble-status" class="hidden">
                        <span class="material-symbols-rounded !text-xl">error</span>
                        <span id="trouble-message">トラブル対応中</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 relative overflow-hidden bg-white">
            <iframe id="frame-chat" src="chat.html" class="absolute top-0 left-0 w-full h-full hidden"></iframe>
            <iframe id="frame-controller" src="controller.html" class="absolute top-0 left-0 w-full h-full"></iframe>
            <iframe id="frame-match" src="match-setting.html"
                class="absolute top-0 left-0 w-full h-full hidden"></iframe>
            <iframe id="frame-team" src="team-viewer.html" class="absolute top-0 left-0 w-full h-full hidden"></iframe>
            <iframe id="frame-script" src="script.html" class="absolute top-0 left-0 w-full h-full hidden"></iframe>
        </main>

        <nav class="flex-shrink-0 bg-white border-t-2 border-gray-900 z-20 pb-safe">
            <div class="flex h-20">
                <button class="nav-btn" data-target="chat" onclick="switchTab('chat')">
                    <span class="material-symbols-rounded">forum</span>
                    <span class="nav-label">CHAT</span>
                </button>
                <button class="nav-btn active" data-target="controller" onclick="switchTab('controller')">
                    <span class="material-symbols-rounded">settings_remote</span>
                    <span class="nav-label">CONTROL</span>
                </button>
                <button class="nav-btn" data-target="match" onclick="switchTab('match')">
                    <span class="material-symbols-rounded">tune</span>
                    <span class="nav-label" id="match-nav-text">MATCH SET</span>
                </button>
                <button class="nav-btn" data-target="team" onclick="switchTab('team')">
                    <span class="material-symbols-rounded">group_search</span>
                    <span class="nav-label">TEAMS</span>
                </button>
                <button class="nav-btn" data-target="script" onclick="switchTab('script')">
                    <span class="material-symbols-rounded">description</span>
                    <span class="nav-label">SCRIPT</span>
                </button>
            </div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const broadcastRef = doc(db, "state", "broadcast");
        const messagesRef = collection(db, "messages");

        // --- ユーザー設定管理 ---
        const settingsModal = document.getElementById('settings-modal');
        const usernameInput = document.getElementById('username-input');
        const roleSelect = document.getElementById('role-select');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const globalSettingsBtn = document.getElementById('global-settings-btn');
        const matchNavText = document.getElementById('match-nav-text');

        let currentUser = {
            name: localStorage.getItem('app_user_name') || '',
            role: localStorage.getItem('app_user_role') || '実況',
            uid: localStorage.getItem('app_user_uid') || crypto.randomUUID()
        };
        if (!localStorage.getItem('app_user_uid')) localStorage.setItem('app_user_uid', currentUser.uid);

        // 初期ロード
        updateMatchNavText();

        function openSettings() {
            usernameInput.value = currentUser.name;
            roleSelect.value = currentUser.role;
            settingsModal.classList.remove('hidden');
        }
        function closeSettings() { settingsModal.classList.add('hidden'); }

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeSettings();
        });

        saveSettingsBtn.addEventListener('click', () => {
            const newName = usernameInput.value.trim();
            if (newName) {
                currentUser.name = newName;
                currentUser.role = roleSelect.value;
                localStorage.setItem('app_user_name', currentUser.name);
                localStorage.setItem('app_user_role', currentUser.role);
                updateMatchNavText();
                notifyIframesOfSettings();
                closeSettings();
            } else {
                alert("名前を入力してください");
            }
        });
        globalSettingsBtn.addEventListener('click', openSettings);

        if (!currentUser.name) openSettings();

        function updateMatchNavText() {
            let newText;
            if (currentUser.role === '実況' || currentUser.role === '解説') {
                newText = 'MATCH INFO';
            } else {
                newText = 'MATCH SET';
            }
            matchNavText.textContent = newText;
            return newText;
        }

        function notifyIframesOfSettings() {
            const frames = ['frame-chat', 'frame-controller', 'frame-match', 'frame-team', 'frame-script'];
            frames.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.contentWindow) {
                    el.contentWindow.postMessage({ type: 'settings-update', user: currentUser }, '*');
                }
            });
        }

        document.querySelectorAll('iframe').forEach(frame => {
            frame.addEventListener('load', () => {
                frame.contentWindow.postMessage({ type: 'settings-update', user: currentUser }, '*');
            });
        });


        // --- 既存ロジック ---
        const headerTroubleStatus = document.getElementById('header-trouble-status');
        const troubleMessage = document.getElementById('trouble-message');
        const chatNotification = document.getElementById('chat-notification');
        const notifSender = document.getElementById('notif-sender');
        const notifText = document.getElementById('notif-text');
        let notificationTimeout;

        let currentTab = 'controller';
        let lastMessageTimestamp = Date.now();

        const troubleMessages = { 'lag': 'ラグ対応', 'stream': '配信トラブル', 'admin': '運営トラブル' };

        onSnapshot(broadcastRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const troubleState = data.trouble || 'none';
                if (troubleState === 'none') { headerTroubleStatus.classList.add('hidden'); }
                else { troubleMessage.textContent = troubleMessages[troubleState] || 'トラブル対応中'; headerTroubleStatus.classList.remove('hidden'); }
            }
        });

        const messagesQuery = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
        onSnapshot(messagesQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();

                    if (data.timestamp > lastMessageTimestamp && data.uid !== currentUser.uid && currentTab !== 'chat') {
                        const isStaffMsg = data.isStaffOnly;
                        const amIStaff = (currentUser.role === '運営' || currentUser.role === '配信担当');

                        if (!isStaffMsg || (isStaffMsg && amIStaff)) {
                            showNotification(data.name, data.text, isStaffMsg);
                        }
                    }
                    if (data.timestamp > lastMessageTimestamp) { lastMessageTimestamp = data.timestamp; }
                }
            });
        });

        function showNotification(sender, text, isStaffOnly) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notifSender.textContent = sender;
            notifText.textContent = text;

            if (isStaffOnly) {
                chatNotification.style.borderColor = '#2563EB';
                chatNotification.style.backgroundColor = '#EFF6FF';
            } else {
                chatNotification.style.borderColor = '#111827';
                chatNotification.style.backgroundColor = '#FFFFFF';
            }

            chatNotification.classList.remove('hidden');
            chatNotification.classList.add('notification-animate');
            chatNotification.onclick = (e) => {
                if (!e.target.closest('.close-notification-btn')) { switchTab('chat'); hideNotification(); }
            };
            notificationTimeout = setTimeout(() => { hideNotification(); }, 5000);
        }

        window.hideNotification = function () {
            chatNotification.classList.add('hidden');
            chatNotification.classList.remove('notification-animate');
            if (notificationTimeout) clearTimeout(notificationTimeout);
        };

        window.switchTab = function (targetName) {
            currentTab = targetName;
            localStorage.setItem('tools_activeTab', targetName);
            if (targetName === 'chat') { hideNotification(); }

            const matchTitle = updateMatchNavText();

            const titles = {
                chat: "チャット",
                controller: "画面リモコン",
                match: matchTitle === 'MATCH INFO' ? "対戦情報" : "対戦設定",
                team: "チーム情報",
                script: "配信台本"
            };

            document.querySelectorAll('iframe').forEach(el => { el.classList.add('hidden'); });
            const targetFrame = document.getElementById(`frame-${targetName}`);
            if (targetFrame) {
                targetFrame.classList.remove('hidden');
                if (targetName === 'script') {
                    if (targetFrame.contentWindow.document.readyState === 'complete') {
                        targetFrame.contentWindow.postMessage('scroll-to-current', '*');
                    } else {
                        targetFrame.onload = () => { targetFrame.contentWindow.postMessage('scroll-to-current', '*'); };
                    }
                }
            }

            const titleEl = document.getElementById('header-title');
            titleEl.style.opacity = 0;
            setTimeout(() => {
                titleEl.textContent = titles[targetName];
                titleEl.style.opacity = 1;
            }, 150);

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`.nav-btn[data-target="${targetName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        };

        const savedTab = localStorage.getItem('tools_activeTab');
        window.switchTab(savedTab || 'controller');

        notifyIframesOfSettings();

    </script>
</body>

</html>