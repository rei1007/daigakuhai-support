<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配信台本表示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        body { font-family: 'Kosugi Maru', sans-serif; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* 台本タイルスタイル */
        .script-paragraph {
            background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 1.25rem; 
            padding: 1.25rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease-in-out; opacity: 0.9;
        }
        .paragraph-future { background-color: #F9FAFB; border-color: #E5E7EB; opacity: 0.9; }
        .paragraph-future:hover { background-color: #F3F4F6; border-color: #D1D5DB; }
        .paragraph-past { background-color: #F9FAFB; border-color: #E5E7EB; opacity: 0.45; }
        .paragraph-past:hover { opacity: 0.7; }
        
        /* アクティブな段落 (強調) */
        .paragraph-active {
            background-color: #ffffff; border-color: #111827; 
            box-shadow: 0 4px 10px -1px rgba(0,0,0,0.1), 0 2px 6px -2px rgba(0,0,0,0.1);
            opacity: 1; transform: scale(1.02);
        }

        .speaker-name {
            display: inline-block; font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem; 
            background-color: #F3F4F6; padding: 0.25rem 0.75rem; border-radius: 9999px; border: 1px solid #D1D5DB;
        }
        .paragraph-active .speaker-name { background-color: #111827; color: #F9FAFB; border-color: #111827; }
        
        .line-text { 
            color: #1F2937; 
            line-height: 1.8; 
            /* innerHTML使用時でも改行コード(\n)を反映させたい場合は pre-line を維持しますが、
               <br>タグを主に使用する場合は normal でも構いません。
               両方対応できるよう pre-line にしておきます。 */
            white-space: pre-line; 
        }
        .paragraph-past .line-text { color: #4B5563; }

        .speaker-memo .speaker-name { background-color: #FEF3C7; border-color: #FDE68A; color: #92400E; font-style: italic; }
        .paragraph-active.speaker-memo .speaker-name { background-color: #D97706; color: #ffffff; border-color: #D97706; }
        
        .speaker-action .speaker-name { background-color: transparent; border-color: transparent; color: #4B5563; font-style: italic; font-weight: 500; font-size: 1rem; }
        .paragraph-active.speaker-action .speaker-name { background-color: transparent; border-color: transparent; color: #111827; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="max-w-[1080px] mx-auto">
        <main id="script-container" class="p-4 md:p-6">
            <div class="text-center text-gray-500 py-10">台本データを読み込み中...</div>
        </main>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const broadcastRef = doc(db, "state", "broadcast");
        const scriptContainer = document.getElementById('script-container');
        
        // 現在のアクティブな行番号を保持
        let currentActiveIndex = 0;

        // --- JSON読み込み処理 ---
        async function loadScript() {
            try {
                const response = await fetch('../json/script.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const scriptData = await response.json();
                initializeScript(scriptData);
                
            } catch (error) {
                console.error("台本データの読み込みに失敗しました:", error);
                scriptContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-600 p-4 rounded-xl text-center">
                        <p class="font-bold mb-2">読み込みエラー</p>
                        <p class="text-sm">script.jsonが見つからないか、形式が正しくありません。</p>
                        <p class="text-xs mt-2 text-gray-500">${error.message}</p>
                    </div>
                `;
            }
        }

        // --- 初期化処理 ---
        function initializeScript(data) {
            scriptContainer.innerHTML = ''; 

            data.forEach((item, index) => {
                const tile = document.createElement('div');
                tile.className = 'script-paragraph';
                tile.dataset.index = index;
                if (item.speaker === 'メモ') tile.classList.add('speaker-memo');
                else if (item.speaker.startsWith('→')) tile.classList.add('speaker-action');
                
                const speakerName = document.createElement('div');
                speakerName.className = 'speaker-name';
                speakerName.textContent = item.speaker;
                
                const lineText = document.createElement('p');
                lineText.className = 'line-text';
                // 【修正】textContent から innerHTML に変更
                // これにより <br> や <span> などのタグが有効になります
                lineText.innerHTML = item.line; 

                tile.appendChild(speakerName);
                tile.appendChild(lineText);
                scriptContainer.appendChild(tile);
            });

            // データ読み込み完了後に現在の位置を反映
            updateScriptView(currentActiveIndex);
        }

        // --- スクロール関数 ---
        function scrollToActive(element) {
            const target = element || document.querySelector('.paragraph-active');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- 表示更新ロジック ---
        function updateScriptView(activeIndex) {
            currentActiveIndex = activeIndex; 
            const allTiles = document.querySelectorAll('.script-paragraph');
            
            if (allTiles.length === 0) return;

            let activeTile = null;
            allTiles.forEach(tile => {
                const index = parseInt(tile.dataset.index, 10);
                tile.classList.remove('paragraph-active', 'paragraph-past', 'paragraph-future');
                if (index < activeIndex) { tile.classList.add('paragraph-past'); } 
                else if (index === activeIndex) { 
                    tile.classList.add('paragraph-active'); 
                    activeTile = tile;
                } 
                else { tile.classList.add('paragraph-future'); }
            });
            
            if (activeTile) { scrollToActive(activeTile); }
        }

        // --- Firestore リスナー ---
        onSnapshot(broadcastRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.scriptIndex !== undefined) { 
                    updateScriptView(data.scriptIndex); 
                }
            }
        });

        // --- クリック時の更新 ---
        scriptContainer.addEventListener('click', async (e) => {
            const clickedTile = e.target.closest('.script-paragraph');
            if (clickedTile) {
                const newIndex = parseInt(clickedTile.dataset.index, 10);
                try { await setDoc(broadcastRef, { scriptIndex: newIndex }, { merge: true }); } catch(err) { console.error(err); }
            }
        });

        // --- 親フレームからのスクロール指示 ---
        window.addEventListener('message', (event) => {
            if (event.data === 'scroll-to-current') {
                scrollToActive();
            }
        });

        loadScript();

    </script>
</body>
</html>