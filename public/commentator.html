<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学杯 配信サポート (実況解説ページ)</title>
    <link rel="icon" href="icons/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
        rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <style>
        #show-stages-modal-button {
            display: block;
            width: 100%;
            max-width: 600px;
            margin: 16px auto 0 auto;
        }

        #stage-view-modal .modal-content p,
        #topic-modal .modal-body p,
        /* モーダル共通の説明pタグ */
        #glossary-modal .modal-body p {
            margin-top: 0;
            margin-bottom: 1.6rem;
            font-size: 1.4rem;
            color: var(--on-surface-variant-color);
        }

        /* 用語集モーダルのdl内の調整 */
        #glossary-modal dl {
            margin-top: var(--space-md);
        }
    </style>
</head>

<body>
    <header class="header">
        <h1><a href="index.html">大学杯 配信サポート (実況解説)</a></h1>
        <div class="connection-indicator" id="connection-indicator">
            <div class="status-dot"></div><span class="connection-text">接続: <span
                    id="connection-status">接続中...</span></span>
        </div>
    </header>

    <main>
        <div id="tab-content-comment" class="tab-content">
            <div class="comment-history" id="comment-history"></div>
            <div class="tab-action-bar">
                <div class="comment-input-group">
                    <button id="edit-name-button" class="icon-button" title="表示名を設定"><span
                            class="material-symbols-rounded">settings</span></button>
                    <input type="text" id="comment-input" placeholder="コメントを入力">
                    <button id="send-comment-button"><span class="material-symbols-rounded">send</span><span
                            class="send-text">送信</span></button>
                </div>
            </div>
        </div>

        <div id="tab-content-script" class="tab-content">
            <div class="tab-main-content">
                <section class="script-card">
                    <h2>台本</h2>
                    <div id="script-card-content" class="script-full-list"></div>
                </section>
            </div>
            <div class="tab-action-bar modal-button-bar">
                <button id="topic-list-button">
                    <span class="material-symbols-rounded">list_alt</span> 話題表
                </button>
                <button id="glossary-button">
                    <span class="material-symbols-rounded">menu_book</span> 用語集
                </button>
            </div>
        </div>

        <div id="tab-content-stream-view" class="tab-content">
            <div class="tab-main-content">
                <section id="stream-view-section">
                    <h2>配信画面</h2>
                    <div class="stream-view-selector" id="stream-view-selector">
                        <button id="stream-view-logo" data-view="logo">
                            <span class="material-symbols-rounded">photo_camera</span>
                            ロゴ
                        </button>
                        <button id="stream-view-matchInfo" data-view="matchInfo">
                            <span class="material-symbols-rounded">scoreboard</span>
                            対戦情報
                        </button>
                        <button id="stream-view-alphaDetail" data-view="alphaDetail">
                            <span class="material-symbols-rounded">person</span>
                            アルファ詳細
                        </button>
                        <button id="stream-view-bravoDetail" data-view="bravoDetail">
                            <span class="material-symbols-rounded">person</span>
                            ブラボー詳細
                        </button>
                        <button id="stream-view-stageList" data-view="stageList">
                            <span class="material-symbols-rounded">distance</span>
                            ステージ
                        </button>
                        <button id="stream-view-replay" data-view="replay">
                            <span class="material-symbols-rounded">autoplay</span>
                            リプレイ
                        </button>
                    </div>
                    <div class="stream-status-display-only" id="stream-status-display-only">
                        <div id="status-display-waiting" class="status-tile is-waiting">
                            <span class="material-symbols-rounded">hourglass_empty</span>
                            試合待機中
                        </div>
                        <div id="status-display-ingame" class="status-tile is-ingame">
                            <span class="material-symbols-rounded">swords</span>
                            対戦中
                        </div>
                        <div id="status-display-lag" class="status-tile is-lag">
                            <span class="material-symbols-rounded">error</span>
                            ラグ対応中
                        </div>
                        <div id="status-display-trouble" class="status-tile is-trouble">
                            <span class="material-symbols-rounded">warning</span>
                            トラブル発生
                        </div>
                    </div>
                </section>

                <section id="match-status-section">
                    <div id="match-status-display">
                    </div>
                    <button id="show-stages-modal-button" class="outline-button">
                        使用ステージを確認
                    </button>
                </section>
            </div>
        </div>

        <div id="tab-content-match-team-info" class="tab-content">
            <div class="tab-main-content">
                <section id="team-display-section">
                    <div class="team-display-area">
                        <div id="team-alpha-card-wrapper" class="team-card-wrapper active">
                            <div id="team-alpha-card" class="team-card"></div>
                        </div>
                        <div id="team-bravo-card-wrapper" class="team-card-wrapper">
                            <div id="team-bravo-card" class="team-card"></div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="tab-action-bar">
                <div class="control-group">
                    <h2>表示チーム切り替え</h2>
                    <div class="local-view-group">
                        <div class="team-selector">
                            <select id="view-alpha-select"></select>
                            <span class="vs-text">VS</span>
                            <select id="view-bravo-select"></select>
                        </div>
                        <div class="sync-button-pc pc-only">
                            <button id="sync-view-button-pc" class="sync-button" title="表示チームを対戦チームに同期">
                                <span class="material-symbols-rounded">arrow_downward</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mobile-action-group mobile-only">
                    <div class="segmented-control">
                        <button id="display-alpha-btn" class="active">アルファ</button>
                        <button id="display-bravo-btn">ブラボー</button>
                    </div>
                    <button id="sync-view-button-mobile" class="sync-button" title="表示チームを対戦チームに同期">
                        <span class="material-symbols-rounded">arrow_downward</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="comment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="comment-modal-heading">新着コメント</h2>
                <button class="modal-close" id="comment-modal-close"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <p id="comment-modal-text"></p>
            </div>
        </div>
    </div>
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>表示名を設定</h2>
                <button class="modal-close" id="name-modal-close"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="name-input">チャットで表示される名前を入力してください。</label>
                    <input type="text" id="name-input" placeholder="例: 解説A">
                </div>
                <button id="save-name-button" class="primary-button">保存</button>
            </div>
        </div>
    </div>
    <div id="stage-view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>使用ステージ一覧</h2>
                <button class="modal-close" id="stage-view-modal-close"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <p>大会設定で使用が許可されているステージの一覧です。（グレーアウト：使用しないステージ）</p>
                <div class="stage-grid" id="stage-view-grid"></div>
            </div>
        </div>
    </div>
    <div id="topic-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>話題表</h2>
                <button class="modal-close" id="topic-modal-close"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <p>※試合間など、空いた時間の話題にお使いください！</p>
                <ul>
                    <li>本大会への意気込み</li>
                    <li>大学時代の思い出</li>
                    <li>スプラトゥーンを始めたきっかけ</li>
                    <li>スプラトゥーン歴、プレイ時間など</li>
                    <li>おふたりが自分の持ちブキを持つ理由、持ち武器の魅力</li>
                    <li>自分が出場(もしくは実況解説を担当して)して特に印象に残っている大会や企画</li>
                    <li>Switch2について</li>
                    <li>スプラ4に期待すること</li>
                    <li>正直スプラ初代、２、３どれが一番好きか</li>
                    <li>様々な大会(大学杯、スプラ甲子園等)に関すること(大学杯に出場した時の思い出など)</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="glossary-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用語集</h2>
                <button class="modal-close" id="glossary-modal-close"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <h3>＜大学杯関係＞</h3>
                <dl>
                    <dt>大学杯(無印):</dt>
                    <dd>全国の大学スプラトゥーンサークルに所属するメンバーがその頂点を競い合う大会。ルールはエリア。第8回まで開催された。最古の大会は2022年。</dd>
                    <dt>クロス大学制:</dt>
                    <dd>大学杯で採用されている複数の大学スプラトゥーンサークルのメンバーとチームを組むことが出来る制度。基本的は2大学の制限があります。<br>※注：本大会はサークル対抗戦の意味合いが強いので、クロス大学制を導入していません。
                    </dd>
                </dl>
                <h3>＜大学サークル関係＞</h3>
                <p>全サークル様をご紹介したいのですが、あまりにも多すぎるので、参加チームが多かったり、運営代表が個人的に注目しているサークルを選んで紹介します。実況する際のネタにしていただけたら幸いです‼️</p>
                <dl>
                    <dt>・QTSSスプラ部門(九州工業大学)</dt>
                    <dd>3チーム参戦。2024年設立で新しめ。新入生がたくさん加入し急成長中です</dd>
                    <dt>・千葉工大スプラトゥーンサークル(千葉工業大学)</dt>
                    <dd>1チーム参戦。2022年の第二回大学杯を優勝した古豪。</dd>
                    <dt>・め～イカ（名古屋大学）</dt>
                    <dd>4チーム参戦。2025年5月の新入生必須の大会、大学杯Freshにて、めい大決戦(明治大学vs名古屋大学)となった決勝を勝ち抜き105チームの頂点に輝いた。サーモンランの大会、第2回大学杯鮭優勝。
                    </dd>
                    <dt>・明治イカ研究所(明治大学)</dt>
                    <dd>2チーム参戦。第六回大学杯準優勝。5月の大学杯Fresh準優勝。</dd>
                    <dt>・でん(東京大学)</dt>
                    <dd>2チーム参戦。2025年3月の大学杯(無印)優勝チームはここ。2024年度大学杯Freshを優勝。他にも第1回、第8回大学杯を優勝するなど、さすがの最高学府である。</dd>
                    <dt>・早稲田スプラトゥーン研究会(早稲田大学)</dt>
                    <dd>2チーム参戦。国内最大級のスプラサークル。新歓のビラがバズったことがある。エリア無制限大会、第4回大学杯+優勝。以降はBest4ばかりで、その壁を乗り越えられるか注目。</dd>
                    <dt>・慶應スプラ同好会、しょなすぷっ！(慶応義塾大学)</dt>
                    <dd>1チーム参戦。慶應スプラ同好会としょなすぷっ！の2サークルがあり、後者は主に湘南藤沢キャンパスを拠点としている。慶スプはナワバリ無制限大会、第1回大学杯θを優勝。しょなすぷは、ナワバリの初心者向け大会、第8回大学杯0優勝。
                    </dd>
                    <dt>・すぷぱれ！(近畿大学)</dt>
                    <dd>4チーム参戦。エリア無制限大会、第5回大学杯+準優勝。</dd>
                    <dt>・リツメイカ(立命館大学)</dt>
                    <dd>2チーム参戦。おととし大学杯Fresh、昨年度大学杯Freshを”準”優勝。雪辱を果たしに来た2025年度大学杯はBest4に終わる。今こそ優勝をつかみ取れるだろうか。</dd>
                    <dt>・OECU esports project スプラ部門(大阪電気通信大学)</dt>
                    <dd>1チーム参戦。おととしの第1回大学杯Fresh優勝。当時の優勝メンバーが3チームに分散しながらも参戦している。</dd>
                    <dt>・法政大学スプラサークル(法政大学)</dt>
                    <dd>1チーム参戦。第8回大学杯0準優勝。第7回大学杯Best4。(規約上、他大会に触れるのは危険なのですが、とあるオフ大会でも、大学サークル枠中で最も優秀な成績Best24を収めたことがあります。)
                    </dd>
                    <dt>・Gakushu ink(学習院大学)</dt>
                    <dd>1チーム参戦。2024/12、新設サークル。</dd>
                </dl>
            </div>
        </div>
    </div>
    <nav class="tab-bar">
        <div class="tab-bar-inner">
            <button class="tab-button" data-tab="comment">
                <span class="material-symbols-rounded">chat</span>
                <span class="tab-label">コメント</span>
            </button>
            <button class="tab-button" data-tab="script">
                <span class="material-symbols-rounded">description</span>
                <span class="tab-label">台本</span>
            </button>
            <button class="tab-button" data-tab="stream-view">
                <span class="material-symbols-rounded">smart_display</span>
                <span class="tab-label">配信・対戦情報</span>
            </button>
            <button class="tab-button" data-tab="match-team-info">
                <span class="material-symbols-rounded">people</span>
                <span class="tab-label">チーム情報</span>
            </button>
        </div>
    </nav>

    <script>
        const MY_ROLE = '実況解説';
        // グローバル変数 (静的データ)
        let teamsData = [], scriptData = [], stagesData = [];
        let myDisplayName = '';
        let unusedStages = [];

        // 自分のセッションIDをlocalStorageから取得、なければ生成
        let mySessionId = localStorage.getItem('mySessionId');
        if (!mySessionId || !mySessionId.startsWith('cc-')) {
            mySessionId = `cc-${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem('mySessionId', mySessionId);
        }

        // 監視対象のFirestoreドキュメント
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');
        let currentlyDisplayedTeam = 'alpha'; // モバイル表示用
        const pageLoadTime = Date.now();
        let officialMatchup = { alphaTeamId: null, bravoTeamId: null };
        let isViewLocked = false; // ユーザーが手動でチーム表示を変更したか

        // DOM要素のキャッシュ
        const getEl = (id) => document.getElementById(id);
        const DOMElements = {
            connectionIndicator: getEl('connection-indicator'),
            connectionStatus: getEl('connection-status'),
            commentInput: getEl('comment-input'),
            sendCommentButton: getEl('send-comment-button'),
            commentHistory: getEl('comment-history'),
            scriptCardContent: getEl('script-card-content'),
            matchStatusDisplay: getEl('match-status-display'),
            teamAlphaCard: getEl('team-alpha-card'),
            teamBravoCard: getEl('team-bravo-card'),
            teamAlphaCardWrapper: getEl('team-alpha-card-wrapper'),
            teamBravoCardWrapper: getEl('team-bravo-card-wrapper'),
            viewAlphaSelect: getEl('view-alpha-select'),
            viewBravoSelect: getEl('view-bravo-select'),
            syncViewButtonPC: getEl('sync-view-button-pc'),
            syncViewButtonMobile: getEl('sync-view-button-mobile'),
            displayAlphaBtn: getEl('display-alpha-btn'),
            displayBravoBtn: getEl('display-bravo-btn'),
            commentModal: getEl('comment-modal'),
            commentModalHeading: getEl('comment-modal-heading'),
            commentModalText: getEl('comment-modal-text'),
            commentModalClose: getEl('comment-modal-close'),
            nameModal: getEl('name-modal'),
            nameModalClose: getEl('name-modal-close'),
            nameInput: getEl('name-input'),
            saveNameButton: getEl('save-name-button'),
            editNameButton: getEl('edit-name-button'),
            showStagesModalButton: getEl('show-stages-modal-button'),
            stageViewModal: getEl('stage-view-modal'),
            stageViewModalClose: getEl('stage-view-modal-close'),
            stageViewGrid: getEl('stage-view-grid'),
            streamViewSelector: getEl('stream-view-selector'), // セレクター全体
            // ▼▼▼ 配信画面ボタン ▼▼▼
            streamViewLogo: getEl('stream-view-logo'),
            streamViewMatchInfo: getEl('stream-view-matchInfo'),
            streamViewAlphaDetail: getEl('stream-view-alphaDetail'),
            streamViewBravoDetail: getEl('stream-view-bravoDetail'),
            streamViewStageList: getEl('stream-view-stageList'),
            streamViewReplay: getEl('stream-view-replay'),
            // ▼▼▼ 配信状態表示 ▼▼▼
            streamStatusDisplayOnly: getEl('stream-status-display-only'),
            statusDisplayWaiting: getEl('status-display-waiting'),
            statusDisplayIngame: getEl('status-display-ingame'), // 追加
            statusDisplayLag: getEl('status-display-lag'),
            statusDisplayTrouble: getEl('status-display-trouble'), // 追加
            // ▼▼▼ 台本タブボタン＆モーダル ▼▼▼
            topicListButton: getEl('topic-list-button'),
            glossaryButton: getEl('glossary-button'),
            topicModal: getEl('topic-modal'),
            topicModalClose: getEl('topic-modal-close'),
            glossaryModal: getEl('glossary-modal'),
            glossaryModalClose: getEl('glossary-modal-close'),
        };

        // 接続ステータスをUIに反映
        const setConnectionStatus = (status) => {
            DOMElements.connectionIndicator.classList.remove('is-connected', 'is-connecting', 'is-disconnected');
            DOMElements.connectionIndicator.classList.add(`is-${status}`);
            const statusText = { connecting: '接続中...', connected: '正常', disconnected: '切断' };
            DOMElements.connectionStatus.textContent = statusText[status];
        };

        // 表示中のチームがFirestoreの対戦チームと同期しているか確認
        const checkSyncStatus = () => {
            if (!officialMatchup.alphaTeamId) return;
            const isDesynced = DOMElements.viewAlphaSelect.value !== officialMatchup.alphaTeamId ||
                DOMElements.viewBravoSelect.value !== officialMatchup.bravoTeamId;
            // 同期ズレがあれば同期ボタンをハイライト
            if (DOMElements.syncViewButtonPC) DOMElements.syncViewButtonPC.classList.toggle('is-desynced', isDesynced);
            if (DOMElements.syncViewButtonMobile) DOMElements.syncViewButtonMobile.classList.toggle('is-desynced', isDesynced);
        };

        // Firestoreのセッション情報を監視
        sessionDocRef.onSnapshot((doc) => {
            if (!doc.exists) { setConnectionStatus('disconnected'); return; }
            const state = doc.data();
            setConnectionStatus('connected');

            unusedStages = state.unusedStages || [];

            // 対戦カードの更新
            if (state.matchup && state.matchup.alphaTeamId) {
                officialMatchup = state.matchup;
                if (!isViewLocked) {
                    // 表示がロックされていなければ、セレクトボックスを自動更新
                    DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
                    DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
                    updateTeamDisplay();
                } else {
                    // ロックされている場合は同期ズレをチェック
                    checkSyncStatus();
                }
            }

            // 各コンポーネントを描画
            renderScript(state.scriptIndex || 0);
            renderComments(state.comments || []);
            renderMatchStatus(state);
            renderStreamViewSelector(state.currentStreamView); // 操作可能に変更
            renderStreamStatus(state.streamState || { match: 'outside', incident: 'none' }); // 修正

            // 新着コメントモーダルの表示判定
            const lastComment = (state.comments || []).slice(-1)[0];
            const isCommentTabActive = document.querySelector('.tab-button[data-tab="comment"]')?.classList.contains('active');
            if (lastComment && lastComment.senderId !== mySessionId && !isCommentTabActive) {

                // --- システムメッセージでもモーダルを出すように修正済み ---

                const lastShownTime = DOMElements.commentModal.dataset.lastShownTime || 0;
                if (lastComment.timestamp && lastComment.timestamp.toMillis() > pageLoadTime && lastComment.timestamp.toMillis() > lastShownTime) {
                    showCommentModal(lastComment.text, lastComment.role, lastComment.displayName);
                    DOMElements.commentModal.dataset.lastShownTime = lastComment.timestamp.toMillis();
                }
            }
        }, (error) => { setConnectionStatus('disconnected'); });

        // コメント履歴を描画
        const renderComments = (comments = []) => {
            DOMElements.commentHistory.innerHTML = comments.map(c => {
                const isMe = c.senderId === mySessionId;
                let badgeClass = 'is-other'; let badgeText = c.role;
                if (isMe) { badgeClass = 'is-me'; badgeText = 'Me'; }
                else if (c.role === '運営') { badgeClass = 'is-operator'; }
                else if (c.role === '実況解説') { badgeClass = 'is-commentator'; }
                else if (c.role === '配信担当') { badgeClass = 'is-stream-staff'; }
                else if (c.role === 'システム') { badgeClass = 'is-system'; badgeText = 'システム'; }

                const displayNameHTML = c.displayName ? `<span class="display-name">${c.displayName}</span>` : '';

                let wrapperClass = isMe ? 'is-me' : '';
                if (c.role === 'システム') wrapperClass = 'is-system-message';

                return `<div class="comment-item-wrapper ${wrapperClass}">
                           <div class="comment-item" id="comment-${c.id}">
                             <div class="comment-header">${displayNameHTML}<span class="badge ${badgeClass}">${badgeText}</span></div>
                             <span class="text">${c.text}</span>
                           </div>
                         </div>`;
            }).join('');
            DOMElements.commentHistory.scrollTop = DOMElements.commentHistory.scrollHeight;
        };

        // 台本を描画 (現在の進行状況をハイライト)
        const renderScript = (currentIndex = 0) => {
            if (!scriptData || scriptData.length === 0) return;
            DOMElements.scriptCardContent.innerHTML = scriptData.map((p, i) => {
                let statusClass = '';
                if (i < currentIndex) statusClass = 'is-done';
                if (i === currentIndex) statusClass = 'is-current';
                return `<div class="script-paragraph ${statusClass}" data-index="${i}" id="script-item-${i}"><b>${p.speaker}:</b> ${p.line}</div>`
            }).join('');
            const currentEl = getEl(`script-item-${currentIndex}`);
            if (currentEl) currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        // チーム情報カードのHTMLを生成
        const createTeamCardHTML = (teamId) => {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return '<h3>チーム情報を読み込み中...</h3>';
            // チームデータからプレイヤー情報を抽出（XPを数値に変換）
            const players = [
                { name: team.p1_name, xp: parseInt(team.p1_xp, 10) || 0, weapon: team.p1_weapon },
                { name: team.p2_name, xp: parseInt(team.p2_xp, 10) || 0, weapon: team.p2_weapon },
                { name: team.p3_name, xp: parseInt(team.p3_xp, 10) || 0, weapon: team.p3_weapon },
                { name: team.p4_name, xp: parseInt(team.p4_xp, 10) || 0, weapon: team.p4_weapon }
            ];

            const playerListHTML = players.filter(p => p.name).map(p =>
                `<div class="player-tile">
                    <div class="player-tile-top">
                        <span class="player-name">${p.name}</span>
                        <span class="xp-badge ${p.xp >= 3200 ? 'is-highlight' : ''}">XP: ${p.xp || '----'}</span>
                    </div>
                     <div class="player-tile-bottom">${(p.weapon || '').replace(/\//g, ' / ')}</div>
                </div>`
            ).join('');
            return `<div class="team-card-header">
                        <p class="university-name">${team.university} / ${team.circle}</p>
                        <h2 class="team-name">${team.teamName}</h2>
                    </div>
                    <h3>プレイヤー情報</h3>
                    <div class="player-tiles-container">${playerListHTML || '<p>プレイヤー情報なし</p>'}</div>
                    <div class="info-tile"><h3>チームコメント</h3><p>${team.comment || '-'}</p></div>
                    <div class="info-tile"><h3>戦略</h3><p>${team.tactics || '-'}</p></div>
                    <div class="info-tile"><h3>実績</h3><p>${team.records || '-'}</p></div>
                    <div class="info-tile"><h3>サークルからのメッセージ</h3><p>${team.message || '-'}</p></div>`;
        };


        // 「配信・対戦情報」タブの対戦ステータスを描画
        const renderMatchStatus = (state) => {
            if (!state.matchup || !teamsData.length) {
                DOMElements.matchStatusDisplay.innerHTML = '<h2>対戦情報</h2><p>対戦情報が設定されていません。</p>';
                return;
            }
            const alphaTeam = teamsData.find(t => t.id === state.matchup.alphaTeamId);
            const bravoTeam = teamsData.find(t => t.id === state.matchup.bravoTeamId);
            if (!alphaTeam || !bravoTeam) return;
            const stages = state.stages || [];
            const alphaWins = stages.filter(s => s && s.winner === 'alpha').length;
            const bravoWins = stages.filter(s => s && s.winner === 'bravo').length;
            const bestOf = state.bestOf || 'BO3';
            const numStages = bestOf === 'BO5' ? 5 : 3;
            const stageImagesHTML = Array.from({ length: numStages }).map((_, i) => {
                const stageData = stages[i] || { stage: '未決定', winner: null };
                const stageName = stageData.stage || '未決定';
                let imageFolder = './stage-image/';
                if (stageData.winner === 'alpha') { imageFolder = './stage-alpha/'; }
                else if (stageData.winner === 'bravo') { imageFolder = './stage-bravo/'; }
                const imagePath = `${imageFolder}${encodeURIComponent(stageName)}.png`;
                return `<div class="stage-image-item">
                            <img src="${imagePath}" alt="${stageName}" onerror="this.onerror=null;this.src='./stage-image/未決定.png';">
                        </div>`;
            }).join('');
            DOMElements.matchStatusDisplay.innerHTML = `
                <h2>対戦情報</h2>
                <div class="matchup-header">
                    <div class="team-name-display">${alphaTeam.teamName}</div>
                    <div class="vs-text">VS</div>
                    <div class="team-name-display">${bravoTeam.teamName}</div>
                </div>
                <div class="match-status-display">
                    <p class="round-info">${state.roundInfo || 'ラウンド情報未設定'}</p>
                    <div class="score-display">
                        <span class="score">${alphaWins}</span>
                        <span>-</span>
                        <span class="score">${bravoWins}</span>
                    </div>
                    <div class="stage-images">${stageImagesHTML}</div>
                </div>
            `;
        };

        // 配信画面セレクターのアクティブ状態を更新 (操作可能に変更)
        const renderStreamViewSelector = (currentView) => {
            const view = currentView || 'matchInfo'; // デフォルト
            const buttons = [
                DOMElements.streamViewLogo, DOMElements.streamViewMatchInfo,
                DOMElements.streamViewAlphaDetail, DOMElements.streamViewBravoDetail,
                DOMElements.streamViewStageList, DOMElements.streamViewReplay
            ];
            buttons.forEach(button => {
                if (button) {
                    button.classList.toggle('active', button.dataset.view === view);
                }
            });
        };

        // 配信ステータス表示（実況解説ページ専用）を更新 (修正)
        const renderStreamStatus = (streamState) => {
            const matchStatus = streamState.match || 'outside';
            const incidentStatus = streamState.incident || 'none';
            const container = DOMElements.streamStatusDisplayOnly;

            if (!container) return;

            // まず全タイルを非表示に
            const allTiles = [
                DOMElements.statusDisplayWaiting, DOMElements.statusDisplayIngame,
                DOMElements.statusDisplayLag, DOMElements.statusDisplayTrouble
            ];
            allTiles.forEach(tile => tile?.classList.remove('is-visible'));
            container.classList.remove('two-items'); // 2分割クラスも削除

            // 表示すべき状態を決定
            const activeStates = [];
            if (matchStatus === 'waiting') activeStates.push('waiting');
            if (matchStatus === 'ingame') activeStates.push('ingame');
            if (incidentStatus === 'lag') activeStates.push('lag');
            if (incidentStatus === 'trouble') activeStates.push('trouble');

            // 表示処理
            if (activeStates.length === 0) {
                // 対戦外かつインシデントなしの場合のみコンテナを非表示
                container.style.display = 'none';
            } else {
                container.style.display = 'flex'; // コンテナを表示
                if (activeStates.length === 1) {
                    // 状態が1つの場合
                    const tileId = `status-display-${activeStates[0]}`;
                    const tile = getEl(tileId);
                    if (tile) tile.classList.add('is-visible');
                } else if (activeStates.length >= 2) {
                    // 状態が2つ以上の場合 (通常は最大2つのはず)
                    container.classList.add('two-items');
                    // 最初の2つを表示 (例: ingame と lag)
                    const tileId1 = `status-display-${activeStates[0]}`;
                    const tile1 = getEl(tileId1);
                    if (tile1) tile1.classList.add('is-visible');

                    const tileId2 = `status-display-${activeStates[1]}`;
                    const tile2 = getEl(tileId2);
                    if (tile2) tile2.classList.add('is-visible');
                }
            }
        };


        // チーム情報タブの表示を更新 (PC/モバイル切り替え含む)
        const updateTeamDisplay = () => {
            DOMElements.teamAlphaCard.innerHTML = createTeamCardHTML(DOMElements.viewAlphaSelect.value);
            DOMElements.teamBravoCard.innerHTML = createTeamCardHTML(DOMElements.viewBravoSelect.value);
            // モバイル表示の切り替え
            if (window.innerWidth <= 768) {
                DOMElements.teamAlphaCardWrapper.style.display = currentlyDisplayedTeam === 'alpha' ? 'block' : 'none';
                DOMElements.teamBravoCardWrapper.style.display = currentlyDisplayedTeam === 'bravo' ? 'block' : 'none';
            } else {
                DOMElements.teamAlphaCardWrapper.style.display = 'block';
                DOMElements.teamBravoCardWrapper.style.display = 'block';
            }
            checkSyncStatus();
        };

        // 新着コメントモーダルを表示
        const showCommentModal = (text, role = '不明', displayName = '') => {
            const sender = displayName ? `${displayName} (${role})` : role;
            DOMElements.commentModalHeading.textContent = `【${sender}】からのコメント`;
            DOMElements.commentModalText.textContent = text;
            DOMElements.commentModal.classList.add('is-active');
        };

        // ページ初期化 (静的JSON読み込み、UIセットアップ)
        const initializePage = async () => {
            setConnectionStatus('connecting');
            myDisplayName = localStorage.getItem('myDisplayName') || '';
            try {
                // 静的データを読み込み
                const [teamsRes, scriptRes, stagesRes] = await Promise.all([
                    fetch('./teams.json'), fetch('./script.json'), fetch('./stages.json')
                ]);
                if (!teamsRes.ok || !scriptRes.ok || !stagesRes.ok) {
                    throw new Error('Failed to load one or more data files.');
                }
                teamsData = await teamsRes.json();
                scriptData = await scriptRes.json();
                stagesData = await stagesRes.json();
            } catch (e) {
                console.error("Failed to load initial data:", e);
                alert("データファイルの読み込みに失敗しました。ページをリロードしてください。");
                return;
            }
            // チーム選択セレクトボックスに全チームを追加
            document.querySelectorAll('select').forEach(select => {
                teamsData.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id; option.textContent = team.teamName;
                    select.appendChild(option);
                });
            });
            // チームデータの読み込みが完了したら、デフォルト表示を設定
            if (teamsData.length > 0) {
                // matchupが存在しない場合やteam_001がない場合を考慮
                const defaultTeamId = teamsData.find(t => t.id === 'team_001') ? 'team_001' : teamsData[0].id;
                officialMatchup = { alphaTeamId: defaultTeamId, bravoTeamId: defaultTeamId };
                if (!isViewLocked) {
                    DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
                    DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
                }
            }
            // 初期描画
            updateTeamDisplay();
            renderScript();
            renderMatchStatus({});
        };

        // コメントをFirestoreに送信
        const sendComment = () => {
            const text = DOMElements.commentInput.value.trim();
            if (text) {
                const roleToSend = (MY_ROLE === 'システム') ? '実況解説' : MY_ROLE; // 念のため

                db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(sessionDocRef);
                    const currentComments = doc.data().comments || [];
                    const newComment = {
                        id: Math.random().toString(36).substr(2, 9),
                        text, senderId: mySessionId, role: roleToSend,
                        displayName: myDisplayName, timestamp: new Date()
                    };
                    const updatedComments = [...currentComments, newComment].slice(-100);
                    transaction.update(sessionDocRef, { comments: updatedComments });
                });
                DOMElements.commentInput.value = '';
            }
        };
        DOMElements.sendCommentButton.onclick = sendComment;
        DOMElements.commentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendComment(); } });

        // チーム表示セレクトボックス変更時の処理
        const viewChangeHandler = () => {
            isViewLocked = true;
            updateTeamDisplay();
        };
        DOMElements.viewAlphaSelect.onchange = viewChangeHandler;
        DOMElements.viewBravoSelect.onchange = viewChangeHandler;

        // 表示チームを現在の対戦カードに同期
        const syncViewToMatchup = () => {
            isViewLocked = false;
            DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
            DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
            updateTeamDisplay();
        };
        if (DOMElements.syncViewButtonPC) DOMElements.syncViewButtonPC.onclick = syncViewToMatchup;
        if (DOMElements.syncViewButtonMobile) DOMElements.syncViewButtonMobile.onclick = syncViewToMatchup;

        // [モバイル用] 表示するチーム (Alpha/Bravo) を切り替え
        const setDisplayTeam = (team) => {
            currentlyDisplayedTeam = team;
            DOMElements.displayAlphaBtn.classList.toggle('active', team === 'alpha');
            DOMElements.displayBravoBtn.classList.toggle('active', team === 'bravo');
            updateTeamDisplay();
        };
        DOMElements.displayAlphaBtn.onclick = () => setDisplayTeam('alpha');
        DOMElements.displayBravoBtn.onclick = () => setDisplayTeam('bravo');

        let isFirstCommentTabOpen = true;
        // 表示タブを切り替え
        const switchToTab = (tabId) => {
            if (!tabId) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-content-${tabId}`));
            if (tabId === 'comment' && isFirstCommentTabOpen) {
                if (!myDisplayName) { DOMElements.nameModal.classList.add('is-active'); }
                isFirstCommentTabOpen = false;
            }
        };

        // タブ切り替えのロジックをセットアップ
        const setupTabs = () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetTab = button.dataset.tab;
                    location.hash = targetTab;
                    switchToTab(targetTab);
                });
            });
            const initialTabId = location.hash.substring(1) || 'comment';
            const firstTab = document.querySelector('.tab-button')?.dataset.tab;
            switchToTab(document.querySelector(`.tab-button[data-tab="${initialTabId}"]`) ? initialTabId : firstTab);
        };

        // 使用ステージ一覧モーダルを開く
        const openStageViewModal = () => {
            if (!stagesData || stagesData.length === 0) {
                DOMElements.stageViewGrid.innerHTML = '<p>ステージ情報が読み込めていません。</p>';
                DOMElements.stageViewModal.classList.add('is-active');
                return;
            }
            const allStageNames = stagesData; // '未決定' を含まないリストを使用
            const usedStageItems = [];
            const unusedStageItems = [];

            allStageNames.forEach(stageName => {
                const isDisabled = unusedStages.includes(stageName);
                const itemHTML = `
                    <div class="stage-grid-item ${isDisabled ? 'is-disabled' : ''}" data-stage-name="${stageName}">
                        <img src="./stage-image/${encodeURIComponent(stageName)}.png" alt="${stageName}" onerror="this.onerror=null;this.src='./stage-image/未決定.png';">
                    </div>`;
                if (isDisabled) { unusedStageItems.push(itemHTML); }
                else { usedStageItems.push(itemHTML); }
            });

            DOMElements.stageViewGrid.innerHTML = [...usedStageItems, ...unusedStageItems].join('');
            DOMElements.stageViewModal.classList.add('is-active');
        };

        // モーダル共通の閉じる動作をセットアップ
        const setupModals = () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) { modal.classList.remove('is-active'); } });
            });
            // 各モーダルの閉じるボタン
            DOMElements.commentModalClose.onclick = () => DOMElements.commentModal.classList.remove('is-active');
            DOMElements.nameModalClose.onclick = () => DOMElements.nameModal.classList.remove('is-active');
            if (DOMElements.stageViewModalClose) { DOMElements.stageViewModalClose.onclick = () => DOMElements.stageViewModal.classList.remove('is-active'); }
            // 新規モーダルの閉じるボタン
            DOMElements.topicModalClose.onclick = () => DOMElements.topicModal.classList.remove('is-active');
            DOMElements.glossaryModalClose.onclick = () => DOMElements.glossaryModal.classList.remove('is-active');
        };

        // 表示名設定モーダル
        DOMElements.editNameButton.onclick = () => {
            DOMElements.nameInput.value = myDisplayName;
            DOMElements.nameModal.classList.add('is-active');
        };
        DOMElements.saveNameButton.onclick = () => {
            const newName = DOMElements.nameInput.value.trim();
            if (newName) {
                myDisplayName = newName;
                localStorage.setItem('myDisplayName', myDisplayName);
                DOMElements.nameModal.classList.remove('is-active');
            }
        };

        // ウィンドウリサイズ時にチーム表示を再計算
        window.onresize = updateTeamDisplay;

        // DOM読み込み完了後に初期化処理を実行
        document.addEventListener("DOMContentLoaded", () => {
            initializePage();
            setupTabs();
            setupModals();

            if (DOMElements.showStagesModalButton) { DOMElements.showStagesModalButton.onclick = openStageViewModal; }

            // 配信画面セレクターのクリックイベント (操作可能に変更)
            DOMElements.streamViewSelector.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target && target.dataset.view) {
                    sessionDocRef.update({ currentStreamView: target.dataset.view });
                }
            });

            // ▼▼▼ 台本タブボタンのイベントリスナー ▼▼▼
            DOMElements.topicListButton.onclick = () => DOMElements.topicModal.classList.add('is-active');
            DOMElements.glossaryButton.onclick = () => DOMElements.glossaryModal.classList.add('is-active');
            // ▲▲▲ 台本タブボタンのイベントリスナー ▲▲▲
        });
    </script>
</body>

</html>