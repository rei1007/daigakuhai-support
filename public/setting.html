<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学杯 配信サポート (大会設定)</title>
    <link rel="icon" href="icons/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');
    </script>

    <style>
        /* 1. Root Variables & Base Styles */
        :root {
            /* Colors */
            --primary-color: #000000;
            --primary-container-color: #E5E5E5;
            --on-primary-container-color: #000000;
            --surface-container-low-color: #F5F5F5;
            --surface-color: #FFFFFF;
            --on-surface-color: #1C1C1C;
            --on-surface-variant-color: #5A5A5A;
            --outline-color: #E0E0E0;

            /* Typography */
            --font-size-xs: 1.2rem;
            --font-size-sm: 1.4rem;
            --font-size-base: 1.5rem;
            --font-size-md: 1.6rem;
            --font-size-lg: 2.0rem;
            --font-size-xl: 2.4rem;
            --font-size-xxl: 3.2rem;

            /* Spacing */
            --space-xs: 0.4rem;
            --space-sm: 0.8rem;
            --space-md: 1.6rem;
            --space-lg: 2.4rem;
            --space-xl: 4.8rem;

            /* Sizing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;

            /* Font Family */
            --font-family: "M PLUS Rounded 1c", sans-serif;
        }

        /* 基礎スタイル */
        html {
            /* ボックスモデル */
            height: 100%;
            /* タイポグラフィ */
            font-size: 62.5%;
        }

        body {
            /* ボックスモデル */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: var(--space-lg);
            box-sizing: border-box;
            /* タイポグラフィ */
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            color: var(--on-surface-color);
            /* 装飾 */
            background-color: var(--surface-container-low-color);
        }

        /* 2. Page Layout */
        .container {
            /* ボックスモデル */
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
        }

        .header {
            /* ボックスモデル */
            margin-bottom: var(--space-xl);
            /* タイポグラフィ */
            text-align: center;
        }

        .header h1 {
            /* ボックスモデル */
            margin: 0;
            /* タイポグラフィ */
            font-size: var(--font-size-xxl);
            font-weight: 700;
        }

        /* 共通カードスタイル */
        .card {
            /* ボックスモデル */
            padding: var(--space-lg);
            border: 1px solid var(--outline-color);
            /* 装飾 */
            background-color: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        h2 {
            /* ボックスモデル */
            margin-top: 0;
            margin-bottom: var(--space-md);
            /* タイポグラフィ */
            font-size: var(--font-size-lg);
        }

        hr {
            /* ボックスモデル */
            margin: var(--space-lg) 0;
            border: none;
            border-top: 1px solid var(--outline-color);
        }

        /* 3. Form Elements */
        .form-group {
            /* ボックスモデル */
            margin-bottom: var(--space-lg);
        }

        /* 大会名セクションはマージンなしに */
        .form-group.no-margin {
            /* ボックスモデル */
            margin-bottom: 0;
        }

        .form-group label {
            /* ボックスモデル */
            display: block;
            margin-bottom: var(--space-xs);
            /* タイポグラフィ */
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--on-surface-variant-color);
        }

        .form-group input[type="text"] {
            /* ボックスモデル */
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            box-sizing: border-box;
            border: 1px solid var(--outline-color);
            /* タイポグラフィ */
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            /* 装飾 */
            background-color: var(--surface-color);
            border-radius: var(--radius-md);
        }

        .form-group-header {
            /* ボックスモデル */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .form-group-header .header-controls {
            /* ボックスモデル */
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .form-group-header h2 {
            /* ボックスモデル */
            margin-bottom: 0;
        }

        /* 保存ステータス表示 */
        .status-indicator {
            /* タイポグラフィ */
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--on-surface-variant-color);
            /* 装飾 */
            opacity: 0;
            /* その他 */
            transition: opacity 0.3s ease;
        }

        .status-indicator.is-visible {
            /* 装飾 */
            opacity: 1;
        }

        /* 枠線ボタン */
        .outline-button {
            /* ボックスモデル */
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--outline-color);
            /* タイポグラフィ */
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-family: var(--font-family);
            color: var(--primary-color);
            /* 装飾 */
            background: none;
            border-radius: var(--radius-md);
            /* その他 */
            cursor: pointer;
        }

        .outline-button:hover {
            /* 装飾 */
            background-color: #F0F0F0;
        }

        /* 実況解説者情報 */
        .commentator-grid {
            /* ボックスモデル */
            display: grid;
            grid-template-columns: 1fr; /* Mobile first */
            gap: var(--space-md);
        }

        @media (min-width: 600px) {
            .commentator-grid {
                grid-template-columns: 1fr 1fr; /* Desktop 2-col */
            }
        }

        .commentator-group {
            /* ボックスモデル */
            padding: var(--space-md);
            border: 1px solid var(--outline-color);
            /* 装飾 */
            background: var(--surface-container-low-color);
            border-radius: var(--radius-md);
        }

        .commentator-group label {
            /* ボックスモデル */
            margin-bottom: var(--space-sm);
            /* タイポグラフィ */
            font-size: var(--font-size-md); /* Use label as heading */
            font-weight: 700;
            color: var(--on-surface-color);
        }

        .commentator-group input[type="text"] {
            /* ボックスモデル */
            width: 100%;
            margin-bottom: var(--space-sm);
        }

        .commentator-group input[type="text"]:last-child {
            /* ボックスモデル */
            margin-bottom: 0;
        }

        /* 4. Stage Checklist */
        /* 折りたたみボタン */
        .toggle-button {
            /* ボックスモデル */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xs);
            border: none;
            /* 装飾 */
            background-color: var(--primary-container-color);
            border-radius: 50%;
            /* その他 */
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .toggle-button .material-icons-outlined {
            /* タイポグラフィ */
            font-size: var(--font-size-lg);
            font-weight: 700;
        }

        .toggle-button.is-collapsed {
            /* その他 */
            transform: rotate(-90deg);
        }

        .collapsible-content.is-collapsed {
            /* ボックスモデル */
            display: none;
        }

        /* 一括操作ボタン */
        .bulk-action-buttons {
            /* ボックスモデル */
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        /* ステージチェックリスト */
        .stage-checklist {
            /* ボックスモデル */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .stage-check-item {
            /* ボックスモデル */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-md) var(--space-sm);
            border: 1px solid var(--outline-color);
            /* 装飾 */
            background-color: var(--surface-container-low-color);
            border-radius: var(--radius-md);
            /* その他 */
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            user-select: none;
        }

        .stage-check-item:hover {
            /* 装飾 */
            background-color: #EAEAEA;
        }

        .stage-check-item.is-active {
            /* ボックスモデル */
            border-color: var(--primary-color);
            /* タイポグラフィ */
            color: var(--on-primary-container-color);
            /* 装飾 */
            background-color: var(--primary-container-color);
        }

        .stage-check-item.is-active label {
            /* タイポグラフィ */
            font-weight: 700;
        }

        .stage-check-item label {
            /* タイポグラフィ */
            font-size: var(--font-size-sm);
            font-weight: 500;
            /* その他 */
            cursor: pointer;
        }

        /* 5. Navigation */
        .home-button {
            /* ボックスモデル */
            display: block;
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--primary-color);
            box-sizing: border-box;
            /* タイポグラフィ */
            font-size: var(--font-size-base);
            font-weight: 700;
            color: white;
            text-align: center;
            text-decoration: none;
            /* 装飾 */
            background-color: var(--primary-color);
            border-radius: var(--radius-lg);
            /* その他 */
            transition: all 0.2s ease-in-out;
        }

        .home-button:hover {
            /* ボックスモデル */
            border-color: #333333;
            /* 装飾 */
            background-color: #333333;
        }

        /* 6. Utility (HTMLから移動) */
        /* ヘッダーのリンクスタイル */
        .header a {
            color: inherit;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1><a href="index.html">大学杯 配信サポート</a></h1>
        </header>

        <main>
            <div class="card">
                <section class="form-group no-margin">
                    <div class="form-group-header">
                        <h2>大会名</h2>
                        <span id="name-save-status" class="status-indicator"></span>
                    </div>
                    <input type="text" id="tournament-name-input" placeholder="例: 大学杯・真打">
                </section>

                <hr>

                <section class="form-group no-margin">
                    <div class="form-group-header">
                        <h2>実況解説者情報設定</h2>
                        <span id="commentator-save-status" class="status-indicator"></span>
                    </div>
                    <div class="commentator-grid">
                        <div class="commentator-group">
                            <label>実況者</label>
                            <input type="text" id="caster-name-input" placeholder="名前">
                            <input type="text" id="caster-icon-input" placeholder="アイコンURL (https://...)">
                        </div>
                        <div class="commentator-group">
                            <label>解説者</label>
                            <input type="text" id="analyst-name-input" placeholder="名前">
                            <input type="text" id="analyst-icon-input" placeholder="アイコンURL (https://...)">
                        </div>
                    </div>
                </section>
                <hr>

                <section>
                    <div class="form-group-header">
                        <h2>使用ステージ設定</h2>
                        <div class="header-controls">
                            <span id="stage-save-status" class="status-indicator"></span>
                            <button id="stage-toggle-btn" class="toggle-button is-collapsed" title="折りたたむ">
                                <span class="material-icons-outlined">expand_more</span>
                            </button>
                        </div>
                    </div>

                    <div id="stage-settings-content" class="collapsible-content is-collapsed">
                        <div class="bulk-action-buttons">
                            <button id="select-all-stages" class="outline-button">すべて選択</button>
                            <button id="deselect-all-stages" class="outline-button">すべて解除</button>
                        </div>

                        <div id="stage-checklist-container" class="stage-checklist">
                            <p>ステージ情報を読み込み中です...</p>
                        </div>
                    </div>
                </section>

                <hr>

                <a href="index.html" class="home-button">ホームに戻る</a>
            </div>
        </main>
    </div>

    <script>
        const getEl = (id) => document.getElementById(id);

        // DOM要素のキャッシュ
        const DOMElements = {
            nameInput: getEl('tournament-name-input'),
            nameSaveStatus: getEl('name-save-status'),
            casterNameInput: getEl('caster-name-input'),
            casterIconInput: getEl('caster-icon-input'),
            analystNameInput: getEl('analyst-name-input'),
            analystIconInput: getEl('analyst-icon-input'),
            commentatorSaveStatus: getEl('commentator-save-status'),
            stageChecklistContainer: getEl('stage-checklist-container'),
            selectAllButton: getEl('select-all-stages'),
            deselectAllButton: getEl('deselect-all-stages'),
            stageSaveStatus: getEl('stage-save-status'),
            stageToggleBtn: getEl('stage-toggle-btn'),
            stageSettingsContent: getEl('stage-settings-content')
        };

        let allStagesData = []; // stages.jsonから読み込んだ全ステージ名
        let nameSaveTimer = null;
        let stageSaveTimer = null;
        let commentatorSaveTimer = null; // 実況解説者情報用タイマー

        // ページの読み込みと初期化
        const initializeSettingsPage = async () => {
            DOMElements.stageChecklistContainer.innerHTML = '<p>ステージ情報と設定を読み込んでいます...</p>';

            try {
                // 1. stages.json と Firestore のデータを並行して取得
                const [stagesRes, doc] = await Promise.all([
                    fetch('./stages.json'),
                    sessionDocRef.get()
                ]);

                if (!stagesRes.ok) throw new Error('stages.jsonの読み込みに失敗しました。');

                allStagesData = await stagesRes.json();
                const state = doc.data() || {};

                // 2. 大会名フォームに値を設定
                DOMElements.nameInput.value = state.tournamentName || '';

                // 3. 実況解説者情報の読み込み
                DOMElements.casterNameInput.value = state.casterName || '';
                DOMElements.casterIconInput.value = state.casterIconUrl || '';
                DOMElements.analystNameInput.value = state.analystName || '';
                DOMElements.analystIconInput.value = state.analystIconUrl || '';

                // 4. ステージチェックリストを生成
                renderStageChecklist(state.unusedStages || []);

            } catch (error) {
                console.error("初期化エラー:", error);
                DOMElements.stageChecklistContainer.innerHTML = '<p style="color: red;">エラー: データの読み込みに失敗しました。ページを再読み込みしてください。</p>';
            }
        };

        // ステージチェックリストを描画し、イベントリスナーを設定
        const renderStageChecklist = (unusedStages = []) => {
            let checklistHTML = '';
            allStagesData.forEach(stageName => {
                const isUsed = !unusedStages.includes(stageName);
                // `is-active`クラスで使用/不使用を管理
                checklistHTML += `
                    <div class="stage-check-item ${isUsed ? 'is-active' : ''}" 
                         data-stage-name="${stageName}">
                        <label>${stageName}</label>
                    </div>
                `;
            });
            DOMElements.stageChecklistContainer.innerHTML = checklistHTML;
            setupChecklistBehavior();
        };

        // チェックリストのクリック挙動をセットアップ
        const setupChecklistBehavior = () => {
            DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    item.classList.toggle('is-active');
                    saveStageSettings(); // クリック時に自動保存
                });
            });
        };

        // 大会名をFirestoreに保存
        const saveTournamentName = async () => {
            try {
                const tournamentName = DOMElements.nameInput.value;
                await sessionDocRef.update({
                    tournamentName: tournamentName
                });
                showSaveStatus(DOMElements.nameSaveStatus, "保存しました", nameSaveTimer);
            } catch (error) {
                console.error("大会名の保存エラー:", error);
                showSaveStatus(DOMElements.nameSaveStatus, "保存失敗", nameSaveTimer);
            }
        };

        // 実況解説者情報をFirestoreに保存
        const saveCommentatorInfo = async () => {
            try {
                await sessionDocRef.update({
                    casterName: DOMElements.casterNameInput.value,
                    casterIconUrl: DOMElements.casterIconInput.value,
                    analystName: DOMElements.analystNameInput.value,
                    analystIconUrl: DOMElements.analystIconInput.value
                });
                showSaveStatus(DOMElements.commentatorSaveStatus, "保存しました", commentatorSaveTimer);
            } catch (error) {
                console.error("実況解説者情報の保存エラー:", error);
                showSaveStatus(DOMElements.commentatorSaveStatus, "保存失敗", commentatorSaveTimer);
            }
        };

        // ステージ設定 (unusedStages) をFirestoreに保存
        const saveStageSettings = async () => {
            try {
                const unusedStages = [];
                const items = DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item');
                // `is-active` でないもの (チェックが外れているもの) を `unusedStages` リストに追加
                items.forEach(item => {
                    if (!item.classList.contains('is-active')) {
                        unusedStages.push(item.dataset.stageName);
                    }
                });
                await sessionDocRef.update({
                    unusedStages: unusedStages
                });
                showSaveStatus(DOMElements.stageSaveStatus, "保存しました", stageSaveTimer);
            } catch (error) {
                console.error("ステージ設定の保存エラー:", error);
                showSaveStatus(DOMElements.stageSaveStatus, "保存失敗", stageSaveTimer);
            }
        };

        // 保存ステータスを表示 (2秒後に非表示)
        const showSaveStatus = (element, message, timer) => {
            if (timer) clearTimeout(timer);
            element.textContent = message;
            element.classList.add('is-visible');
            timer = setTimeout(() => {
                element.classList.remove('is-visible');
            }, 2000);
        };

        // ステージ一括操作 (すべて選択 / すべて解除)
        const setAllStagesActive = (isActive) => {
            const items = DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item');
            items.forEach(item => {
                item.classList.toggle('is-active', isActive);
            });
            saveStageSettings(); // 操作後に自動保存
        };

        // --- イベントリスナーの設定 ---

        // DOM読み込み完了時に初期化
        document.addEventListener('DOMContentLoaded', initializeSettingsPage);

        // 大会名入力欄 (フォーカスが外れたら保存)
        DOMElements.nameInput.addEventListener('change', saveTournamentName);

        // 実況解説者情報の入力欄 (フォーカスが外れたら保存)
        DOMElements.casterNameInput.addEventListener('change', saveCommentatorInfo);
        DOMElements.casterIconInput.addEventListener('change', saveCommentatorInfo);
        DOMElements.analystNameInput.addEventListener('change', saveCommentatorInfo);
        DOMElements.analystIconInput.addEventListener('change', saveCommentatorInfo);

        // ステージ一括操作ボタン
        DOMElements.selectAllButton.addEventListener('click', () => setAllStagesActive(true));
        DOMElements.deselectAllButton.addEventListener('click', () => setAllStagesActive(false));

        // ステージ設定の折りたたみボタン
        DOMElements.stageToggleBtn.addEventListener('click', () => {
            const isCollapsed = DOMElements.stageSettingsContent.classList.toggle('is-collapsed');
            DOMElements.stageToggleBtn.classList.toggle('is-collapsed', isCollapsed);
            DOMElements.stageToggleBtn.title = isCollapsed ? "展開する" : "折りたたむ";
        });

    </script>
</body>

</html>