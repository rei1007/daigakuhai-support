<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学杯 配信サポート (大会設定)</title>
    <link rel="icon" href="icons/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');
    </script>

    <style>
        /* ==========================================================================
        1. Root Variables & Base Styles
        ========================================================================== */
        :root {
            --primary-color: #000000;
            --primary-container-color: #E5E5E5;
            --on-primary-container-color: #000000;
            --surface-container-low-color: #F5F5F5;
            --surface-color: #FFFFFF;
            --on-surface-color: #1C1C1C;
            --on-surface-variant-color: #5A5A5A;
            --outline-color: #E0E0E0;

            --font-size-xs: 1.2rem;
            --font-size-sm: 1.4rem;
            --font-size-base: 1.5rem;
            --font-size-md: 1.6rem;
            --font-size-lg: 2.0rem;
            --font-size-xl: 2.4rem;
            --font-size-xxl: 3.2rem;

            --space-xs: 0.4rem;
            --space-sm: 0.8rem;
            --space-md: 1.6rem;
            --space-lg: 2.4rem;
            --space-xl: 4.8rem;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;

            /* --font-family: 'Noto Sans JP', sans-serif; */
            --font-family: "M PLUS Rounded 1c", sans-serif;
        }

        html {
            font-size: 62.5%;
            height: 100%;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: var(--space-lg);
            box-sizing: border-box;
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            color: var(--on-surface-color);
            background-color: var(--surface-container-low-color);
        }

        /* ==========================================================================
        2. Page Layout
        ========================================================================== */
        .container {
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: var(--space-xl);
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: var(--font-size-xxl);
            font-weight: 700;
        }

        .card {
            padding: var(--space-lg);
            background-color: var(--surface-color);
            border: 1px solid var(--outline-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        h2 {
            font-size: var(--font-size-lg);
            margin-top: 0;
            margin-bottom: var(--space-md);
        }

        hr {
            margin: var(--space-lg) 0;
            border: none;
            border-top: 1px solid var(--outline-color);
        }

        /* ==========================================================================
        3. Form Elements
        ========================================================================== */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-xs);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--on-surface-variant-color);
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            box-sizing: border-box;
            background-color: var(--surface-color);
            border: 1px solid var(--outline-color);
            border-radius: var(--radius-md);
        }

        .form-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .form-group-header h2 {
            margin-bottom: 0;
        }

        .status-indicator {
            font-size: var(--font-size-sm);
            color: var(--on-surface-variant-color);
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .status-indicator.is-visible {
            opacity: 1;
        }

        .outline-button {
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-family: var(--font-family);
            color: var(--primary-color);
            background: none;
            border: 1px solid var(--outline-color);
            border-radius: var(--radius-md);
            cursor: pointer;
        }

        .outline-button:hover {
            background-color: #F0F0F0;
        }

        /* ==========================================================================
        4. Stage Checklist
        ========================================================================== */

        .bulk-action-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .stage-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .stage-check-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-md) var(--space-sm);
            background-color: var(--surface-container-low-color);
            border: 1px solid var(--outline-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            user-select: none;
        }

        .stage-check-item:hover {
            background-color: #EAEAEA;
        }

        .stage-check-item.is-active {
            background-color: var(--primary-container-color);
            border-color: var(--primary-color);
            color: var(--on-primary-container-color);
        }

        .stage-check-item.is-active label {
            font-weight: 700;
        }

        .stage-check-item label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
        }

        /* ==========================================================================
        5. Navigation
        ========================================================================== */
        .home-button {
            display: block;
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            font-size: var(--font-size-base);
            font-weight: 700;
            color: white;
            /* === 修正: 白文字 === */
            background-color: var(--primary-color);
            /* === 修正: 濃い色 === */
            border: 1px solid var(--primary-color);
            /* === 修正: 濃い色 === */
            border-radius: var(--radius-lg);
            text-align: center;
            text-decoration: none;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }

        .home-button:hover {
            background-color: #333333;
            /* === 修正: ホバー色 === */
            border-color: #333333;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1><a href="index.html" style="color: inherit; text-decoration: none;">大学杯 配信サポート</a></h1>
        </header>

        <main>
            <div class="card">
                <section class="form-group">
                    <div class="form-group-header">
                        <h2>大会名</h2>
                        <span id="name-save-status" class="status-indicator"></span>
                    </div>
                    <input type="text" id="tournament-name-input" placeholder="例: 大学杯・真打">
                </section>

                <hr>

                <section>
                    <div class="form-group-header">
                        <h2>使用ステージ設定</h2>
                        <span id="stage-save-status" class="status-indicator"></span>
                    </div>

                    <div class="bulk-action-buttons">
                        <button id="select-all-stages" class="outline-button">すべて選択</button>
                        <button id="deselect-all-stages" class="outline-button">すべて解除</button>
                    </div>

                    <div id="stage-checklist-container" class="stage-checklist">
                        <p>ステージ情報を読み込み中です...</p>
                    </div>
                </section>

                <hr>

                <a href="index.html" class="home-button">ホームに戻る</a>
            </div>
        </main>
    </div>

    <script>
        const getEl = (id) => document.getElementById(id);

        const DOMElements = {
            nameInput: getEl('tournament-name-input'),
            stageChecklistContainer: getEl('stage-checklist-container'),
            selectAllButton: getEl('select-all-stages'),
            deselectAllButton: getEl('deselect-all-stages'),
            nameSaveStatus: getEl('name-save-status'),
            stageSaveStatus: getEl('stage-save-status')
        };

        let allStagesData = []; // stages.jsonから読み込んだ全ステージ名
        let nameSaveTimer = null; // 大会名保存ステータス用タイマー
        let stageSaveTimer = null; // ステージ保存ステータス用タイマー

        /**
         * ページの読み込みと初期化
         */
        const initializeSettingsPage = async () => {
            DOMElements.stageChecklistContainer.innerHTML = '<p>ステージ情報と設定を読み込んでいます...</p>';

            try {
                // 1. stages.json と Firestore のデータを並行して取得
                const [stagesRes, doc] = await Promise.all([
                    fetch('./stages.json'),
                    sessionDocRef.get()
                ]);

                if (!stagesRes.ok) throw new Error('stages.jsonの読み込みに失敗しました。');

                allStagesData = await stagesRes.json();
                const state = doc.data() || {};
                const currentName = state.tournamentName || '';
                const unusedStages = state.unusedStages || []; // 使用しないステージの配列

                // 2. 大会名フォームに値を設定
                DOMElements.nameInput.value = currentName;

                // 3. ステージチェックリストを生成
                renderStageChecklist(unusedStages);

            } catch (error) {
                console.error("初期化エラー:", error);
                DOMElements.stageChecklistContainer.innerHTML = '<p style="color: red;">エラー: データの読み込みに失敗しました。ページを再読み込みしてください。</p>';
            }
        };

        /**
         * ステージチェックリストを描画し、イベントリスナーを設定
         * (=== 修正: チェックボックスを削除し、is-active クラスを適用 ===)
         */
        const renderStageChecklist = (unusedStages = []) => {
            let checklistHTML = '';
            allStagesData.forEach(stageName => {
                // unusedStagesに含まれて *いない* -> 使用する (is-active)
                const isUsed = !unusedStages.includes(stageName);

                checklistHTML += `
                    <div class="stage-check-item ${isUsed ? 'is-active' : ''}" 
                         data-stage-name="${stageName}">
                        <label>${stageName}</label>
                    </div>
                `;
            });
            DOMElements.stageChecklistContainer.innerHTML = checklistHTML;

            // クリックイベントリスナーを設定
            setupChecklistBehavior();
        };

        /**
         * チェックリストの挙動をセットアップ
         * (=== 修正: アイテムクリックでトグルと保存 ===)
         */
        const setupChecklistBehavior = () => {
            DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item').forEach(item => {

                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    // 1. クラスをトグル
                    item.classList.toggle('is-active');
                    // 2. 自動保存
                    saveStageSettings();
                });
            });
        };

        /**
         * 大会名をFirestoreに保存
         */
        const saveTournamentName = async () => {
            try {
                const tournamentName = DOMElements.nameInput.value;
                await sessionDocRef.update({
                    tournamentName: tournamentName
                });
                showSaveStatus(DOMElements.nameSaveStatus, "保存しました", nameSaveTimer);
            } catch (error) {
                console.error("大会名の保存エラー:", error);
                showSaveStatus(DOMElements.nameSaveStatus, "保存失敗", nameSaveTimer);
            }
        };

        /**
         * ステージ設定をFirestoreに保存
         * (=== 修正: .is-active クラスを見て 'unusedStages' を構築 ===)
         */
        const saveStageSettings = async () => {
            try {
                // 「使用しないステージ」の配列を構築
                const unusedStages = [];
                const items = DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item');

                items.forEach(item => {
                    // 'is-active' クラスを *持っていない* ものが「使用しない」ステージ
                    if (!item.classList.contains('is-active')) {
                        unusedStages.push(item.dataset.stageName);
                    }
                });

                // Firestoreに更新をかける
                await sessionDocRef.update({
                    unusedStages: unusedStages
                });
                showSaveStatus(DOMElements.stageSaveStatus, "保存しました", stageSaveTimer);
            } catch (error) {
                console.error("ステージ設定の保存エラー:", error);
                showSaveStatus(DOMElements.stageSaveStatus, "保存失敗", stageSaveTimer);
            }
        };

        /**
         * 保存ステータスを表示 (3秒後に非表示)
         */
        const showSaveStatus = (element, message, timer) => {
            if (timer) clearTimeout(timer);
            element.textContent = message;
            element.classList.add('is-visible');
            timer = setTimeout(() => {
                element.classList.remove('is-visible');
            }, 2000);
        };

        /**
         * ステージ一括操作
         * (=== 修正: setAllCheckboxes を setAllStagesActive にリネーム ===)
         */
        const setAllStagesActive = (isActive) => {
            const items = DOMElements.stageChecklistContainer.querySelectorAll('.stage-check-item');
            items.forEach(item => {
                // classList.toggle(className, force) を使って状態を強制
                item.classList.toggle('is-active', isActive);
            });
            // 変更が終わってから一度だけ保存処理を呼ぶ
            saveStageSettings();
        };

        // --- イベントリスナーの設定 ---

        // DOM読み込み完了時に初期化
        document.addEventListener('DOMContentLoaded', initializeSettingsPage);

        // 大会名入力欄 (フォーカスが外れたら保存)
        DOMElements.nameInput.addEventListener('change', saveTournamentName);

        // ステージ一括操作ボタン (=== 修正: 呼び出す関数名を変更 ===)
        DOMElements.selectAllButton.addEventListener('click', () => setAllStagesActive(true));
        DOMElements.deselectAllButton.addEventListener('click', () => setAllStagesActive(false));

    </script>
</body>

</html>