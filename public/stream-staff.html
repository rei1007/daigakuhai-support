<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学杯 配信サポート (配信担当ページ)</title>
    <link rel="icon" href="icons/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>

<body>
    <header class="header">
        <h1><a href="index.html">大学杯 配信サポート (配信担当)</a></h1>
        <div class="connection-indicator" id="connection-indicator">
            <div class="status-dot"></div><span class="connection-text">接続: <span
                    id="connection-status">接続中...</span></span>
        </div>
    </header>
    <main>
        <div id="tab-content-comment" class="tab-content">
            <div class="comment-history" id="comment-history"></div>
            <div class="tab-action-bar">
                <div class="comment-input-group">
                    <button id="edit-name-button" class="icon-button" title="表示名を設定"><span
                            class="material-icons-outlined">settings</span></button>
                    <input type="text" id="comment-input" placeholder="コメントを入力">
                    <button id="send-comment-button"><span class="material-icons-outlined">send</span><span
                            class="send-text">送信</span></button>
                </div>
            </div>
        </div>

        <div id="tab-content-script" class="tab-content">
            <div class="tab-main-content">
                <section class="script-card">
                    <h2>台本</h2>
                    <div id="script-card-content" class="script-full-list"></div>
                </section>
            </div>
            <div class="tab-action-bar script-action-bar">
                <button id="prev-script-button" title="前の段落へ"><span
                        class="material-icons-outlined">skip_previous</span></button>
                <button id="next-script-button" title="次の段落へ"><span
                        class="material-icons-outlined">skip_next</span></button>
            </div>
        </div>

        <div id="tab-content-match-settings" class="tab-content">
            <div class="tab-main-content">

                <section id="stream-view-section">
                    <h2>配信画面</h2>
                    <div class="stream-view-selector" id="stream-view-selector">
                        <button id="stream-view-matchInfo" data-view="matchInfo">
                            <span class="material-icons-outlined">scoreboard</span>
                            対戦情報
                        </button>
                        <button id="stream-view-stageList" data-view="stageList">
                            <span class="material-icons-outlined">map</span>
                            ステージ一覧
                        </button>
                        <button id="stream-view-replay" data-view="replay">
                            <span class="material-icons-outlined">replay</span>
                            リプレイ映像
                        </button>
                    </div>
                </section>
                <section class="card" id="match-settings-card">
                    <h2>対戦設定</h2>
                    <div class="form-group"><label for="round-info-input">ラウンド情報</label><input type="text"
                            id="round-info-input" placeholder="例: 決勝トーナメント 第1試合"></div>
                    <div class="form-group"><label>試合形式</label>
                        <div class="bo-selector"><button id="bo3-btn">BO3</button><button id="bo5-btn">BO5</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="label-with-button">
                            <label>ステージ & 勝敗</label>
                            <button id="reset-stages-button" class="outline-button small-button">リセット</button>
                        </div>
                        <div class="stage-winner-rows" id="stage-winner-rows"></div>
                    </div>
                </section>
            </div>
            <div class="tab-action-bar">
                <h2>対戦チーム設定</h2>
                <div class="team-selector"><select id="matchup-alpha-select"></select><span
                        class="vs-text">VS</span><select id="matchup-bravo-select"></select></div>
            </div>
        </div>

        <div id="tab-content-team-display" class="tab-content">
            <div class="tab-main-content">
                <div class="content-wrapper">
                    <div class="team-display-area">
                        <div id="team-alpha-card-wrapper" class="team-card-wrapper active">
                            <div id="team-alpha-card" class="team-card"></div>
                        </div>
                        <div id="team-bravo-card-wrapper" class="team-card-wrapper">
                            <div id="team-bravo-card" class="team-card"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-action-bar">
                <div class="control-group">
                    <h2>表示チーム切り替え</h2>
                    <div class="local-view-group">
                        <div class="team-selector"><select id="view-alpha-select"></select><span
                                class="vs-text">VS</span><select id="view-bravo-select"></select></div>
                        <div class="sync-button-pc pc-only"><button id="sync-view-button-pc" class="sync-button"
                                title="表示チームを対戦チームに同期"><span
                                    class="material-icons-outlined">arrow_downward</span></button>
                        </div>
                    </div>
                </div>
                <div class="mobile-action-group mobile-only">
                    <div class="segmented-control"><button id="display-alpha-btn" class="active">アルファ</button><button
                            id="display-bravo-btn">ブラボー</button></div>
                    <button id="sync-view-button-mobile" class="sync-button" title="表示チームを対戦チームに同期"><span
                            class="material-icons-outlined">arrow_downward</span></button>
                </div>
            </div>
        </div>
    </main>

    <div id="comment-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="comment-modal-close"><span
                    class="material-icons-outlined">close</span></button>
            <h2 id="comment-modal-heading">新着コメント</h2>
            <p id="comment-modal-text"></p>
        </div>
    </div>
    <div id="stage-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="stage-modal-close"><span
                    class="material-icons-outlined">close</span></button>
            <h2>ステージを選択</h2>
            <div class="stage-grid" id="stage-grid"></div>
        </div>
    </div>
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="name-modal-close"><span
                    class="material-icons-outlined">close</span></button>
            <h2>表示名を設定</h2>
            <div class="form-group">
                <label for="name-input">チャットで表示される名前を入力してください。</label>
                <input type="text" id="name-input" placeholder="例: 配信担当A">
            </div>
            <button id="save-name-button" class="primary-button">保存</button>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-bar-inner">
            <button class="tab-button" data-tab="comment">
                <span class="material-icons-outlined">chat</span>
                <span class="tab-label">コメント</span>
            </button>
            <button class="tab-button" data-tab="script">
                <span class="material-icons-outlined">description</span>
                <span class="tab-label">台本</span>
            </button>

            <button class="tab-button" data-tab="match-settings">
                <span class="material-icons-outlined">tune</span>
                <span class="tab-label">配信・対戦設定</span> </button>
            <button class="tab-button" data-tab="team-display">
                <span class="material-icons-outlined">people</span>
                <span class="tab-label">チーム情報</span>
            </button>
        </div>
    </nav>

    <script>
        const MY_ROLE = '配信担当';
        let teamsData = [], scriptData = [], stagesData = [];
        let myDisplayName = '';

        let unusedStages = []; // 使用しないステージのグローバルリスト

        let mySessionId = localStorage.getItem('mySessionId');
        if (!mySessionId || !mySessionId.startsWith('stream-')) {
            mySessionId = `stream-${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem('mySessionId', mySessionId);
        }

        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');
        let currentlyDisplayedTeam = 'alpha';
        const pageLoadTime = Date.now();
        let officialMatchup = { alphaTeamId: null, bravoTeamId: null };
        let isViewLocked = false;

        const getEl = (id) => document.getElementById(id);
        const DOMElements = {
            connectionIndicator: getEl('connection-indicator'), connectionStatus: getEl('connection-status'),
            commentInput: getEl('comment-input'), sendCommentButton: getEl('send-comment-button'), commentHistory: getEl('comment-history'),
            scriptCardContent: getEl('script-card-content'), nextScriptButton: getEl('next-script-button'), prevScriptButton: getEl('prev-script-button'),
            commentModal: getEl('comment-modal'), commentModalHeading: getEl('comment-modal-heading'), commentModalText: getEl('comment-modal-text'), commentModalClose: getEl('comment-modal-close'),
            stageModal: getEl('stage-modal'), stageModalClose: getEl('stage-modal-close'), stageGrid: getEl('stage-grid'),
            nameModal: getEl('name-modal'), nameModalClose: getEl('name-modal-close'), nameInput: getEl('name-input'), saveNameButton: getEl('save-name-button'), editNameButton: getEl('edit-name-button'),
            matchupAlphaSelect: getEl('matchup-alpha-select'), matchupBravoSelect: getEl('matchup-bravo-select'),
            viewAlphaSelect: getEl('view-alpha-select'), viewBravoSelect: getEl('view-bravo-select'),
            syncViewButtonPC: getEl('sync-view-button-pc'), syncViewButtonMobile: getEl('sync-view-button-mobile'),
            teamAlphaCard: getEl('team-alpha-card'), teamBravoCard: getEl('team-bravo-card'), teamAlphaCardWrapper: getEl('team-alpha-card-wrapper'), teamBravoCardWrapper: getEl('team-bravo-card-wrapper'),
            displayAlphaBtn: getEl('display-alpha-btn'), displayBravoBtn: getEl('display-bravo-btn'),
            roundInfoInput: getEl('round-info-input'), bo3Btn: getEl('bo3-btn'), bo5Btn: getEl('bo5-btn'), stageWinnerRows: getEl('stage-winner-rows'),
            resetStagesButton: getEl('reset-stages-button'),

            // === ▼▼▼ 新規追加 ▼▼▼ ===
            streamViewSelector: getEl('stream-view-selector'),
            streamViewMatchInfo: getEl('stream-view-matchInfo'),
            streamViewStageList: getEl('stream-view-stageList'),
            streamViewReplay: getEl('stream-view-replay'),
            // === ▲▲▲ 新規追加 ▲▲▲ ===
        };

        const setConnectionStatus = (status) => {
            DOMElements.connectionIndicator.classList.remove('is-connected', 'is-connecting', 'is-disconnected');
            DOMElements.connectionIndicator.classList.add(`is-${status}`);
            const statusText = { connecting: '接続中...', connected: '正常', disconnected: '切断' };
            DOMElements.connectionStatus.textContent = statusText[status];
        };

        const checkSyncStatus = () => {
            if (!officialMatchup.alphaTeamId) return;
            const isDesynced = DOMElements.viewAlphaSelect.value !== officialMatchup.alphaTeamId ||
                DOMElements.viewBravoSelect.value !== officialMatchup.bravoTeamId;
            if (DOMElements.syncViewButtonPC) DOMElements.syncViewButtonPC.classList.toggle('is-desynced', isDesynced);
            if (DOMElements.syncViewButtonMobile) DOMElements.syncViewButtonMobile.classList.toggle('is-desynced', isDesynced);
        };

        sessionDocRef.onSnapshot((doc) => {
            if (!doc.exists) { setConnectionStatus('disconnected'); return; }
            const state = doc.data();
            setConnectionStatus('connected');

            unusedStages = state.unusedStages || [];

            if (state.matchup && state.matchup.alphaTeamId) {
                officialMatchup = state.matchup;
                DOMElements.matchupAlphaSelect.value = state.matchup.alphaTeamId;
                DOMElements.matchupBravoSelect.value = state.matchup.bravoTeamId;

                if (!isViewLocked) {
                    DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
                    DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
                    updateTeamDisplay();
                } else {
                    checkSyncStatus();
                }
            }
            renderScript(state.scriptIndex || 0);
            renderComments(state.comments || []);
            renderMatchSettings(state);

            // === ▼▼▼ 新規追加 ▼▼▼ ===
            renderStreamViewSelector(state.currentStreamView);
            // === ▲▲▲ 新規追加 ▲▲▲ ===

            const lastComment = (state.comments || []).slice(-1)[0];
            const isCommentTabActive = document.querySelector('.tab-button[data-tab="comment"]')?.classList.contains('active');
            if (lastComment && lastComment.senderId !== mySessionId && !isCommentTabActive) {
                const lastShownTime = DOMElements.commentModal.dataset.lastShownTime || 0;
                if (lastComment.timestamp && lastComment.timestamp.toMillis() > pageLoadTime && lastComment.timestamp.toMillis() > lastShownTime) {
                    showCommentModal(lastComment.text, lastComment.role, lastComment.displayName);
                    DOMElements.commentModal.dataset.lastShownTime = lastComment.timestamp.toMillis();
                }
            }
        }, (error) => { setConnectionStatus('disconnected'); });

        const renderComments = (comments = []) => {
            DOMElements.commentHistory.innerHTML = comments.map(c => {
                const isMe = c.senderId === mySessionId;
                let badgeClass = 'is-other'; let badgeText = c.role;
                if (isMe) { badgeClass = 'is-me'; badgeText = 'Me'; }
                else if (c.role === '運営') { badgeClass = 'is-operator'; }
                else if (c.role === '実況解説') { badgeClass = 'is-commentator'; }
                else if (c.role === '配信担当') { badgeClass = 'is-stream-staff'; }
                const displayNameHTML = c.displayName ? `<span class="display-name">${c.displayName}</span>` : '';
                return `<div class="comment-item-wrapper ${isMe ? 'is-me' : ''}">
                           <div class="comment-item" id="comment-${c.id}">
                             <div class="comment-header">${displayNameHTML}<span class="badge ${badgeClass}">${badgeText}</span></div>
                             <span class="text">${c.text}</span>
                           </div>
                         </div>`;
            }).join('');
            DOMElements.commentHistory.scrollTop = DOMElements.commentHistory.scrollHeight;
        };

        const renderScript = (currentIndex = 0) => {
            if (!scriptData || scriptData.length === 0) return;
            DOMElements.scriptCardContent.innerHTML = scriptData.map((p, i) => {
                let statusClass = '';
                if (i < currentIndex) statusClass = 'is-done';
                if (i === currentIndex) statusClass = 'is-current';
                return `<div class="script-paragraph ${statusClass}" data-index="${i}" id="script-item-${i}"><b>${p.speaker}:</b> ${p.line}</div>`
            }).join('');
            const currentEl = getEl(`script-item-${currentIndex}`);
            if (currentEl) currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        const createTeamCardHTML = (teamId) => {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return '<h3>チーム情報を読み込み中...</h3>';
            const players = [
                { name: team.p1_name, xp: team.p1_xp, weapon: team.p1_weapon },
                { name: team.p2_name, xp: team.p2_xp, weapon: team.p2_weapon },
                { name: team.p3_name, xp: team.p3_xp, weapon: team.p3_weapon },
                { name: team.p4_name, xp: team.p4_xp, weapon: team.p4_weapon }
            ];
            const playerListHTML = players.filter(p => p.name).map(p =>
                `<div class="player-tile">
                    <div class="player-tile-top">
                        <span class="player-name">${p.name}</span>
                        <span class="xp-badge ${p.xp >= 3200 ? 'is-highlight' : ''}">XP: ${p.xp}</span>
                    </div>
                    <div class="player-tile-bottom">${(p.weapon || '').replace(/\//g, ' / ')}</div>
                </div>`
            ).join('');
            return `<div class="team-card-header">
                        <p class="university-name">${team.university} / ${team.circle}</p>
                        <h2 class="team-name">${team.teamName}</h2>
                    </div>
                    <h3>プレイヤー情報</h3>
                    <div class="player-tiles-container">${playerListHTML}</div>
                    <div class="info-tile"><h3>チームコメント</h3><p>${team.comment}</p></div>
                    <div class="info-tile"><h3>戦略</h3><p>${team.tactics}</p></div>
                    <div class="info-tile"><h3>実績</h3><p>${team.records}</p></div>
                    <div class="info-tile"><h3>サークルからのメッセージ</h3><p>${team.message}</p></div>`;
        };

        const showCommentModal = (text, role = '不明', displayName = '') => {
            const sender = displayName ? `${displayName} (${role})` : role;
            DOMElements.commentModalHeading.textContent = `【${sender}】からのコメント`;
            DOMElements.commentModalText.textContent = text;
            DOMElements.commentModal.classList.add('is-active');
        };

        const updateTeamDisplay = () => {
            DOMElements.teamAlphaCard.innerHTML = createTeamCardHTML(DOMElements.viewAlphaSelect.value);
            DOMElements.teamBravoCard.innerHTML = createTeamCardHTML(DOMElements.viewBravoSelect.value);
            if (window.innerWidth <= 768) {
                DOMElements.teamAlphaCardWrapper.style.display = currentlyDisplayedTeam === 'alpha' ? 'block' : 'none';
                DOMElements.teamBravoCardWrapper.style.display = currentlyDisplayedTeam === 'bravo' ? 'block' : 'none';
            } else {
                DOMElements.teamAlphaCardWrapper.style.display = 'block';
                DOMElements.teamBravoCardWrapper.style.display = 'block';
            }
            checkSyncStatus();
        };

        const renderMatchSettings = (state) => {
            if (document.activeElement !== DOMElements.roundInfoInput) { DOMElements.roundInfoInput.value = state.roundInfo || ''; }
            const bestOf = state.bestOf || 'BO3';
            DOMElements.bo3Btn.classList.toggle('active', bestOf === 'BO3');
            DOMElements.bo5Btn.classList.toggle('active', bestOf === 'BO5');
            const numStages = bestOf === 'BO5' ? 5 : 3;
            const stages = state.stages || [];
            DOMElements.stageWinnerRows.innerHTML = '';
            for (let i = 0; i < numStages; i++) {
                const stageData = stages[i] || { stage: '未決定', winner: null };
                const stageName = stageData.stage || '未決定';
                const row = document.createElement('div');
                row.className = 'stage-winner-row';
                row.innerHTML = `
                    <span>${i + 1}.</span>
                    <button class="stage-select-button" data-index="${i}">
                        <img src="./stage-image/${encodeURIComponent(stageName)}.png" alt="${stageName}" onerror="this.onerror=null;this.src='./stage-image/未決定.png';">
                        <span class="stage-name">${stageName}</span>
                    </button>
                    <div class="winner-selector" data-index="${i}">
                        <button class="alpha ${stageData.winner === 'alpha' ? 'active' : ''}" data-winner="alpha">A</button>
                        <button class="bravo ${stageData.winner === 'bravo' ? 'active' : ''}" data-winner="bravo">B</button>
                    </div>`;
                DOMElements.stageWinnerRows.appendChild(row);
            }
        };

        // === ▼▼▼ 新規追加 ▼▼▼ ===
        /**
         * 配信画面セレクターの表示を更新
         */
        const renderStreamViewSelector = (currentView) => {
            const view = currentView || 'matchInfo'; // デフォルトは 'matchInfo'
            DOMElements.streamViewMatchInfo.classList.toggle('active', view === 'matchInfo');
            DOMElements.streamViewStageList.classList.toggle('active', view === 'stageList');
            DOMElements.streamViewReplay.classList.toggle('active', view === 'replay');
        };
        // === ▲▲▲ 新規追加 ▲▲▲ ===

        const initializePage = async () => {
            setConnectionStatus('connecting');
            myDisplayName = localStorage.getItem('myDisplayName') || '';

            try {
                const [teamsRes, scriptRes, stagesRes] = await Promise.all([fetch('./teams.json'), fetch('./script.json'), fetch('./stages.json')]);
                teamsData = await teamsRes.json();
                scriptData = await scriptRes.json();
                stagesData = await stagesRes.json();
            } catch (e) { return alert("データファイルの読み込みに失敗しました。"); }

            document.querySelectorAll('select').forEach(select => {
                teamsData.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id; option.textContent = team.teamName;
                    select.appendChild(option);
                });
            });

            if (teamsData.length > 0) {
                officialMatchup.alphaTeamId = teamsData[0].id;
                officialMatchup.bravoTeamId = teamsData[0].id;
                if (!isViewLocked) {
                    DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
                    DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
                }
            }
            updateTeamDisplay();
            renderScript();
            renderMatchSettings({});
        };

        const matchupChangeHandler = () => {
            sessionDocRef.update({ matchup: { alphaTeamId: DOMElements.matchupAlphaSelect.value, bravoTeamId: DOMElements.matchupBravoSelect.value } });
        };
        DOMElements.matchupAlphaSelect.onchange = matchupChangeHandler;
        DOMElements.matchupBravoSelect.onchange = matchupChangeHandler;

        const viewChangeHandler = () => {
            isViewLocked = true;
            updateTeamDisplay();
        };
        DOMElements.viewAlphaSelect.onchange = viewChangeHandler;
        DOMElements.viewBravoSelect.onchange = viewChangeHandler;

        const syncViewToMatchup = () => {
            isViewLocked = false;
            DOMElements.viewAlphaSelect.value = officialMatchup.alphaTeamId;
            DOMElements.viewBravoSelect.value = officialMatchup.bravoTeamId;
            updateTeamDisplay();
        };
        if (DOMElements.syncViewButtonPC) DOMElements.syncViewButtonPC.onclick = syncViewToMatchup;
        if (DOMElements.syncViewButtonMobile) DOMElements.syncViewButtonMobile.onclick = syncViewToMatchup;

        const updateScriptIndex = (newIndex) => { if (newIndex >= 0 && newIndex < scriptData.length) { sessionDocRef.update({ scriptIndex: newIndex }); } };
        DOMElements.nextScriptButton.onclick = async () => { const doc = await sessionDocRef.get(); updateScriptIndex((doc.data().scriptIndex || 0) + 1); };
        DOMElements.prevScriptButton.onclick = async () => { const doc = await sessionDocRef.get(); updateScriptIndex((doc.data().scriptIndex || 0) - 1); };
        DOMElements.scriptCardContent.addEventListener('click', (e) => {
            const target = e.target.closest('.script-paragraph');
            if (target && target.dataset.index) {
                const newIndex = parseInt(target.dataset.index, 10);
                updateScriptIndex(newIndex);
            }
        });

        const sendComment = () => {
            const text = DOMElements.commentInput.value.trim();
            if (text) {
                db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(sessionDocRef);
                    const currentComments = doc.data().comments || [];
                    const newComment = { id: Math.random().toString(36).substr(2, 9), text, senderId: mySessionId, role: MY_ROLE, displayName: myDisplayName, timestamp: new Date() };
                    const updatedComments = [...currentComments, newComment].slice(-100);
                    transaction.update(sessionDocRef, { comments: updatedComments });
                });
                DOMElements.commentInput.value = '';
            }
        };
        DOMElements.sendCommentButton.onclick = sendComment;
        DOMElements.commentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendComment(); } });

        const updateMatchSettings = async () => {
            const doc = await sessionDocRef.get();
            const currentSettings = doc.data();
            const newStages = Array.from(DOMElements.stageWinnerRows.querySelectorAll('.stage-winner-row')).map((row, i) => {
                const winnerBtn = row.querySelector('.winner-selector button.active');
                return {
                    stage: currentSettings.stages?.[i]?.stage || '未決定',
                    winner: winnerBtn ? winnerBtn.dataset.winner : null
                };
            });
            sessionDocRef.update({
                roundInfo: DOMElements.roundInfoInput.value,
                stages: newStages
            });
        };

        const openStageModal = (index) => {
            const allStageNames = ['未決定', ...stagesData];
            const usedStageItems = [];
            const unusedStageItems = [];
            allStageNames.forEach(stageName => {
                const isDisabled = unusedStages.includes(stageName);
                const itemHTML = `
                    <div class="stage-grid-item ${isDisabled ? 'is-disabled' : ''}" data-stage-name="${stageName}">
                        <img src="./stage-image/${encodeURIComponent(stageName)}.png" alt="${stageName}" onerror="this.onerror=null;this.src='./stage-image/未決定.png';">
                    </div>`;
                if (isDisabled) { unusedStageItems.push(itemHTML); }
                else { usedStageItems.push(itemHTML); }
            });
            DOMElements.stageGrid.innerHTML = [...usedStageItems, ...unusedStageItems].join('');
            DOMElements.stageModal.dataset.editIndex = index;
            DOMElements.stageModal.classList.add('is-active');
        };

        DOMElements.roundInfoInput.onchange = () => sessionDocRef.update({ roundInfo: DOMElements.roundInfoInput.value });
        DOMElements.bo3Btn.onclick = () => sessionDocRef.update({ bestOf: 'BO3', stages: [] });
        DOMElements.bo5Btn.onclick = () => sessionDocRef.update({ bestOf: 'BO5', stages: [] });
        DOMElements.resetStagesButton.onclick = () => {
            if (confirm('ステージと勝敗の情報をすべてリセットしますか？')) {
                sessionDocRef.update({ stages: [] });
            }
        };

        DOMElements.stageWinnerRows.addEventListener('click', (e) => {
            const target = e.target;
            if (target.closest('.stage-select-button')) {
                openStageModal(target.closest('.stage-select-button').dataset.index);
            }
            if (target.tagName === 'BUTTON' && target.closest('.winner-selector')) {
                const parent = target.parentElement;
                const currentlyActive = parent.querySelector('.active');
                if (currentlyActive === target) { target.classList.remove('active'); }
                else { if (currentlyActive) currentlyActive.classList.remove('active'); target.classList.add('active'); }
                updateMatchSettings();
            }
        });

        DOMElements.stageGrid.addEventListener('click', async (e) => {
            const target = e.target.closest('.stage-grid-item');
            if (!target || target.classList.contains('is-disabled')) return;
            const newStageName = target.dataset.stageName;
            const indexToEdit = DOMElements.stageModal.dataset.editIndex;
            const doc = await sessionDocRef.get();
            const currentSettings = doc.data();
            const newStages = currentSettings.stages ? [...currentSettings.stages] : [];
            while (newStages.length <= indexToEdit) {
                newStages.push({ stage: '未決定', winner: null });
            }
            newStages[indexToEdit].stage = newStageName;
            await sessionDocRef.update({ stages: newStages });
            DOMElements.stageModal.classList.remove('is-active');
        });

        const setDisplayTeam = (team) => {
            currentlyDisplayedTeam = team;
            DOMElements.displayAlphaBtn.classList.toggle('active', team === 'alpha');
            DOMElements.displayBravoBtn.classList.toggle('active', team === 'bravo');
            updateTeamDisplay();
        };
        DOMElements.displayAlphaBtn.onclick = () => setDisplayTeam('alpha');
        DOMElements.displayBravoBtn.onclick = () => setDisplayTeam('bravo');

        let isFirstCommentTabOpen = true;
        const switchToTab = (tabId) => {
            if (!tabId) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-content-${tabId}`));
            if (tabId === 'comment' && isFirstCommentTabOpen) {
                if (!myDisplayName) {
                    DOMElements.nameModal.classList.add('is-active');
                }
                isFirstCommentTabOpen = false;
            }
        };

        const setupTabs = () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetTab = button.dataset.tab;
                    location.hash = targetTab;
                    switchToTab(targetTab);
                });
            });
            const initialTabId = location.hash.substring(1) || 'comment';
            const firstTab = document.querySelector('.tab-button')?.dataset.tab;
            if (document.querySelector(`.tab-button[data-tab="${initialTabId}"]`)) {
                switchToTab(initialTabId);
            } else if (firstTab) {
                switchToTab(firstTab);
            }
        };

        const setupModals = () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('is-active');
                    }
                });
            });
            DOMElements.commentModalClose.onclick = () => DOMElements.commentModal.classList.remove('is-active');
            DOMElements.stageModalClose.onclick = () => DOMElements.stageModal.classList.remove('is-active');
            DOMElements.nameModalClose.onclick = () => DOMElements.nameModal.classList.remove('is-active');
        };

        DOMElements.editNameButton.onclick = () => {
            DOMElements.nameInput.value = myDisplayName;
            DOMElements.nameModal.classList.add('is-active');
        };
        DOMElements.saveNameButton.onclick = () => {
            const newName = DOMElements.nameInput.value.trim();
            if (newName) {
                myDisplayName = newName;
                localStorage.setItem('myDisplayName', myDisplayName);
                DOMElements.nameModal.classList.remove('is-active');
            }
        };

        window.onresize = updateTeamDisplay;

        document.addEventListener("DOMContentLoaded", () => {
            initializePage();
            setupTabs();
            setupModals();

            // === ▼▼▼ 新規追加 ▼▼▼ ===
            // 配信画面セレクターのクリックイベント
            DOMElements.streamViewSelector.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target && target.dataset.view) {
                    sessionDocRef.update({ currentStreamView: target.dataset.view });
                }
            });
            // === ▲▲▲ 新規追加 ▲▲▲ ===
        });
    </script>
</body>

</html>