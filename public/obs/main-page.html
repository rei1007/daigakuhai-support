<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>対戦情報</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* 1. Root Variables & Base Styles */
        :root {
            /* Colors */
            --alpha-color: #d3bc3b;
            --bravo-color: #3a0ccd;
            --primary-color: #45abff;
            --secondary-color: #40d1b2;
            --background-color: #2c2c2c;
            --container-color: #000000;
            --text-color: #ffffff;
            --text-color-dark: #000000;
            --status-disconnected: #a73f35;
            /* Lag color */
            --status-connecting: #d6b34a;
            /* Waiting color */
            --xp-highlight-color: #B3261E;
            /* Trouble color */


            /* Typography */
            --font-family: 'Noto Sans JP', sans-serif;
            --font-size-player: 45px;
            --font-size-team-name: 50px;
            --font-size-score: 80px;
            --font-size-title: 40px;
            --font-size-caster-role: 30px;
            --font-size-caster-name: 50px;
            --font-size-menu-icon: 60px;
            --font-size-menu-text: 40px;
            --font-size-xp-avg: 35px;
            --font-size-next-label: 40px;
            --font-size-next-arrow: 50px;
            --font-size-live: 35px;
            --font-size-clock: 35px;
            --font-size-status: 35px;

            /* Spacing & Sizing */
            --space-xs: 5px;
            --space-sm: 10px;
            --space-md: 15px;
            --space-lg: 20px;
            --space-xl: 40px;
            --radius-sm: 20px;
            --radius-md: 40px;
            --radius-lg: 50px;
            --caster-icon-size: 125px;
            --stage-img-width-sm: calc(400px / 2.05);
            --stage-img-height-sm: calc(310px / 2.05);
            --stage-img-width-md: calc(400px / 1.5);
            --stage-img-height-md: calc(310px / 1.5);
            --stage-img-width-lg: calc(400px / 1.2);
            --stage-img-height-lg: calc(310px / 1.2);
            --logo-max-width: 80%;
            /* Logo size */
            --logo-max-height: 80%;
            /* Logo size */


            /* Animation */
            --transition-smooth: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);

            /* スコア更新アニメーション */
            --update-glow-alpha: 0 0 20px 5px var(--alpha-color);
            --update-glow-bravo: 0 0 20px 5px var(--bravo-color);
        }

        /* グローバルリセット */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 基礎スタイル */
        body {
            width: 1920px;
            height: 1080px;
            font-family: var(--font-family);
            color: var(--text-color);
            background-color: var(--container-color);
            overflow: hidden;
        }

        /* 2. Screen Layout (#screen, #background) */
        #screen {
            position: relative;
            width: 100%;
            height: 100%;
            padding: var(--space-lg);
            overflow: hidden;
        }

        #background {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
        }

        /* 3. Tab Menu (#tab-menu, .menu-item) */
        #tab-menu {
            display: flex;
            gap: var(--space-lg);
        }

        .menu-item {
            display: flex;
            align-items: center;
            width: fit-content;
            height: 100px;
            padding: var(--space-lg);
            gap: var(--space-sm);
            box-sizing: border-box;
            border: 4px solid transparent;
            background: var(--container-color);
            border-radius: var(--radius-lg);
            transition: border-color 0.3s ease, transform 0.2s ease;
        }

        .menu-item:not(.active-menu):hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
        }

        .menu-item .material-symbols-rounded {
            font-size: var(--font-size-menu-icon);
            color: var(--primary-color);
        }

        .menu-item p {
            display: none;
            margin: 0 var(--space-sm);
            color: var(--text-color);
            font-size: var(--font-size-menu-text);
            font-weight: bold;
            white-space: nowrap;
        }

        .menu-item #match-title {
            display: block !important;
            color: var(--secondary-color);
        }

        .menu-item.active-menu {
            border-color: var(--secondary-color);
        }

        .menu-item.active-menu p:not(#match-title) {
            display: block;
        }


        /* 4. Tab Content Area (.tab-content) & Animation */
        .tab-content {
            position: absolute;
            top: 140px;
            /* Adjust based on tab menu height + spacing */
            left: var(--space-lg);
            width: calc(100% - (var(--space-lg) * 2));
            /* Adjust height considering top offset, bottom padding, and commentator area */
            height: calc(100% - 140px - var(--space-lg) - 165px);
            padding: var(--space-lg);
            box-sizing: border-box;
            background: var(--container-color);
            border-radius: var(--radius-md);
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px) scale(0.98);
            transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: opacity, transform;
        }

        .tab-content.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0) scale(1);
        }

        /* Logo Tab Content */
        #logo-content {
            display: flex;
            /* Use flexbox for centering */
            justify-content: center;
            align-items: center;
            height: 100%;
            /* Ensure it takes full height of the content area */
        }

        #logo-content img {
            max-width: var(--logo-max-width);
            max-height: var(--logo-max-height);
            object-fit: contain;
            /* Ensure logo fits without distortion */
        }


        /* 5. Match Info Tab (#match-info) */
        #match-info #team-data-wrap {
            display: flex;
            width: 1483px;
            /* Fixed width based on design */
            height: 100%;
            gap: var(--space-lg);
        }

        #match-info .team-data {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--background-color);
            border-radius: var(--radius-sm);
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        #match-info .team-data.is-loser {
            opacity: 0.6;
            filter: grayscale(50%);
        }

        #match-info .team-name {
            width: fit-content;
            padding: var(--space-sm) var(--space-xl);
            font-size: var(--font-size-team-name);
            color: var(--text-color-dark);
            border-radius: var(--radius-sm) 0 var(--radius-sm) 0;
        }

        #match-info .team-name.alpha {
            background: var(--alpha-color);
        }

        #match-info .team-name.bravo {
            color: var(--text-color);
            background: var(--bravo-color);
        }

        #match-info .team-affiliation {
            padding: var(--space-md) var(--space-xl) 0;
            font-size: var(--font-size-title);
            color: var(--secondary-color);
            transition: opacity 0.3s ease;
        }

        #match-info .team-affiliation.is-fading {
            opacity: 0;
        }

        #match-info .player {
            padding: var(--space-md) var(--space-xl);
            font-size: var(--font-size-player);
            font-weight: 700;
        }

        #match-info .player-name.highest-xp::after {
            content: ' ★';
            margin-left: var(--space-xs);
            font-size: var(--font-size-player);
            color: var(--primary-color);
        }

        #match-info .player-name.xp-highlight {
            color: var(--primary-color);
        }

        #match-info hr {
            margin: 0 var(--space-lg);
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        #match-info .xp-avg {
            width: fit-content;
            margin: var(--space-sm) var(--space-lg);
            padding: var(--space-sm) var(--space-lg);
            font-size: var(--font-size-xp-avg);
            font-weight: bold;
            color: var(--secondary-color);
            background: var(--container-color);
            border-radius: var(--radius-md);
        }

        #match-info .points {
            position: absolute;
            bottom: 0;
            right: 0;
            height: 110px;
            min-width: 110px;
            padding: var(--space-sm) var(--space-xl);
            font-size: var(--font-size-score);
            line-height: var(--font-size-score);
            font-weight: bold;
            text-align: center;
            color: var(--text-color-dark);
            border-radius: var(--radius-md) 0 0 0;
            box-shadow: none;
            transition: opacity 0.3s ease, background 0.3s ease, transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.3s ease;
            transform: scale(1);
        }

        #match-info .points.is-updating {
            transition-duration: 0.1s;
            transform: scale(1.15);
        }

        #match-info .points.is-updating.alpha {
            box-shadow: var(--update-glow-alpha);
        }

        #match-info .points.is-updating.bravo {
            box-shadow: var(--update-glow-bravo);
        }

        #match-info .points.alpha {
            background: var(--alpha-color);
        }

        #match-info .points.bravo {
            color: var(--text-color);
            background: var(--bravo-color);
        }

        #match-info .points.loser-score {
            opacity: 0.6;
        }

        #next-stage {
            position: absolute;
            bottom: var(--space-lg);
            right: var(--space-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #previous-stage-img,
        #next-stage-img {
            display: none;
            /* JS control */
            width: var(--stage-img-width-lg);
            height: var(--stage-img-height-lg);
            margin: var(--space-md) 0 0;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-sm);
            object-fit: cover;
        }

        #next-stage .next-label {
            width: fit-content;
            padding: var(--space-xs) var(--space-lg);
            font-size: var(--font-size-next-label);
            color: var(--secondary-color);
            background: var(--background-color);
            border-radius: var(--radius-md);
        }

        #next-stage .next-indicator {
            display: none;
            /* JS control */
            width: 100%;
            height: 60px;
            margin: var(--space-md) 0 0;
            font-size: var(--font-size-menu-text);
            font-weight: bold;
            line-height: 60px;
            color: var(--text-color);
            text-align: center;
        }

        #next-stage .next-indicator .material-symbols-rounded {
            font-size: var(--font-size-next-arrow);
            color: var(--secondary-color);
            vertical-align: middle;
        }

        /* 6. Stage List Tab (#stage-list) */
        #stage-list #selected-stages {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin: var(--space-md) 0 var(--space-lg);
            gap: var(--space-lg);
            border-bottom: 1px solid var(--outline-color);
            /* Assuming outline color exists */
        }

        #stage-list #score-display {
            width: fit-content;
            height: 110px;
            margin-right: var(--space-lg);
            padding: 0 var(--radius-md);
            font-size: var(--font-size-score);
            line-height: 110px;
            font-weight: bold;
            background-color: var(--background-color);
            border-radius: var(--radius-sm);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            transform: scale(1);
        }

        #stage-list #score-display span {
            display: inline-block;
            transition: text-shadow 0.3s ease, color 0.3s ease, transform 0.3s ease;
        }

        #stage-list #score-display.is-updating-alpha span.alpha {
            text-shadow: var(--update-glow-alpha);
            transition-duration: 0.1s;
            transform: scale(1.1);
        }

        #stage-list #score-display.is-updating-bravo span.bravo {
            text-shadow: var(--update-glow-bravo);
            transition-duration: 0.1s;
            transform: scale(1.1);
        }

        #stage-list #score-display .alpha {
            color: var(--alpha-color);
        }

        #stage-list #score-display .bravo {
            color: #9c82f3;
        }

        /* Adjusted Bravo score color for visibility */
        #stage-list .stage {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-sm);
            object-fit: cover;
        }

        #stage-list #selected-stages .stage {
            width: var(--stage-img-width-md);
            height: var(--stage-img-height-md);
        }

        #stage-list #active-stage-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            overflow-y: auto;
        }

        #stage-list #active-stage-list .stage {
            width: var(--stage-img-width-sm);
            height: var(--stage-img-height-sm);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
        }

        #stage-list #active-stage-list .stage.is-unused {
            opacity: 0.4;
            filter: grayscale(90%);
        }


        /* 7. Replay Tab (#replay) */
        /* No specific styles needed for replay tab itself */

        /* 8. Commentator Display (#commentator-container) */
        #commentator-container {
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 10;
            display: flex;
            padding: var(--space-lg);
            border-top: solid 4px var(--secondary-color);
            border-left: solid 4px var(--secondary-color);
            color: var(--text-color);
            background: var(--container-color);
            border-top-left-radius: var(--radius-md);
        }

        .commentator-box {
            display: flex;
            align-items: center;
            margin-right: var(--space-xl);
            gap: var(--space-lg);
        }

        .commentator-icon {
            display: block;
            width: var(--caster-icon-size);
            height: var(--caster-icon-size);
            border: 5px solid var(--primary-color);
            flex-shrink: 0;
            background-color: rgba(255, 255, 255, 0.1);
            background-size: cover;
            background-position: center;
            border-radius: var(--radius-sm);
        }

        .commentator-name-details {
            min-width: 300px;
            max-width: 500px;
        }

        .commentator-name-details .role {
            font-size: var(--font-size-caster-role);
            font-weight: bold;
            color: var(--primary-color);
        }

        .commentator-name-details .name {
            overflow: hidden;
            font-size: var(--font-size-caster-name);
            font-weight: bold;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* 9. Top Right Info Area */
        #top-right-container {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-md);
        }

        #live-indicator,
        #clock-display {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-live);
            /* Use live size for both */
            font-weight: 700;
            color: var(--text-color);
            background-color: var(--container-color);
            border: 2px solid var(--text-color);
            border-radius: var(--radius-sm);
        }

        #live-indicator .dot {
            width: 20px;
            height: 20px;
            background-color: var(--status-disconnected);
            border-radius: 50%;
            animation: pulse-live 1.5s infinite;
        }

        #status-message {
            display: none;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-status);
            font-weight: 700;
            color: var(--text-color);
            border-radius: var(--radius-sm);
            border: 2px solid var(--text-color);
            opacity: 0;
            transition: var(--transition-smooth);
        }

        #status-message.is-visible {
            display: flex;
            opacity: 1;
        }

        #status-message.is-lag {
            background-color: var(--status-disconnected);
            animation: pulse-danger 1.5s infinite;
        }

        #status-message.is-waiting {
            background-color: var(--status-connecting);
            color: var(--text-color-dark);
            border-color: var(--text-color-dark);
        }

        #status-message.is-trouble {
            background-color: var(--xp-highlight-color);
        }

        /* Trouble style */
        #status-message .material-symbols-rounded {
            font-size: 45px;
        }

        /* Animations */
        @keyframes pulse-live {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes pulse-danger {
            0% {
                box-shadow: 0 0 0 0 rgba(167, 63, 53, 0.7);
            }

            70% {
                box-shadow: 0 0 1rem 1rem rgba(167, 63, 53, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(167, 63, 53, 0);
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <main id="screen">
        <div id="background"></div>

        <div id="top-right-container">
            <div id="live-indicator">
                <span class="dot"></span> LIVE
            </div>
            <div id="clock-display">--:--</div>
            <div id="status-message">
                <span class="material-symbols-rounded"></span>
                <p></p>
            </div>
        </div>

        <div id="tab-menu">
            <div id="menu-logo" class="menu-item" data-view="logo">
                <span class="material-symbols-rounded">photo_camera</span>
                <p>ロゴ</p>
            </div>
            <div id="menu-matchInfo" class="menu-item" data-view="matchInfo">
                <span class="material-symbols-rounded">scoreboard</span>
                <p>対戦情報</p>
                <p id="match-title">Loading...</p>
            </div>
            <div id="menu-alphaDetail" class="menu-item" data-view="alphaDetail">
                <span class="material-symbols-rounded">person</span>
                <p>アルファ詳細</p>
            </div>
            <div id="menu-bravoDetail" class="menu-item" data-view="bravoDetail">
                <span class="material-symbols-rounded">person</span>
                <p>ブラボー詳細</p>
            </div>
            <div id="menu-stageList" class="menu-item" data-view="stageList">
                <span class="material-symbols-rounded">distance</span>
                <p>ステージ</p>
            </div>
            <div id="menu-replay" class="menu-item" data-view="replay">
                <span class="material-symbols-rounded">autoplay</span>
                <p>リプレイ</p>
            </div>
        </div>

        <div class="content-container">
            <div id="logo-content" class="tab-content">
                <img src="../icons/大学杯ロゴ.png" alt="大学杯 Logo">
            </div>
            <div id="match-info" class="tab-content active">
                <div id="team-data-wrap">
                    <div id="alpha-team-data" class="team-data">
                        <h1 id="alpha-team-name" class="team-name alpha">Team Alpha</h1>
                        <h2 id="alpha-team-affiliation" class="team-affiliation">Affiliation</h2>
                        <div id="alpha-player-list"></div>
                        <p id="alpha-xp-avg" class="xp-avg">平均XP: ----</p>
                        <p id="alpha-points" class="points alpha">0</p>
                    </div>
                    <div id="bravo-team-data" class="team-data">
                        <h1 id="bravo-team-name" class="team-name bravo">Team Bravo</h1>
                        <h2 id="bravo-team-affiliation" class="team-affiliation">Affiliation</h2>
                        <div id="bravo-player-list"></div>
                        <p id="bravo-xp-avg" class="xp-avg">平均XP: ----</p>
                        <p id="bravo-points" class="points bravo">0</p>
                    </div>
                </div>
                <div id="next-stage">
                    <h1 class="next-label">ステージ</h1>
                    <img id="previous-stage-img" class="stage" src="" alt="Previous Stage">
                    <p class="next-indicator"><span
                            class="material-symbols-rounded">keyboard_double_arrow_down</span>NEXT<span
                            class="material-symbols-rounded">keyboard_double_arrow_down</span></p>
                    <img id="next-stage-img" class="stage" src="" alt="Next Stage">
                </div>
            </div>

            <div id="stage-list" class="tab-content">
                <div id="selected-stages">
                    <p id="score-display"><span class="alpha">0</span> - <span class="bravo">0</span></p>
                </div>
                <div id="active-stage-list"></div>
            </div>

            <div id="alpha-detail-content" class="tab-content team-detail-content">
                <div class="team-data detail-view alpha">
                    <h1 class="team-name alpha">Team Alpha</h1>
                    <h2 class="team-affiliation">Affiliation</h2>
                    <div class="player-list"></div>
                    <p class="xp-avg">平均XP: ----</p>
                </div>
            </div>
            <div id="bravo-detail-content" class="tab-content team-detail-content">
                <div class="team-data detail-view bravo">
                    <h1 class="team-name bravo">Team Bravo</h1>
                    <h2 class="team-affiliation">Affiliation</h2>
                    <div class="player-list"></div>
                    <p class="xp-avg">平均XP: ----</p>
                </div>
            </div>
            <div id="replay" class="tab-content">
            </div>
        </div>

        <div id="commentator-container">
            <div class="commentator-box caster">
                <div id="caster-icon" class="commentator-icon"></div>
                <div class="commentator-name-details">
                    <p class="role">実況</p>
                    <h1 id="caster-name" class="name">-</h1>
                </div>
            </div>
            <div class="commentator-box commentator">
                <div id="analyst-icon" class="commentator-icon"></div>
                <div class="commentator-name-details">
                    <p class="role">解説</p>
                    <h1 id="analyst-name" class="name">-</h1>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Firebase Config & Init ---
        const firebaseConfig = { /* ... firebase config ... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');

        // --- Global Vars ---
        let teamsData = [], allStagesData = [], lastKnownState = null, clockIntervalId = null, affiliationInterval = null;

        // --- DOM Refs ---
        const getEl = (id) => document.getElementById(id);
        const DOMElements = {
            matchTitle: getEl('match-title'), casterIcon: getEl('caster-icon'), casterName: getEl('caster-name'),
            analystIcon: getEl('analyst-icon'), analystName: getEl('analyst-name'),
            menuContainer: getEl('tab-menu'), // Tab menu container
            tabLogo: getEl('logo-content'), tabMatchInfo: getEl('match-info'), tabStageList: getEl('stage-list'),
            tabAlphaDetail: getEl('alpha-detail-content'), tabBravoDetail: getEl('bravo-detail-content'), tabReplay: getEl('replay'),
            alphaTeamData: getEl('alpha-team-data'), alphaTeamName: getEl('alpha-team-name'), alphaTeamAffiliation: getEl('alpha-team-affiliation'),
            alphaPlayerList: getEl('alpha-player-list'), alphaXpAvg: getEl('alpha-xp-avg'), alphaPoints: getEl('alpha-points'),
            bravoTeamData: getEl('bravo-team-data'), bravoTeamName: getEl('bravo-team-name'), bravoTeamAffiliation: getEl('bravo-team-affiliation'),
            bravoPlayerList: getEl('bravo-player-list'), bravoXpAvg: getEl('bravo-xp-avg'), bravoPoints: getEl('bravo-points'),
            // Detail Tab Elements
            alphaDetailView: document.querySelector('#alpha-detail-content .team-data'),
            bravoDetailView: document.querySelector('#bravo-detail-content .team-data'),
            // --- (Other refs remain the same) ---
            previousStageImg: getEl('previous-stage-img'), nextLabel: document.querySelector('#next-stage .next-label'),
            nextIndicator: document.querySelector('#next-stage .next-indicator'), nextStageImg: getEl('next-stage-img'),
            scoreDisplay: getEl('score-display'), stageListAlphaScore: document.querySelector('#score-display .alpha'),
            stageListBravoScore: document.querySelector('#score-display .bravo'), selectedStages: getEl('selected-stages'),
            activeStageList: getEl('active-stage-list'),
            topRightContainer: getEl('top-right-container'), liveIndicator: getEl('live-indicator'),
            clockDisplay: getEl('clock-display'), statusMessage: getEl('status-message'),
        };

        // --- Helper Functions ---
        const setText = (element, text, animationClass = null) => {
            if (!element) return;
            const newText = (text || text === 0) ? String(text) : '-';
            if (element.textContent !== newText) {
                element.textContent = newText;
                if (animationClass) { element.classList.add(animationClass); setTimeout(() => element.classList.remove(animationClass), 300); }
            }
        };
        const setIcon = (element, url) => { if (element) element.style.backgroundImage = url ? `url('${url}')` : 'none'; };
        const updateClock = () => {
            if (!DOMElements.clockDisplay) return;
            const now = new Date();
            DOMElements.clockDisplay.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        };

        // --- Core Update Logic ---
        const switchView = (viewName) => {
            const validViews = ['logo', 'matchInfo', 'alphaDetail', 'bravoDetail', 'stageList', 'replay'];
            const targetView = validViews.includes(viewName) ? viewName : 'matchInfo'; // Default to matchInfo

            // Deactivate all menu items first
            DOMElements.menuContainer.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active-menu'));
            // Deactivate all content tabs
            Object.values(DOMElements).filter(el => el && el.classList?.contains('tab-content')).forEach(div => div.classList.remove('active'));

            if (targetView !== 'logo') {
                // Activate the specific menu item if not logo view
                const menuItem = DOMElements.menuContainer.querySelector(`.menu-item[data-view="${targetView}"]`);
                if (menuItem) menuItem.classList.add('active-menu');
            }

            // Activate the target content tab
            const contentDiv = DOMElements[`tab${targetView.charAt(0).toUpperCase() + targetView.slice(1)}`]; // e.g., tabMatchInfo
            if (contentDiv) {
                contentDiv.classList.add('active');
                // Optional: Re-add entry animation if needed
                // setTimeout(() => { contentDiv.classList.add('is-entering'); }, 50);
            }
        };

        const updateMatchTitle = (roundInfo, bestOf) => {
            const titleElement = DOMElements.matchTitle;
            if (!titleElement) return;

            if (roundInfo) {
                const boText = bestOf ? ` ${bestOf}` : '';
                setText(titleElement, roundInfo + boText);
                titleElement.classList.remove('hidden'); // Show title
            } else {
                setText(titleElement, ''); // Clear text
                titleElement.classList.add('hidden'); // Hide title
            }
        };

        const updateCasters = (state) => { /* ... remains the same ... */ };

        const renderPlayerListHTML = (team) => { // Helper to generate player list HTML
            if (!team) return '';
            const playersToDisplay = team.players.filter(p => p.name);
            if (playersToDisplay.length === 0) return '<p>プレイヤー情報なし</p>';
            const highestXp = Math.max(0, ...playersToDisplay.map(p => p.xp));
            return playersToDisplay.map((player, index) => {
                const nameClasses = ['player-name'];
                if (player.xp === highestXp && highestXp > 0) nameClasses.push('highest-xp');
                if (player.xp >= 3200) nameClasses.push('xp-highlight');
                return `
                     <div class="player">
                         <span class="${nameClasses.join(' ')}">${player.name}</span>
                     </div>
                     ${index < playersToDisplay.length - 1 ? '<hr>' : ''}
                 `;
            }).join('');
        };


        const updateStageDisplay = (stages = [], bestOf = 'BO3') => { /* ... remains the same ... */ };

        const updateMatchInfoTab = (state) => {
            if (!state.matchup || !teamsData.length) return;
            const alphaTeam = teamsData.find(t => t.id === state.matchup.alphaTeamId);
            const bravoTeam = teamsData.find(t => t.id === state.matchup.bravoTeamId);
            if (!alphaTeam || !bravoTeam) return;

            // Update main match info tab elements
            setText(DOMElements.alphaTeamName, alphaTeam.teamName);
            setText(DOMElements.bravoTeamName, bravoTeam.teamName);
            // Affiliation is handled by switcher
            DOMElements.alphaPlayerList.innerHTML = renderPlayerListHTML(alphaTeam); // Use helper
            DOMElements.bravoPlayerList.innerHTML = renderPlayerListHTML(bravoTeam); // Use helper
            setText(DOMElements.alphaXpAvg, `平均XP: ${String(alphaTeam.avgXp || 0).padStart(4, '0')}`);
            setText(DOMElements.bravoXpAvg, `平均XP: ${String(bravoTeam.avgXp || 0).padStart(4, '0')}`);

            // --- Score & Win/Loss Logic (remains the same) ---
            const stages = state.stages || [];
            const alphaWins = stages.filter(s => s && s.winner === 'alpha').length;
            const bravoWins = stages.filter(s => s && s.winner === 'bravo').length;
            const winCondition = (state.bestOf === 'BO5' ? 3 : 2);
            const isGameOver = alphaWins >= winCondition || bravoWins >= winCondition;
            setText(DOMElements.alphaPoints, alphaWins, 'is-updating');
            setText(DOMElements.bravoPoints, bravoWins, 'is-updating');
            DOMElements.alphaTeamData.classList.toggle('is-loser', isGameOver && alphaWins < bravoWins);
            DOMElements.bravoTeamData.classList.toggle('is-loser', isGameOver && bravoWins < alphaWins);
            DOMElements.alphaPoints.classList.toggle('loser-score', isGameOver && alphaWins < bravoWins);
            DOMElements.bravoPoints.classList.toggle('loser-score', isGameOver && bravoWins < alphaWins);
            if (isGameOver) {
                if (alphaWins > bravoWins) DOMElements.alphaPoints.textContent = 'WIN';
                else DOMElements.bravoPoints.textContent = 'WIN';
            }

            updateStageDisplay(stages, state.bestOf);

            // --- Update Detail Tabs ---
            if (DOMElements.alphaDetailView) {
                DOMElements.alphaDetailView.querySelector('.team-name').textContent = alphaTeam.teamName;
                DOMElements.alphaDetailView.querySelector('.team-affiliation').textContent = alphaTeam.university; // Default to university
                DOMElements.alphaDetailView.querySelector('.player-list').innerHTML = renderPlayerListHTML(alphaTeam);
                DOMElements.alphaDetailView.querySelector('.xp-avg').textContent = `平均XP: ${String(alphaTeam.avgXp || 0).padStart(4, '0')}`;
            }
            if (DOMElements.bravoDetailView) {
                DOMElements.bravoDetailView.querySelector('.team-name').textContent = bravoTeam.teamName;
                DOMElements.bravoDetailView.querySelector('.team-affiliation').textContent = bravoTeam.university; // Default to university
                DOMElements.bravoDetailView.querySelector('.player-list').innerHTML = renderPlayerListHTML(bravoTeam);
                DOMElements.bravoDetailView.querySelector('.xp-avg').textContent = `平均XP: ${String(bravoTeam.avgXp || 0).padStart(4, '0')}`;
            }
        };


        const createStageListCard = (stageName, winner = null, isUnused = false) => { /* ... remains the same ... */ };
        const updateStageListTab = (state) => { /* ... remains the same ... */ };

        const updateStreamStatus = (streamState) => {
            const statusElement = DOMElements.statusMessage;
            if (!statusElement) return;

            const matchStatus = streamState.match || 'outside';
            const incidentStatus = streamState.incident || 'none';
            const iconEl = statusElement.querySelector('.material-symbols-rounded');
            const textEl = statusElement.querySelector('p');

            statusElement.classList.remove('is-visible', 'is-lag', 'is-waiting', 'is-trouble'); // Reset all

            if (incidentStatus === 'lag') {
                iconEl.textContent = 'error';
                textEl.textContent = 'ラグ対応中';
                statusElement.classList.add('is-lag', 'is-visible');
            } else if (incidentStatus === 'trouble') {
                iconEl.textContent = 'warning';
                textEl.textContent = 'トラブル発生';
                statusElement.classList.add('is-trouble', 'is-visible');
            } else if (matchStatus === 'waiting') {
                iconEl.textContent = 'hourglass_empty';
                textEl.textContent = '試合待機中';
                statusElement.classList.add('is-waiting', 'is-visible');
            }
            // Otherwise, it remains hidden (no 'is-visible' class)
        };

        // --- Main Update Function ---
        const updateDisplay = (state) => {
            if (!state) return;
            lastKnownState = state;
            switchView(state.currentStreamView); // Updated switchView handles logo case
            updateMatchTitle(state.roundInfo, state.bestOf); // Updated to hide if no roundInfo
            updateCasters(state);
            updateStreamStatus(state.streamState || { match: 'outside', incident: 'none' }); // Pass the object

            if (teamsData.length > 0 && state.matchup) {
                updateMatchInfoTab(state); // Also updates detail tabs now
                updateStageListTab(state);
            }
        };

        // --- Affiliation Switcher ---
        const startAffiliationSwitcher = () => {
            if (affiliationInterval) clearInterval(affiliationInterval);
            let showUniversity = true;

            const switchText = () => {
                if (!lastKnownState || !lastKnownState.matchup || teamsData.length === 0) return;
                const alphaTeam = teamsData.find(t => t.id === lastKnownState.matchup.alphaTeamId);
                const bravoTeam = teamsData.find(t => t.id === lastKnownState.matchup.bravoTeamId);
                if (!alphaTeam || !bravoTeam) return;

                const alphaAffiliationEl = DOMElements.alphaTeamAffiliation;
                const bravoAffiliationEl = DOMElements.bravoTeamAffiliation;
                const alphaDetailAffiliationEl = DOMElements.alphaDetailView?.querySelector('.team-affiliation');
                const bravoDetailAffiliationEl = DOMElements.bravoDetailView?.querySelector('.team-affiliation');

                const elements = [alphaAffiliationEl, bravoAffiliationEl, alphaDetailAffiliationEl, bravoDetailAffiliationEl].filter(Boolean); // Filter out nulls
                elements.forEach(el => el.classList.add('is-fading'));

                setTimeout(() => {
                    const alphaText = showUniversity ? alphaTeam.university : alphaTeam.circle;
                    const bravoText = showUniversity ? bravoTeam.university : bravoTeam.circle;
                    setText(alphaAffiliationEl, alphaText);
                    setText(bravoAffiliationEl, bravoText);
                    setText(alphaDetailAffiliationEl, alphaText); // Update detail view too
                    setText(bravoDetailAffiliationEl, bravoText); // Update detail view too
                    elements.forEach(el => el.classList.remove('is-fading'));
                    showUniversity = !showUniversity;
                }, 300);
            };

            // Initial display
            if (lastKnownState && lastKnownState.matchup && teamsData.length > 0) {
                const alphaTeam = teamsData.find(t => t.id === lastKnownState.matchup.alphaTeamId);
                const bravoTeam = teamsData.find(t => t.id === lastKnownState.matchup.bravoTeamId);
                const alphaDetailAffiliationEl = DOMElements.alphaDetailView?.querySelector('.team-affiliation');
                const bravoDetailAffiliationEl = DOMElements.bravoDetailView?.querySelector('.team-affiliation');
                if (alphaTeam) {
                    setText(DOMElements.alphaTeamAffiliation, alphaTeam.university);
                    setText(alphaDetailAffiliationEl, alphaTeam.university);
                }
                if (bravoTeam) {
                    setText(DOMElements.bravoTeamAffiliation, bravoTeam.university);
                    setText(bravoDetailAffiliationEl, bravoTeam.university);
                }
            }
            affiliationInterval = setInterval(switchText, 5000);
        };


        // --- Initialization ---
        const initialize = async () => {
            console.log("Initializing...");
            updateClock();
            if (clockIntervalId) clearInterval(clockIntervalId);
            clockIntervalId = setInterval(updateClock, 1000);

            sessionDocRef.onSnapshot(
                (doc) => {
                    if (doc.exists) {
                        updateDisplay(doc.data());
                        if (teamsData.length > 0 && !affiliationInterval) startAffiliationSwitcher();
                    } else { console.error("Doc does not exist!"); setText(DOMElements.matchTitle, "データエラー"); }
                },
                (error) => { console.error("Firestore listener error:", error); setText(DOMElements.matchTitle, "接続エラー"); }
            );

            try {
                const [teamsRes, stagesRes] = await Promise.all([fetch('../teams.json'), fetch('../stages.json')]);
                if (!teamsRes.ok || !stagesRes.ok) throw new Error('Data fetch failed');
                const rawTeamsData = await teamsRes.json();

                // Calculate avgXp
                teamsData = rawTeamsData.map(team => {
                    const xps = [team.p1_xp, team.p2_xp, team.p3_xp, team.p4_xp].map(xp => parseInt(xp, 10) || 0);
                    const playerCount = xps.filter((xp, i) => xp > 0 || team[`p${i + 1}_name`]).length;
                    const totalXp = xps.reduce((sum, xp) => sum + xp, 0);
                    const avgXp = playerCount > 0 ? Math.round(totalXp / playerCount) : 0;
                    return { /* ...team data... */ avgXp: avgXp, players: [ /* player objects */] /* Map players properly */ };
                });

                allStagesData = (await stagesRes.json()).map(s => s.trim());
                console.log("Static data loaded.");
                if (lastKnownState) { console.log("Re-rendering."); updateDisplay(lastKnownState); if (!affiliationInterval) startAffiliationSwitcher(); }
            } catch (error) { console.error("Error loading static data:", error); setText(DOMElements.matchTitle, "静的データ読込失敗"); }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initialize);

        // Tab Menu Click Listener (Event Delegation) - Added
        DOMElements.menuContainer.addEventListener('click', (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (menuItem && menuItem.dataset.view) {
                // Update Firestore which will trigger switchView via onSnapshot
                sessionDocRef.update({ currentStreamView: menuItem.dataset.view })
                    .catch(err => console.error("Error updating view:", err));
            }
        });


    </script>
</body>

</html>