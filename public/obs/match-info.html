<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>対戦情報</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS変数定義 */
        :root {
            --alpha-color: #d3bc3b;
            --bravo-color: #8c3ec0;
        }

        /* 基本スタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            background-color: #f5f5f5;
            font-family: 'Noto Sans JP', sans-serif;
            color: #111;
            overflow: hidden;
        }

        /* 各セクションのスタイル */
        #screen {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 40px;
            background-color: #ffffff;
            overflow: hidden;

            &::before {
                content: "";
                position: absolute;
                top: 10px;
                left: 20px;
                width: calc(100% - 40px);
                height: 20px;
                background: linear-gradient(to right, var(--alpha-color) 0%, #eee1e1 50%, var(--bravo-color) 100%);
                border-radius: 10px;
            }
        }

        #main-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            gap: 60px;

            .team-data {
                display: flex;
                flex-direction: column;
                width: 700px;

                .univ-name,
                .circle-name {
                    font-family: "GenWanMin JP Regular";
                    font-size: 40px;
                    font-weight: 700;
                    line-height: 1.5;
                    color: #222;
                    position: relative;
                    overflow: hidden;
                }

                .univ-name::before,
                .circle-name::before {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: #777;
                }

                #alpha-univ .univ-name::before,
                #alpha-univ .circle-name::before {
                    animation: SlideInA 5s ease-in-out forwards;
                }

                .circle-name {
                    display: none;
                }

                .team-name {
                    margin-bottom: 20px;
                    font-family: "07鉄瓶ゴシック";
                    font-size: 50px;
                    font-weight: bold;
                    line-height: 1.2;
                    letter-spacing: -1.8px;
                }

                .member {
                    font-family: "GenWanMin JP Regular";
                    font-size: 45px;
                    font-weight: 900;
                    line-height: 1.2;
                    color: #222;
                }

                hr {
                    width: 80%;
                    margin: 10px 0;
                    border: none;
                    height: 4px;
                    background: linear-gradient(to right, var(--bravo-color) 20%, #eee1e1);
                }

                .alpha-border {
                    background: linear-gradient(to right, #eee1e1, var(--alpha-color) 80%);
                }

                .xp-avg {
                    margin-top: 20px;
                    padding: 8px 20px;
                    border: 1px solid #aaa;
                    border-radius: 100px;
                    font-family: "Tsukuhou Shogo Mincho OFL";
                    font-size: 35px;
                    font-weight: 700;
                    line-height: 1;
                    color: #555;
                    text-align: center;
                }
            }

            .alpha {
                align-items: flex-end;
                text-align: right;

                .team-name {
                    color: var(--alpha-color);
                }
            }

            .bravo {
                align-items: flex-start;
                text-align: left;

                .team-name {
                    color: var(--bravo-color);
                }

                hr {
                    margin-right: auto;
                }
            }
        }

        #match-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 80px;
            gap: 40px;

            #round {
                font-family: "Yuji Syuku Regular";
                font-size: 50px;
                line-height: 1.2;
                color: #555;
                text-align: center;
            }

            #points {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 150px;
                gap: 20px;

                #alpha-points,
                #bravo-points {
                    width: 100%;
                    height: 100%;
                    border-radius: 10px;
                    font-family: "Alimama DongFangDaKai";
                    font-size: 100px;
                    font-weight: 700;
                    line-height: 1.4;
                    color: #222;
                    text-align: center;
                    transition: all 0.5s ease-in-out;
                }

                #alpha-points {
                    border: 5px solid var(--alpha-color);
                }

                #bravo-points {
                    border: 5px solid var(--bravo-color);
                }

                .alpha-points-loser,
                .bravo-points-loser {
                    opacity: 0.6;
                    text-shadow: none !important;
                }
            }

            #win {
                display: none;
                font-family: "Yuji Syuku Regular";
                font-size: 60px;
                font-weight: 900;
                line-height: 1;
                text-align: center;
            }

            .alpha-win {
                display: block;
                color: var(--alpha-color);
            }

            .bravo-win {
                display: block;
                color: var(--bravo-color);
            }
        }

        #stage-section {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 45px;
            gap: 20px;

            .stage {
                width: 350px;
            }
        }

        #footer-info {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 800px;
            padding: 10px 40px;
            border: 1px solid #aaa;
            border-radius: 100px 5px 5px 100px;
            overflow: hidden;

            p {
                font-family: "Tsukuhou Shogo Mincho OFL";
                font-size: 40px;
                color: #555;
                font-weight: bold;
                text-align: center;
                animation: fadeIn 5s ease-in-out forwards;
                &:not(:first-child) {
                    display: none;
                }
            }
        }

        /* 汎用・状態変化スタイル */
        .highlight-color-text {
            color: #b46767 !important;
        }

        .loser-team {
            opacity: 0.4;
            filter: grayscale(50%);
            transition: all 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes SlideInA {
            0%,20%,100% {
                transform: translateX(105%);
            }
            10%{
                transform: translateX(-100%);
            }
        }

        @keyframes SlideInB {
            0%,20%,100% {
                transform: translateX(-100%);
            }
            10%{
                transform: translateX(105%);
            }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <main id="screen">
        <div id="main-section">
            <div class="team-data alpha">
                <p id="alpha-univ" class="univ-name">アルファ大学</p>
                <p id="alpha-circle" class="circle-name">アルファサークル</p>
                <h1 id="alpha-team-name" class="team-name">アルファチーム</h1>
                <h2 id="alpha-member1" class="member">アルファメンバー1</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member2" class="member">アルファメンバー2</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member3" class="member">アルファメンバー3</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member4" class="member">アルファメンバー4</h2>
                <p id="alpha-xp-avg" class="xp-avg">平均XP：----</p>
            </div>
            <div id="match-data">
                <h1 id="round">ラウンド情報<br>BO3</h1>
                <div id="points">
                    <div id="alpha-points">0</div>
                    <div id="bravo-points">0</div>
                </div>
                <div id="win" class="progress">勝負あり</div>
            </div>
            <div class="team-data bravo">
                <p id="bravo-univ" class="univ-name">ブラボー大学</p>
                <p id="bravo-circle" class="circle-name">ブラボーサークル</p>
                <h1 id="bravo-team-name" class="team-name">ブラボーチーム</h1>
                <h2 id="bravo-member1" class="member">ブラボーメンバー1</h2>
                <hr>
                <h2 id="bravo-member2" class="member">ブラボーメンバー2</h2>
                <hr>
                <h2 id="bravo-member3" class="member">ブラボーメンバー3</h2>
                <hr>
                <h2 id="bravo-member4" class="member">ブラボーメンバー4</h2>
                <p id="bravo-xp-avg" class="xp-avg">平均XP：----</p>
            </div>
        </div>

        <div id="stage-section">
            <img class="stage" src="../stage-image/未決定.png">
            <img class="stage" src="../stage-image/未決定.png">
            <img class="stage" src="../stage-image/未決定.png">
        </div>

        <footer id="footer-info">
            <p class="footer-a">大学杯・真打 本戦LIVE配信</p>
            <p class="footer-b">大学杯運営公式X：@daigakuhai</p>
            <p class="footer-c">#大学杯・真打 で感想をポスト</p>
        </footer>
    </main>

    <script>
        // --- 要素の自動切り替えアニメーション ---
        function setupElementSwitcher(selector, interval = 5000) {
            const elements = document.querySelectorAll(selector);
            if (elements.length <= 1) return;

            let currentIndex = 0;
            setInterval(() => {
                elements[currentIndex].style.display = 'none';
                currentIndex = (currentIndex + 1) % elements.length;
                elements[currentIndex].style.display = 'block';
            }, interval);
        }

        // 初期化
        setupElementSwitcher('#footer-info p');
        setupElementSwitcher('.alpha .univ-name, .alpha .circle-name');
        setupElementSwitcher('.bravo .univ-name, .bravo .circle-name');


        // --- Firebase関連の処理 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');

        let teamsData = [];
        const getEl = (id) => document.getElementById(id);


        // --- 画面表示の更新処理 ---
        async function updateDisplay(state) {
            // teams.jsonの読み込み（初回のみ）
            if (teamsData.length === 0) {
                try {
                    const res = await fetch('../teams.json');
                    teamsData = await res.json();
                } catch (e) {
                    console.error("teams.jsonの読み込みに失敗しました。", e);
                    return;
                }
            }

            const alphaTeamData = teamsData.find(t => t.id === state.matchup?.alphaTeamId);
            const bravoTeamData = teamsData.find(t => t.id === state.matchup?.bravoTeamId);

            // チーム情報（アルファ・ブラボー共通）の更新関数
            const updateTeamInfo = (teamData, side) => {
                if (!teamData) return;

                const players = [teamData.p1, teamData.p2, teamData.p3, teamData.p4]
                    .map((p, i) => ({
                        name: teamData[`p${i + 1}_name`],
                        xp: Number(teamData[`p${i + 1}_xp`])
                    }))
                    .filter(p => p.name && p.xp);

                const maxXP = players.length > 0 ? Math.max(...players.map(p => p.xp)) : 0;
                let totalXP = 0;

                getEl(`${side}-univ`).textContent = teamData.university;
                getEl(`${side}-circle`).textContent = teamData.circle;
                getEl(`${side}-team-name`).textContent = teamData.teamName;

                for (let i = 0; i < 4; i++) {
                    const player = players[i];
                    const el = getEl(`${side}-member${i + 1}`);
                    if (player) {
                        let name = player.name;
                        if (player.xp && player.xp > 0 && player.xp === maxXP) {
                            name = (side === 'alpha') ? `★ ${name}` : `${name} ★`;
                        }
                        el.textContent = name;
                        el.classList.toggle('highlight-color-text', player.xp >= 3200);
                        totalXP += player.xp;
                    } else {
                        el.textContent = '';
                    }
                }

                const avgXP = players.length > 0 ? (totalXP / players.length).toFixed(1) : '----';
                getEl(`${side}-xp-avg`).textContent = `平均XP：${avgXP}`;
                getEl(`${side}-xp-avg`).classList.toggle('highlight-color-text', parseFloat(avgXP) >= 3200);
            };

            updateTeamInfo(alphaTeamData, 'alpha');
            updateTeamInfo(bravoTeamData, 'bravo');


            // 試合情報（ラウンド、スコア）の更新
            const bestOf = state.bestOf || 'BO3';
            getEl('round').innerHTML = `${state.roundInfo || 'ラウンド情報'}<br>${bestOf}`;

            const toKansuji = (num) => ['〇', '一', '二', '三', '四', '五'][num] || String(num);

            const stages = state.stages || [];
            const alphaScore = stages.filter(s => s.winner === 'alpha').length;
            const bravoScore = stages.filter(s => s.winner === 'bravo').length;

            getEl('alpha-points').textContent = toKansuji(alphaScore);
            getEl('bravo-points').textContent = toKansuji(bravoScore);

            // 勝敗表示の更新
            const winEl = getEl('win');
            const matchPoint = bestOf === 'BO5' ? 3 : 2;
            winEl.className = 'progress'; // Reset classes
            getEl('main-section').querySelector('.alpha').classList.remove('loser-team');
            getEl('main-section').querySelector('.bravo').classList.remove('loser-team');
            getEl('alpha-points').classList.remove('alpha-points-loser');
            getEl('bravo-points').classList.remove('bravo-points-loser');

            if (alphaScore >= matchPoint) {
                winEl.classList.add('alpha-win');
                getEl('main-section').querySelector('.bravo').classList.add('loser-team');
                getEl('bravo-points').classList.add('bravo-points-loser');
            } else if (bravoScore >= matchPoint) {
                winEl.classList.add('bravo-win');
                getEl('main-section').querySelector('.alpha').classList.add('loser-team');
                getEl('alpha-points').classList.add('alpha-points-loser');
            }

            // ステージ画像の更新
            const stageContainer = getEl('stage-section');
            stageContainer.innerHTML = '';
            const numGames = bestOf === 'BO5' ? 5 : 3;

            for (let i = 0; i < numGames; i++) {
                const game = stages[i] || {};
                const stageName = game.stage || '未決定';
                let folder = 'stage-image';
                if (game.winner === 'alpha') folder = 'stage-alph';
                if (game.winner === 'bravo') folder = 'stage-bravo';

                const img = document.createElement('img');
                img.className = 'stage';
                img.src = `../${folder}/${stageName}.png`;
                img.onerror = () => { img.src = '../stage-image/未決定.png'; };
                stageContainer.appendChild(img);
            }
        }

        // --- Firestoreのデータ監視 ---
        sessionDocRef.onSnapshot(
            (doc) => {
                if (doc.exists) {
                    updateDisplay(doc.data());
                } else {
                    console.log("No such document!");
                }
            },
            (error) => {
                console.log("Error getting document:", error);
            }
        );
    </script>
</body>

</html>