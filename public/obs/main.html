<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情報画面</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Kosugi&family=Shippori+Mincho+B1&family=WDXL+Lubrifont+JP+N&family=Yuji+Syuku&family=Yusei+Magic&family=Zen+Antique+Soft&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --color-white-bg: #f5f5f5;
            --color-main-bg: #dfd3b2;
            --color-accent: #6d5d38;
            --color-black: #000000;
            --color-gradient-1: #293868;
            --color-gradient-2: #33698D;
            --color-gradient-3: #34918B;
            --color-alpha: #b0b32c;
            --color-bravo: #9054c2;

            --color-alpha-light: #f9f8e6;
            --color-bravo-light: #f6f0fa;

            --font-yuji: "Yuji Syuku", serif;
            --font-WDXL: "WDXL Lubrifont JP N", sans-serif;
            --font-zen-antique: "Zen Antique Soft", serif;
            --font-kosugi: "Kosugi", sans-serif;
            --font-shippori-mincho: "Shippori Mincho B1", serif;
            --font-yusei-magic: "Yusei Magic", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            font-weight: 400;
            font-style: normal;
            line-height: 1;
            font-family: var(--font-kosugi);
        }

        html {
            background-color: transparent;
        }

        #layout-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            width: 1880px;
            height: 1040px;
            padding: 20px;
            background-color: var(--color-main-bg);
        }

        #main-panel {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 1040px;
            overflow: hidden;
            background-color: var(--color-white-bg);
            border-radius: 40px;

            #title-bar {
                position: relative;
                display: flex;
                justify-content: center;
                flex-shrink: 0;
                z-index: 150;

                h1 {
                    z-index: 2;
                    padding: 0 40px 25px;
                    font-family: var(--font-yuji);
                    font-size: 65px;
                    background-color: var(--color-main-bg);

                    &:first-child {
                        border-bottom-left-radius: 40px;
                    }

                    &:last-child {
                        border-bottom-right-radius: 40px;
                    }
                }

                &::after {
                    position: absolute;
                    content: "";
                    width: 100%;
                    height: 75%;
                    background: repeating-linear-gradient(to right, var(--color-gradient-1) 0% 4%, var(--color-gradient-2) 4% 8%, var(--color-gradient-3) 8% 12%);
                }
            }

            .view-section {
                display: none;
                flex-direction: column;
                flex-grow: 1;
                width: 100%;
                position: relative;
            }

            .view-section.active {
                display: flex;
            }

            /* --- トラブル画面 (全画面オーバーレイ：配信トラブル用) --- */
            #trouble-overlay {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(40, 40, 40, 0.95);
                z-index: 999;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
            }

            #trouble-overlay.show {
                display: flex;
            }

            .trouble-title {
                font-family: var(--font-zen-antique);
                font-size: 80px;
                margin-bottom: 20px;
                color: #ffdd00;
                text-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
            }

            .trouble-message {
                font-family: var(--font-yuji);
                font-size: 40px;
            }

            /* --- 対戦画面 (Battle View) & 共通ヘッダー --- */
            #view-battle {
                padding-top: 30px;
                box-sizing: border-box;
            }

            #scoreboard-header,
            .shared-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0 40px;
                width: 100%;
                box-sizing: border-box;
                margin-top: 10px;
                margin-bottom: 10px;
                flex-shrink: 0;
                gap: 15px;
                transition: opacity 0.5s;
            }

            .round-info-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;

                span {
                    font-family: var(--font-yuji);
                    color: var(--color-black);
                }

                .round-name {
                    font-size: 36px;
                }

                .bo-count {
                    font-size: 24px;
                    opacity: 0.6;
                }
            }

            .teams-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            .team-info-block {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                width: 0;
                min-width: 0;
                transition: filter 0.5s, opacity 0.5s;

                h3 {
                    font-family: var(--font-yuji);
                    font-size: 26px;
                    margin-bottom: 10px;
                    opacity: 0.8;
                }

                h2 {
                    font-family: var(--font-zen-antique);
                    font-size: 50px;
                    line-height: 1.1;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    width: 100%;
                }
            }

            .alpha-side {
                align-items: flex-end;
                text-align: right;

                h2 {
                    color: var(--color-alpha);
                }
            }

            .bravo-side {
                align-items: flex-start;
                text-align: left;

                h2 {
                    color: var(--color-bravo);
                }
            }

            .score-container {
                flex: 0 0 auto;
                display: flex;
                align-items: center;
                gap: 20px;
                margin: 0 20px;

                .team-score {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 90px;
                    height: 90px;
                    color: var(--color-white-bg);
                    font-size: 75px;
                    font-family: var(--font-zen-antique);
                    border-radius: 15px;
                    line-height: 1;
                    padding-bottom: 8px;
                    box-sizing: border-box;
                }

                #alpha-score,
                .team-score-alpha {
                    background-color: var(--color-alpha);
                }

                #bravo-score,
                .team-score-bravo {
                    background-color: var(--color-bravo);
                }
            }

            #teams-container {
                display: flex;
                margin: 0;
                flex-grow: 1;
                align-items: flex-start;
                padding-top: 20px;
                gap: 0;
            }

            .team-panel {
                width: 100%;
                display: flex;
                flex-direction: column;
                transition: filter 0.5s, opacity 0.5s;

                .member-list {
                    display: flex;
                    flex-direction: column;
                    gap: 25px;
                }

                p {
                    width: fit-content;
                    padding: 0 20px 10px;
                    border-bottom: solid 4px var(--color-accent);
                    font-size: 65px;
                    font-family: var(--font-shippori-mincho);
                    font-weight: bold;
                }

                &:first-child {
                    padding-left: 80px;
                }

                &:last-child {
                    padding-right: 80px;
                }

                .average-xp {
                    padding: 10px 20px;
                    font-family: var(--font-WDXL);
                    color: var(--color-white-bg);
                    font-size: 40px;
                    text-align: center;
                    opacity: 0.9;

                    span {
                        font-family: var(--font-kosugi);
                        font-weight: bold;
                    }
                }
            }

            #team-alpha {
                align-items: flex-end;
                padding-right: 110px;

                .member-list {
                    align-items: flex-end;
                }

                p {
                    text-align: right;
                    border-image: linear-gradient(to left, #b0b32c 0% 50%, #dfd3b2 50% 100%) 1;
                }

                .average-xp {
                    margin: 40px 0 0 auto;
                    box-sizing: border-box;
                    border: solid 4px var(--color-alpha);
                    border-left: none;
                    border-image: linear-gradient(to top, #b0b32c 0% 60%, transparent 60% 100%) 1;
                    color: var(--color-alpha);
                }
            }

            #team-bravo {
                align-items: flex-start;
                padding-left: 110px;

                .member-list {
                    align-items: flex-start;
                }

                p {
                    text-align: left;
                    border-image: linear-gradient(to right, #9054c2 0% 50%, #dfd3b2 50% 100%) 1;
                }

                .average-xp {
                    margin: 40px auto 0 0;
                    box-sizing: border-box;
                    border: solid 4px var(--color-bravo);
                    border-right: none;
                    border-left: solid 4px var(--color-bravo);
                    border-image: linear-gradient(to top, #9054c2 0% 60%, transparent 60% 100%) 1;
                    color: var(--color-bravo);
                }
            }

            /* --- ステージプレビュー (前回/次回) --- */
            .stage-preview-card {
                position: absolute;
                bottom: 80px;
                width: 220px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 15px;
                padding: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                border: 2px solid #ccc;
                z-index: 20;
                transition: opacity 0.3s, transform 0.3s;
                opacity: 0;
                pointer-events: none;
            }

            .stage-preview-card.show {
                opacity: 1;
                pointer-events: auto;
            }

            .stage-preview-card.left {
                left: 40px;
            }

            .stage-preview-card.right {
                right: 40px;
            }

            .stage-preview-card img {
                width: 100%;
                aspect-ratio: 40/31;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid #eee;
            }

            .stage-preview-card .game-num {
                font-family: var(--font-yuji);
                font-size: 26px;
                font-weight: bold;
                color: var(--color-black);
                margin-bottom: 5px;
                text-align: center;
                width: 100%;
                border-bottom: 2px solid var(--color-accent);
                line-height: 1.2;
            }

            /* --- チーム詳細ビュー (Detail View) --- */
            .team-detail-wrapper {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                padding: 20px 80px 80px;
                box-sizing: border-box;
            }

            .detail-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 20px;
                text-align: center;
                transition: transform 0.2s;
            }

            .detail-clickable {
                cursor: pointer;
            }

            .detail-clickable:hover {
                transform: scale(1.02);
                opacity: 0.9;
            }

            .detail-univ-circle {
                font-family: var(--font-yuji);
                font-size: 32px;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .detail-team-name {
                font-family: var(--font-zen-antique);
                font-size: 65px;
                line-height: 1.1;
                margin-bottom: 10px;
            }

            .detail-avg-xp {
                font-family: var(--font-WDXL);
                font-size: 32px;
                padding: 5px 20px;
                background-color: var(--color-accent);
                color: var(--color-white-bg);
                border-radius: 50px;
            }

            .detail-content {
                display: flex;
                gap: 50px;
                flex-grow: 1;
                height: 0;
            }

            .info-column {
                flex: 4;
                display: flex;
                flex-direction: column;
                gap: 20px;
                overflow-y: auto;
            }

            .info-box {
                background-color: rgba(255, 255, 255, 0.8);
                border: 2px solid var(--color-accent);
                border-radius: 20px;
                padding: 25px;
                display: flex;
                flex-direction: column;
                box-shadow: none;
                height: fit-content;
                transition: transform 0.2s, background-color 0.2s;
            }

            .info-box.detail-clickable:hover {
                transform: scale(1.02);
                background-color: rgba(255, 255, 255, 0.95);
            }

            .info-title {
                font-family: var(--font-yuji);
                font-size: 26px;
                margin-bottom: 15px;
                border-bottom: 2px dashed var(--color-accent);
                padding-bottom: 5px;
                color: var(--color-accent);
            }

            .info-text {
                font-family: var(--font-shippori-mincho);
                font-size: 30px;
                line-height: 1.6;
                white-space: pre-wrap;
            }

            .player-column {
                flex: 5;
                display: flex;
                flex-direction: column;
                gap: 15px;
                overflow-y: auto;
            }

            .detail-player-card {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background-color: #ffffff;
                border: 2px solid #ccc;
                padding: 15px 25px;
                border-radius: 15px;
                box-shadow: none;
                position: relative;
                overflow: hidden;
            }

            .player-main-info {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0;
                width: 100%;
            }

            .detail-player-name {
                font-family: var(--font-zen-antique);
                font-size: 42px;
                line-height: 1.2;
            }

            .detail-player-weapon {
                font-family: var(--font-kosugi);
                font-size: 22px;
                color: #666;
                margin-top: 5px;
            }

            .xp-leader-badge {
                position: absolute;
                top: 50%;
                right: 20px;
                transform: translateY(-50%);
                background-color: #ffd700;
                color: #8b6914;
                font-family: 'Material Symbols Rounded';
                font-size: 40px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: 2px solid #fff;
                box-shadow: none;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1;
            }

            .alpha-theme .detail-team-name {
                color: var(--color-alpha);
            }

            .alpha-theme .detail-avg-xp {
                background-color: var(--color-alpha);
                color: #fff;
            }

            .alpha-theme .info-box {
                border-color: var(--color-alpha);
                background-color: var(--color-alpha-light);
            }

            .alpha-theme .info-title {
                color: var(--color-alpha);
                border-bottom-color: var(--color-alpha);
            }

            .alpha-theme .detail-player-card {
                border-color: var(--color-alpha);
                background-color: #fff;
                border-left: 15px solid var(--color-alpha);
            }

            .bravo-theme .detail-team-name {
                color: var(--color-bravo);
            }

            .bravo-theme .detail-avg-xp {
                background-color: var(--color-bravo);
                color: #fff;
            }

            .bravo-theme .info-box {
                border-color: var(--color-bravo);
                background-color: var(--color-bravo-light);
            }

            .bravo-theme .info-title {
                color: var(--color-bravo);
                border-bottom-color: var(--color-bravo);
            }

            .bravo-theme .detail-player-card {
                border-color: var(--color-bravo);
                background-color: #fff;
                border-left: 15px solid var(--color-bravo);
            }

            /* --- ステージ情報 (Stage View) --- */
            #view-stages {
                padding-top: 30px;
                box-sizing: border-box;
            }

            #stage-slots-container {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                gap: 20px;
                width: 100%;
                flex-grow: 1;
                padding-top: 100px;
                padding-bottom: 80px;
            }

            .stage-unit {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .stage-unit:hover {
                transform: scale(1.05);
            }

            .stage-slot-image-box {
                width: 280px;
                aspect-ratio: 40 / 31;
                border: 4px solid #ccc;
                border-radius: 20px;
                overflow: hidden;
                background-color: #fff;
            }

            .stage-unit:hover .stage-slot-image-box {
                border-color: var(--color-accent);
            }

            .stage-slot-image-box img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .stage-slot-label-outside {
                font-family: var(--font-yuji);
                font-size: 30px;
                color: #333;
                font-weight: bold;
            }

            /* --- オーバーレイ (ステージ一覧・サークル情報) --- */
            .overlay-container {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(245, 245, 245, 0.98);
                z-index: 140;
                flex-direction: column;
                align-items: center;
                padding: 40px 30px 100px;
                box-sizing: border-box;
                overflow-y: auto;
            }

            .overlay-container.show {
                display: flex;
            }

            .overlay-title {
                font-family: var(--font-zen-antique);
                font-size: 40px;
                margin-bottom: 20px;
                color: var(--color-gradient-1);
                border-bottom: 4px solid var(--color-accent);
                padding-bottom: 5px;
            }

            /* ステージ一覧用 */
            #stages-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 12px;
                width: 100%;
                max-width: 1700px;
            }

            .overlay-stage-item {
                aspect-ratio: 40 / 31;
                border-radius: 8px;
                overflow: hidden;
                position: relative;
                border: 2px solid #ddd;
            }

            .overlay-stage-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .overlay-stage-item.winner-alpha {
                border-color: var(--color-alpha);
                border-width: 4px;
            }

            .overlay-stage-item.winner-bravo {
                border-color: var(--color-bravo);
                border-width: 4px;
            }

            /* サークル情報用 */
            #circle-info-card {
                background-color: #fff;
                width: 80%;
                max-width: 1000px;
                border-radius: 30px;
                padding: 40px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                margin: auto;
                /* 上下中央寄せ */
            }

            .circle-info-top {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                border-bottom: 2px solid #eee;
                padding-bottom: 20px;
                width: 100%;
            }

            .circle-icon {
                width: 150px;
                height: 150px;
                border-radius: 50%;
                border: 5px solid var(--color-accent);
                object-fit: cover;
            }

            .circle-name-area {
                text-align: center;
            }

            .circle-univ-name {
                font-family: var(--font-yuji);
                font-size: 30px;
                color: #666;
            }

            .circle-main-name {
                font-family: var(--font-zen-antique);
                font-size: 60px;
                line-height: 1.1;
            }

            .circle-tags {
                display: flex;
                gap: 15px;
            }

            .circle-tag {
                font-family: var(--font-kosugi);
                font-size: 20px;
                padding: 5px 15px;
                background-color: #f0f0f0;
                border-radius: 20px;
                color: #555;
            }

            .circle-comment-area {
                font-family: var(--font-shippori-mincho);
                font-size: 28px;
                line-height: 1.8;
                text-align: center;
                white-space: pre-wrap;
            }


            /* --- タブナビゲーション --- */
            #tabs-nav {
                display: flex;
                justify-content: center;
                gap: 20px;
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                z-index: 150;
                /* オーバーレイ(140)より上 */
            }

            #tabs-nav::before {
                position: absolute;
                content: "";
                background-color: var(--color-accent);
                width: 100%;
                height: 60px;
                bottom: 0;
                left: 0;
            }

            .tab-item {
                z-index: 152;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 20px;
                padding: 10px 40px;
                border-radius: 100px;
                color: var(--color-white-bg);
                background-color: var(--color-accent);
                cursor: pointer;
                transition: transform 0.1s;
            }

            .tab-item:active {
                transform: scale(0.95);
            }

            .tab-item .material-symbols-rounded {
                font-family: 'Material Symbols Rounded';
                font-weight: normal;
                font-style: normal;
                font-size: 50px;
                line-height: 1;
            }

            .tab-item.active {
                color: var(--color-accent) !important;
                background-color: var(--color-main-bg) !important;
                border: solid 6px var(--color-accent);
            }

            #alpha-team-icon.active {
                color: var(--color-alpha) !important;
                border-color: var(--color-alpha);
            }

            #bravo-team-icon.active {
                color: var(--color-bravo) !important;
                border-color: var(--color-bravo);
            }

            #alpha-team-icon {
                background-color: var(--color-alpha);
                color: var(--color-white-bg);
            }

            #bravo-team-icon {
                background-color: var(--color-bravo);
                color: var(--color-white-bg);
            }

            /* --- 勝敗演出 --- */
            .team-lost {
                filter: grayscale(100%);
                opacity: 0.4;
            }

            .win-indicator {
                position: absolute;
                top: 220px;
                font-family: var(--font-zen-antique);
                font-size: 120px;
                font-weight: bold;
                line-height: 1;
                opacity: 0;
                transform: scale(0.5);
                transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                pointer-events: none;
                z-index: 10;
            }

            .win-indicator.show {
                opacity: 1;
                transform: scale(1);
            }

            #win-alpha {
                left: 60px;
                color: var(--color-alpha);
                text-shadow: 6px 6px 0px #fff, 0 0 20px rgba(208, 190, 8, 0.3);
            }

            #win-bravo {
                right: 60px;
                color: var(--color-bravo);
                text-shadow: 6px 6px 0px #fff, 0 0 20px rgba(58, 12, 205, 0.3);
            }
        }

        /* --- サイドバー --- */
        #sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        #sidebar #clock {
            padding: 5px 15px;
        }

        #sidebar .sidebar-card {
            width: 200px;
            padding: 15px;
            text-align: center;
            background-color: var(--color-white-bg);
            border-radius: 40px;
        }

        #sidebar .sidebar-card p {
            margin-bottom: 10px;
            color: var(--color-accent);
            font-size: 30px;
            font-family: var(--font-yuji);
        }

        #sidebar .sidebar-card h2 {
            margin-top: 10px;
            color: var(--color-gradient-2);
            font-size: 40px;
            font-family: var(--font-zen-antique);
        }

        #sidebar .sidebar-card img {
            width: 160px;
            height: 160px;
            border: 4px solid var(--color-gradient-2);
            box-sizing: border-box;
            border-radius: 40px;
        }

        #sidebar .sidebar-card .time {
            width: 100%;
            margin: 10px 0;
            color: var(--color-gradient-2);
            font-family: var(--font-WDXL);
            font-size: 55px;
        }

        #sidebar #status-message {
            writing-mode: vertical-rl;
            font-family: var(--font-yuji);
            font-size: 55px;
            line-height: 1.25;
        }

        #sidebar #event-logo {
            width: 200px;
            margin-top: auto;
            margin-bottom: 20px;
            transition: opacity 1s ease-in-out;
            opacity: 1;
        }

        /* サイドバーのトラブル表示カード (修正版) */
        #sidebar-trouble {
            display: none;
            padding: 10px 15px;
            background-color: #ffffff !important;
            border: 3px solid #ff4444 !important;
        }

        #sidebar-trouble.show {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #sidebar-trouble h2 {
            font-size: 24px !important;
            margin: 0;
            color: #d32f2f !important;
        }
    </style>
</head>

<body>
    <main id="layout-container">
        <div id="main-panel">
            <div id="title-bar">
                <h1>大学杯真打 本戦配信</h1>
            </div>

            <div id="view-battle" class="view-section active">
                <div id="scoreboard-header">
                    <div class="round-info-container">
                        <span class="round-name" id="round-info">--</span>
                        <span class="bo-count">--</span>
                    </div>
                    <div class="teams-row">
                        <div class="team-info-block alpha-side">
                            <h3>---/---</h3>
                            <h2 id="alpha-team-name">---</h2>
                        </div>
                        <div class="score-container">
                            <div id="alpha-score" class="team-score">0</div>
                            <div id="bravo-score" class="team-score">0</div>
                        </div>
                        <div class="team-info-block bravo-side">
                            <h3>---/---</h3>
                            <h2 id="bravo-team-name">---</h2>
                        </div>
                    </div>
                </div>
                <div id="teams-container">
                    <div id="team-alpha" class="team-panel">
                        <div class="member-list"></div>
                        <p class="average-xp"><span>平均XP</span>：-</p>
                    </div>
                    <div id="team-bravo" class="team-panel">
                        <div class="member-list"></div>
                        <p class="average-xp"><span>平均XP</span>：-</p>
                    </div>
                </div>

                <div id="win-alpha" class="win-indicator">WIN</div>
                <div id="win-bravo" class="win-indicator">WIN</div>

                <div id="prev-stage-info" class="stage-preview-card left">
                    <div class="game-num" id="prev-game-num"></div>
                    <img src="" id="prev-stage-img" onerror="this.style.display='none'">
                </div>
                <div id="next-stage-info" class="stage-preview-card right">
                    <div class="game-num" id="next-game-num"></div>
                    <img src="" id="next-stage-img" onerror="this.style.display='none'">
                </div>
            </div>

            <div id="view-alpha" class="view-section alpha-theme">
                <div class="team-detail-wrapper">
                    <div class="detail-header" id="alpha-detail-header">
                        <div class="detail-univ-circle" id="alpha-detail-univ">大学名/サークル名</div>
                        <h1 class="detail-team-name" id="alpha-detail-name">チーム名</h1>
                        <div class="detail-avg-xp" id="alpha-detail-avg">平均XP: ----</div>
                    </div>
                    <div class="detail-content">
                        <div class="info-column">
                            <div class="info-box" id="alpha-info-records">
                                <h3 class="info-title">実績</h3>
                                <p class="info-text" id="alpha-detail-records">-</p>
                            </div>
                            <div class="info-box" id="alpha-info-comment">
                                <h3 class="info-title">意気込み</h3>
                                <p class="info-text" id="alpha-detail-comment">-</p>
                            </div>
                        </div>
                        <div class="player-column" id="alpha-detail-members"></div>
                    </div>
                </div>
            </div>

            <div id="view-bravo" class="view-section bravo-theme">
                <div class="team-detail-wrapper">
                    <div class="detail-header" id="bravo-detail-header">
                        <div class="detail-univ-circle" id="bravo-detail-univ">大学名/サークル名</div>
                        <h1 class="detail-team-name" id="bravo-detail-name">チーム名</h1>
                        <div class="detail-avg-xp" id="bravo-detail-avg">平均XP: ----</div>
                    </div>
                    <div class="detail-content">
                        <div class="info-column">
                            <div class="info-box" id="bravo-info-records">
                                <h3 class="info-title">実績</h3>
                                <p class="info-text" id="bravo-detail-records">-</p>
                            </div>
                            <div class="info-box" id="bravo-info-comment">
                                <h3 class="info-title">意気込み</h3>
                                <p class="info-text" id="bravo-detail-comment">-</p>
                            </div>
                        </div>
                        <div class="player-column" id="bravo-detail-members"></div>
                    </div>
                </div>
            </div>

            <div id="view-stages" class="view-section">
                <div class="shared-header" id="stage-view-header"></div>
                <div id="stage-slots-container"></div>
                <div id="stages-overlay" class="overlay-container"
                    onclick="window.updateStateFromView({subOp: 'image'})">
                    <h1 class="overlay-title">ステージ一覧</h1>
                    <div id="stages-grid" onclick="event.stopPropagation()"></div>
                </div>
            </div>

            <div id="circle-overlay" class="overlay-container" onclick="window.updateStateFromView({subOp: 'details'})">
                <h1 class="overlay-title">サークル情報</h1>
                <div id="circle-info-card" onclick="event.stopPropagation()">
                    <div class="circle-info-top">
                        <img src="" id="circle-img" class="circle-icon" onerror="this.style.display='none'">
                        <div class="circle-name-area">
                            <div class="circle-univ-name" id="circle-univ"></div>
                            <div class="circle-main-name" id="circle-name"></div>
                        </div>
                        <div class="circle-tags">
                            <span class="circle-tag" id="circle-id"></span>
                            <span class="circle-tag" id="circle-win"></span>
                        </div>
                    </div>
                    <div class="circle-comment-area" id="circle-comment"></div>
                </div>
            </div>

            <div id="trouble-overlay">
                <div class="trouble-title">SYSTEM TROUBLE</div>
                <div class="trouble-message" id="trouble-text">しばらくお待ちください</div>
            </div>

            <nav id="tabs-nav">
                <span id="battle-icon" class="tab-item active" data-target="main-matchup"><span
                        class="material-symbols-rounded">swords</span></span>
                <span id="alpha-team-icon" class="tab-item" data-target="main-alpha"><span
                        class="material-symbols-rounded">person_search</span></span>
                <span id="bravo-team-icon" class="tab-item" data-target="main-bravo"><span
                        class="material-symbols-rounded">person_search</span></span>
                <span id="stages-icon" class="tab-item" data-target="main-stage"><span
                        class="material-symbols-rounded">distance</span></span>
            </nav>
        </div>

        <div id="sidebar">
            <div id="clock" class="sidebar-card">
                <p id="clock-display" class="time">00 : 00</p>
            </div>

            <div id="sidebar-trouble" class="sidebar-card">
                <h2 id="sidebar-trouble-msg">対応中</h2>
            </div>

            <div class="sidebar-card">
                <p>実況</p><img src="https://pbs.twimg.com/profile_images/1902854610894954496/Cer1RMih_400x400.jpg">
                <h2>たじふ</h2>
            </div>
            <div class="sidebar-card">
                <p>解説</p><img src="https://pbs.twimg.com/profile_images/1898290320850452480/s5VHfldw_400x400.jpg">
                <h2>ブラウド</h2>
            </div>
            <img id="event-logo" src="../icons/大学杯真打ロゴ.png">
        </div>
    </main>

    <script>
        const updateClock = () => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock-display').innerHTML = `${h} : ${m}`;
        };
        updateClock();
        setInterval(updateClock, 1000);

        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-item');
            const views = document.querySelectorAll('.view-section');
            const overlays = document.querySelectorAll('.overlay-container');
            const troubleOverlay = document.getElementById('trouble-overlay');

            // タブのIDと表示するViewのIDの対応マップ
            const viewMap = {
                'main-matchup': 'view-battle',
                'main-alpha': 'view-alpha',
                'main-bravo': 'view-bravo', // main-beta -> main-bravo
                'main-stage': 'view-stages'
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const targetKey = tab.getAttribute('data-target');
                    const targetViewId = viewMap[targetKey];

                    views.forEach(v => v.classList.remove('active'));
                    if (targetViewId) {
                        const targetView = document.getElementById(targetViewId);
                        if (targetView) targetView.classList.add('active');
                    }

                    overlays.forEach(o => o.classList.remove('show'));
                    if (troubleOverlay) troubleOverlay.classList.remove('show');

                    if (window.updateStateFromView) {
                        window.updateStateFromView({ mainOp: targetKey, subOp: 'none' });
                    }
                });
            });

            const logoImg = document.getElementById('event-logo');
            const sources = ["../icons/大学杯真打ロゴ.png", "../icons/大学杯QR.png"];
            let currentLogoIndex = 0;
            setInterval(() => {
                logoImg.style.opacity = 0;
                setTimeout(() => {
                    currentLogoIndex = (currentLogoIndex + 1) % sources.length;
                    logoImg.src = sources[currentLogoIndex];
                    logoImg.style.opacity = 1;
                }, 1000);
            }, 8000);
        });

        window.updateStateFromView = function (updates) {
            const event = new CustomEvent('requestUpdateState', { detail: updates });
            window.dispatchEvent(event);
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const broadcastRef = doc(db, "state", "broadcast");

        let teamsData = [];
        let stagesData = [];
        let circleData = [];
        let lastMatchState = {};

        async function loadData() {
            try {
                const teamsRes = await fetch('../json/teams.json');
                teamsData = await teamsRes.json();
                const stagesRes = await fetch('../json/stages.json');
                stagesData = await stagesRes.json();
                const circlesRes = await fetch('../json/circle-info.json');
                circleData = await circlesRes.json();
            } catch (e) { console.error("Load failed", e); }
        }

        const opMap = {
            'main-matchup': 'view-battle',
            'main-alpha': 'view-alpha',
            'main-bravo': 'view-bravo', // main-beta -> main-bravo
            'main-stage': 'view-stages'
        };

        function handleBroadcastState(data) {
            const troubleOverlay = document.getElementById('trouble-overlay');
            const troubleText = document.getElementById('trouble-text');
            const sidebarTrouble = document.getElementById('sidebar-trouble');
            const sidebarMsg = document.getElementById('sidebar-trouble-msg');

            troubleOverlay.classList.remove('show');
            sidebarTrouble.classList.remove('show');

            if (data.trouble && data.trouble !== 'none') {
                if (data.trouble === 'stream') {
                    troubleText.textContent = "配信トラブル対応中";
                    troubleOverlay.classList.add('show');
                } else {
                    let msg = "トラブル";
                    if (data.trouble === 'lag') msg = "ラグ対応中";
                    else if (data.trouble === 'admin') msg = "運営対応中";
                    sidebarMsg.textContent = msg;
                    sidebarTrouble.classList.add('show');
                }
            }

            const targetViewId = opMap[data.mainOp] || 'view-battle';
            switchTab(targetViewId);

            const circleOverlay = document.getElementById('circle-overlay');
            const stagesOverlay = document.getElementById('stages-overlay');

            circleOverlay.classList.remove('show');
            stagesOverlay.classList.remove('show');

            if (data.mainOp === 'main-alpha' || data.mainOp === 'main-bravo') { // main-beta -> main-bravo
                if (data.subOp === 'circle') {
                    const teamId = (data.mainOp === 'main-alpha') ? lastMatchState.alphaTeamId : lastMatchState.bravoTeamId;
                    const team = teamsData.find(t => String(t.id) === String(teamId));
                    if (team && team.circle) {
                        const info = circleData.find(c => c['circle-name'] === team.circle);
                        if (info) {
                            populateCircleInfo(info);
                            circleOverlay.classList.add('show');
                        }
                    }
                }
            } else if (data.mainOp === 'main-stage') {
                if (data.subOp === 'list') {
                    stagesOverlay.classList.add('show');
                }
            }
        }

        function switchTab(viewId) {
            const currentView = document.querySelector('.view-section.active');
            if (currentView && currentView.id === viewId) return;

            const tabs = document.querySelectorAll('.tab-item');
            tabs.forEach(t => {
                const targetOp = Object.keys(opMap).find(key => opMap[key] === viewId);
                if (t.getAttribute('data-target') === targetOp) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            const views = document.querySelectorAll('.view-section');
            views.forEach(v => v.classList.remove('active'));
            const target = document.getElementById(viewId);
            if (target) target.classList.add('active');
        }

        function populateCircleInfo(info) {
            const img = document.getElementById('circle-img');
            if (info['circle-social-img']) {
                img.src = info['circle-social-img']; img.style.display = 'block';
            } else { img.style.display = 'none'; }
            document.getElementById('circle-univ').textContent = info['circle-university'] || '';
            document.getElementById('circle-name').textContent = info['circle-name'] || '';
            document.getElementById('circle-id').textContent = info['circle-social-id'] ? `@${info['circle-social-id']}` : '';
            document.getElementById('circle-win').textContent = info['circle-social-win'] ? `#${info['circle-social-win']}` : '';
            document.getElementById('circle-comment').innerHTML = info['circle-comment'] || '';
        }

        window.addEventListener('requestUpdateState', async (e) => {
            const updates = e.detail;
            try {
                await setDoc(broadcastRef, updates, { merge: true });
            } catch (err) { console.error(err); }
        });

        function updateUI(matchState) {
            lastMatchState = matchState;
            document.getElementById('alpha-score').textContent = matchState.alphaScore;
            document.getElementById('bravo-score').textContent = matchState.bravoScore;
            document.getElementById('round-info').textContent = matchState.matchName || '試合情報なし';
            document.querySelector('.bo-count').textContent = matchState.boCount || '';

            updateTeam('alpha', matchState.alphaTeamId);
            updateTeam('bravo', matchState.bravoTeamId);
            checkWinner(matchState);
            updateTeamDetail('alpha', matchState.alphaTeamId);
            updateTeamDetail('bravo', matchState.bravoTeamId);
            updateStagesView(matchState);
            updateStagePreviews(matchState);
        }

        function checkWinner(matchState) {
            const winThreshold = (matchState.boCount === 'BO5') ? 3 : 2;
            const alphaWins = matchState.alphaScore >= winThreshold;
            const bravoWins = matchState.bravoScore >= winThreshold;

            const alphaHeader = document.querySelector('#view-battle .team-info-block.alpha-side');
            const alphaPanel = document.getElementById('team-alpha');
            const bravoHeader = document.querySelector('#view-battle .team-info-block.bravo-side');
            const bravoPanel = document.getElementById('team-bravo');
            const winAlphaEl = document.getElementById('win-alpha');
            const winBravoEl = document.getElementById('win-bravo');

            [alphaHeader, alphaPanel, bravoHeader, bravoPanel].forEach(el => { if (el) el.classList.remove('team-lost'); });
            winAlphaEl.classList.remove('show');
            winBravoEl.classList.remove('show');

            if (alphaWins) {
                if (bravoHeader) bravoHeader.classList.add('team-lost');
                if (bravoPanel) bravoPanel.classList.add('team-lost');
                winAlphaEl.classList.add('show');
            } else if (bravoWins) {
                if (alphaHeader) alphaHeader.classList.add('team-lost');
                if (alphaPanel) alphaPanel.classList.add('team-lost');
                winBravoEl.classList.add('show');
            }
        }

        function updateStagePreviews(matchState) {
            const games = matchState.games || [];
            const prevCard = document.getElementById('prev-stage-info');
            const nextCard = document.getElementById('next-stage-info');
            const gameLabels = ["第一戦", "第二戦", "第三戦", "第四戦", "第五戦"];
            const finishedCount = games.filter(g => g.winner !== 'none').length;

            if (finishedCount > 0) {
                const prevGame = games[finishedCount - 1];
                document.getElementById('prev-game-num').textContent = gameLabels[finishedCount - 1] || `GAME ${finishedCount}`;
                const img = document.getElementById('prev-stage-img');
                img.style.display = 'block';
                if (prevGame.winner === 'alpha') img.src = `../stage-alpha/${prevGame.stage}.png`;
                else if (prevGame.winner === 'bravo') img.src = `../stage-bravo/${prevGame.stage}.png`;
                else img.src = `../stage-image/${prevGame.stage}.png`;
                prevCard.classList.add('show');
            } else { prevCard.classList.remove('show'); }

            if (finishedCount < games.length) {
                const nextGame = games[finishedCount];
                document.getElementById('next-game-num').textContent = gameLabels[finishedCount] || `GAME ${finishedCount + 1}`;
                const img = document.getElementById('next-stage-img');
                img.style.display = 'block';
                img.src = `../stage-image/${nextGame.stage}.png`;
                nextCard.classList.add('show');
            } else { nextCard.classList.remove('show'); }
        }

        function updateStagesView(matchState) {
            const sourceHeader = document.getElementById('scoreboard-header');
            const targetHeader = document.getElementById('stage-view-header');
            if (sourceHeader && targetHeader) {
                targetHeader.innerHTML = sourceHeader.innerHTML;
                targetHeader.className = 'shared-header';
                const children = targetHeader.querySelectorAll('[id]');
                children.forEach(child => child.removeAttribute('id'));
                const aScore = targetHeader.querySelector('.team-score:first-child');
                const bScore = targetHeader.querySelector('.team-score:last-child');
                if (aScore) aScore.classList.add('team-score-alpha');
                if (bScore) bScore.classList.add('team-score-bravo');
            }
            const container = document.getElementById('stage-slots-container');
            container.innerHTML = '';
            const gameLabels = ["第一戦", "第二戦", "第三戦", "第四戦", "第五戦"];
            if (matchState.games && Array.isArray(matchState.games)) {
                matchState.games.forEach((game, index) => {
                    const unit = document.createElement('div');
                    unit.className = 'stage-unit';
                    unit.onclick = () => window.updateStateFromView({ subOp: 'list' });

                    let imgSrc = '../stage-image/未決定.png';
                    if (game.stage && game.stage !== '未決定') {
                        if (game.winner === 'alpha') imgSrc = `../stage-alpha/${game.stage}.png`;
                        else if (game.winner === 'bravo') imgSrc = `../stage-bravo/${game.stage}.png`;
                        else imgSrc = `../stage-image/${game.stage}.png`;
                    }
                    unit.innerHTML = `<div class="stage-slot-image-box"><img src="${imgSrc}" onerror="this.src='../stage-image/未決定.png'"></div><div class="stage-slot-label-outside">${gameLabels[index] || ('GAME ' + (index + 1))}</div>`;
                    container.appendChild(unit);
                });
            }
            renderStageOverlay(matchState);
        }

        function renderStageOverlay(matchState) {
            const grid = document.getElementById('stages-grid');
            grid.innerHTML = '';
            const playedStages = [];
            const normalStages = [];
            stagesData.forEach(stageName => {
                const playedGame = matchState.games ? matchState.games.find(g => g.stage === stageName && g.winner !== 'none') : null;
                if (playedGame) playedStages.push({ name: stageName, winner: playedGame.winner });
                else normalStages.push({ name: stageName, winner: null });
            });
            const allItems = [...playedStages, ...normalStages];
            allItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'overlay-stage-item';
                let imgSrc = `../stage-image/${item.name}.png`;
                if (item.winner === 'alpha') { imgSrc = `../stage-alpha/${item.name}.png`; div.classList.add('winner-alpha'); }
                else if (item.winner === 'bravo') { imgSrc = `../stage-bravo/${item.name}.png`; div.classList.add('winner-bravo'); }
                div.innerHTML = `<img src="${imgSrc}" onerror="this.src='../stage-image/未決定.png'">`;
                grid.appendChild(div);
            });
        }

        function updateTeam(side, teamId) {
            const team = teamsData.find(t => String(t.id) === String(teamId));
            const container = document.querySelector(`.${side}-side`);
            const panel = document.getElementById(`team-${side}`);
            if (!team) {
                if (container) { container.querySelector('h3').textContent = '---/---'; container.querySelector('h2').textContent = '未選択'; }
                if (panel) { panel.querySelector('.member-list').innerHTML = ''; panel.querySelector('.average-xp').innerHTML = '<span>平均XP</span>：-'; }
                return;
            }
            if (container) { container.querySelector('h3').textContent = `${team.university || ''}/${team.circle || ''}`; container.querySelector('h2').textContent = team.teamName; }
            if (panel) {
                const memberList = panel.querySelector('.member-list');
                memberList.innerHTML = '';
                for (let i = 1; i <= 4; i++) {
                    const name = team[`p${i}_name`];
                    if (name && name.trim() !== '----') {
                        const p = document.createElement('p'); p.textContent = name; memberList.appendChild(p);
                    }
                }
                const xpVal = team.team_average_xp && team.team_average_xp !== '----' ? team.team_average_xp : '-';
                panel.querySelector('.average-xp').innerHTML = `<span>平均XP</span>：${xpVal}`;
            }
        }

        function updateTeamDetail(side, teamId) {
            const team = teamsData.find(t => String(t.id) === String(teamId));
            const elName = document.getElementById(`${side}-detail-name`);
            if (!elName) return;
            const elUniv = document.getElementById(`${side}-detail-univ`);
            const elAvg = document.getElementById(`${side}-detail-avg`);
            const elRecords = document.getElementById(`${side}-detail-records`);
            const elComment = document.getElementById(`${side}-detail-comment`);
            const elMembers = document.getElementById(`${side}-detail-members`);
            const boxRecords = document.getElementById(`${side}-info-records`);
            const boxComment = document.getElementById(`${side}-info-comment`);
            const elHeader = document.getElementById(`${side}-detail-header`);

            if (!team) {
                elName.textContent = "チーム未選択"; elUniv.textContent = "---"; elAvg.textContent = "平均XP: -";
                elRecords.textContent = "-"; elComment.textContent = "-"; elMembers.innerHTML = "";
                return;
            }
            elName.textContent = team.teamName;
            elUniv.textContent = `${team.university || ''} / ${team.circle || ''}`;
            elAvg.textContent = `平均XP: ${team.team_average_xp || '-'}`;
            elRecords.textContent = team.records || 'なし';
            elComment.textContent = team.comment || 'なし';

            const circleName = team.circle;
            const hasCircleInfo = circleData.some(c => c['circle-name'] === circleName);

            if (hasCircleInfo) {
                elHeader.classList.add('detail-clickable');
                boxRecords.classList.add('detail-clickable');
                boxComment.classList.add('detail-clickable');
                const handler = () => window.updateStateFromView({ subOp: 'circle' });
                elHeader.onclick = handler;
                boxRecords.onclick = handler;
                boxComment.onclick = handler;
            } else {
                elHeader.classList.remove('detail-clickable');
                boxRecords.classList.remove('detail-clickable');
                boxComment.classList.remove('detail-clickable');
                elHeader.onclick = null; boxRecords.onclick = null; boxComment.onclick = null;
            }

            let maxXp = -1; let players = [];
            for (let i = 1; i <= 4; i++) {
                const name = team[`p${i}_name`];
                if (name && name.trim() !== '----') {
                    const xpStr = team[`p${i}_xp`]; let xpVal = parseFloat(xpStr);
                    if (isNaN(xpVal)) xpVal = -1; if (xpVal > maxXp) maxXp = xpVal;
                    players.push({ name: name, weapon: team[`p${i}_weapon`] || '-', xpValue: xpVal });
                }
            }
            elMembers.innerHTML = '';
            players.forEach(p => {
                const isLeader = (maxXp > 0 && p.xpValue === maxXp);
                const card = document.createElement('div'); card.className = 'detail-player-card';
                let leaderHtml = ''; if (isLeader) leaderHtml = '<span class="xp-leader-badge material-symbols-rounded">crown</span>';
                card.innerHTML = `${leaderHtml}<div class="player-main-info"><span class="detail-player-name">${p.name}</span><span class="detail-player-weapon">${p.weapon}</span></div>`;
                elMembers.appendChild(card);
            });
        }

        loadData().then(() => {
            onSnapshot(doc(db, "state", "match"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let alphaPoints = 0; let bravoPoints = 0;
                    if (data.games && Array.isArray(data.games)) {
                        data.games.forEach(game => {
                            if (game.winner === 'alpha') alphaPoints++;
                            if (game.winner === 'bravo') bravoPoints++;
                        });
                    }
                    const matchState = {
                        alphaTeamId: data.alphaTeamId,
                        bravoTeamId: data.bravoTeamId,
                        alphaScore: alphaPoints,
                        bravoScore: bravoPoints,
                        matchName: data.roundName,
                        boCount: data.boType,
                        games: data.games
                    };
                    updateUI(matchState);
                }
            });

            onSnapshot(broadcastRef, (docSnap) => {
                if (docSnap.exists()) {
                    handleBroadcastState(docSnap.data());
                }
            });
        });
    </script>
</body>

</html>