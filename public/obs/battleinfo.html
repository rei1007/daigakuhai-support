<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>対戦情報</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS Reset & Basic Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            overflow: hidden;
            background-color: transparent;
            font-family: 'Noto Sans JP', sans-serif;
            color: #E0E0E0;
        }

        /* --- Cyber x Wafu Design Theme --- */
        #screen {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #1A1A1A;
            padding: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%232a2a2a' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h40v40H0V0zm40 40h40v40H40V40zm0-40h2l-2 2V0zm0 40h2l-2 2V40zm-40 0h2l-2 2V40zm0-40h2l-2 2V0z'/%3E%3Cpath d='M0 40h40v40H0V40zm40-40h40v40H40V0z'/%3E%3C/g%3E%3C/svg%3E");
        }

        #screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.02) 50%, rgba(255, 255, 255, 0));
            background-size: 100% 4px;
            opacity: 0.5;
            pointer-events: none;
        }

        /* --- Main Layout --- */
        #main-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 60px;
        }

        /* --- Team Data Containers --- */
        .team-data {
            width: 700px;
            display: flex;
            flex-direction: column;
        }

        .univ-name {
            font-size: 50px;
            font-weight: 700;
            color: #CCCCCC;
            line-height: 1.1;
        }

        .circle-name {
            font-size: 40px;
            font-weight: 400;
            color: #999999;
            line-height: 1.1;
            margin-bottom: 10px;
        }

        .team-name {
            font-size: 60px;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1.8px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px, 0 0 20px;
        }

        .member {
            font-size: 50px;
            font-weight: 900;
            line-height: 1.2;
            color: #E0E0E0;
            margin: 0 15px;
        }

        hr {
            width: 80%;
            margin: 10px 0;
            border: none;
            height: 4px;
            background: linear-gradient(to right, currentColor, transparent);
        }

        .alpha-border {
            background: linear-gradient(to right, transparent, currentColor);
        }

        .xp-avg {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 45px;
            font-weight: 700;
            line-height: 1;
            color: #E0E0E0;
            text-align: center;
            background-color: #454545aa;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }

        /* Alpha Team Styles */
        .alpha {
            align-items: flex-end;
            text-align: right;
        }

        .alpha .team-name {
            color: #FFD700;
        }

        .alpha hr {
            color: #FFD700;
            margin-left: auto;
        }

        /* Bravo Team Styles */
        .bravo {
            align-items: flex-start;
            text-align: left;
        }

        .bravo .team-name {
            color: #a851ff;
        }

        .bravo hr {
            color: #a851ff;
            margin-right: auto;
        }

        /* Match Data Styles */
        #match-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            padding-top: 80px;
        }

        #round {
            font-size: 50px;
            font-weight: 900;
            line-height: 1.2;
            color: #CCCCCC;
            text-align: center;
        }

        #points {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            background-color: #454545aa;
            padding: 5px 60px;
            height: 150px;
            width: 320px;
            clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0 50%);
            border-top: solid 5px;
            border-image: linear-gradient(to right, #1a1a1a, #fff, #1a1a1a) 1;
            border-bottom: solid 5px;
        }

        #points-separator {
            font-size: 80px;
            font-weight: 700;
            color: #666;
            line-height: 1;
        }

        #alpha-points,
        #bravo-points {
            font-size: 100px;
            font-weight: 700;
            line-height: 1;
            transition: all 0.5s ease-in-out;
        }

        #alpha-points {
            color: #FFD700;
            text-shadow: 0 0 5px #FFD700, 0 0 20px #FFD700;
        }

        #bravo-points {
            color: #a851ff;
            text-shadow: 0 0 5px #a851ff, 0 0 20px #a851ff;
        }
        
        .alpha-points-loser, .bravo-points-loser {
            opacity: 0.6;
            text-shadow: none !important;
        }
        /* (ここまで) */


        #win {
            font-size: 80px;
            font-weight: 900;
            line-height: 1;
            text-align: center;
            text-shadow: 0 0 5px, 0 0 20px;
        }

        .progress {
            display: none;
        }

        .alpha-win {
            display: block;
            color: #FFD700;
        }

        .bravo-win {
            display: block;
            color: #a851ff;
        }

        /* Stage Section */
        #stage-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 45px;
        }

        .stage {
            width: 350px;
            clip-path: polygon(30px 0, 100% 0, 100% calc(100% - 30px), calc(100% - 30px) 100%, 0 100%, 0 30px);
        }

        /* Utility Styles */
        .highlight-color-text {
            color: #f19696 !important;
            text-shadow: 0 0 8px #f19696;
        }

        .loser-team {
            opacity: 0.4;
            filter: grayscale(50%);
            transition: all 0.5s ease-in-out;
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <main id="screen">
        <div id="main-section">
            <div class="team-data alpha">
                <p id="alpha-univ" class="univ-name">アルファ大学</p>
                <p id="alpha-circle" class="circle-name">アルファサークル</p>
                <h1 id="alpha-team-name" class="team-name">アルファチーム</h1>
                <h2 id="alpha-member1" class="member">アルファメンバー1</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member2" class="member">アルファメンバー2</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member3" class="member">アルファメンバー3</h2>
                <hr class="alpha-border">
                <h2 id="alpha-member4" class="member">アルファメンバー4</h2>
                <p id="alpha-xp-avg" class="xp-avg">平均XP：----</p>
            </div>
            <div id="match-data">
                <h1 id="round">ラウンド情報<br>BO3</h1>
                <div id="points">
                    <div id="alpha-points">0</div>
                    <div id="points-separator">:</div> <div id="bravo-points">0</div>
                </div>
                <div id="win" class="progress">WIN</div>
            </div>
            <div class="team-data bravo">
                <p id="bravo-univ" class="univ-name">ブラボー大学</p>
                <p id="bravo-circle" class="circle-name">ブラボーサークル</p>
                <h1 id="bravo-team-name" class="team-name">ブラボーチーム</h1>
                <h2 id="bravo-member1" class="member">ブラボーメンバー1</h2>
                <hr>
                <h2 id="bravo-member2" class="member">ブラボーメンバー2</h2>
                <hr>
                <h2 id="bravo-member3" class="member">ブラボーメンバー3</h2>
                <hr>
                <h2 id="bravo-member4" class="member">ブラボーメンバー4</h2>
                <p id="bravo-xp-avg" class="xp-avg">平均XP：----</p>
            </div>
        </div>

        <div id="stage-section">
            <img class="stage" src="../stage-image/未決定.png">
            <img class="stage" src="../stage-image/未決定.png">
            <img class="stage" src="../stage-image/未決定.png">
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.appspot.com",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sessionDocRef = db.collection('sessions').doc('daigakuhai-support-v1');

        let teamsData = [];

        const getEl = (id) => document.getElementById(id);

        function formatPlayerName(player, maxXP, side) {
            if (!player || !player.name) return '';
            let name = player.name;
            if (player.xp && player.xp > 0 && player.xp === maxXP) {
                name = (side === 'alpha') ? `★ ${name}` : `${name} ★`;
            }
            return name;
        }

        function applyXpHighlight(element, xp) {
            element.classList.remove('highlight-color-text');
            if (xp >= 3200) {
                element.classList.add('highlight-color-text');
            }
        }

        async function updateDisplay(state) {
            if (teamsData.length === 0) {
                try {
                    // ★変更点: ファイルパス修正
                    const res = await fetch('../teams.json');
                    teamsData = await res.json();
                } catch (e) {
                    console.error("teams.jsonの読み込みに失敗しました。", e);
                    return;
                }
            }

            const alphaTeam = teamsData.find(t => t.id === state.matchup?.alphaTeamId);
            const bravoTeam = teamsData.find(t => t.id === state.matchup?.bravoTeamId);

            if (alphaTeam) {
                const players = [alphaTeam.p1, alphaTeam.p2, alphaTeam.p3, alphaTeam.p4].map((p, i) => ({ name: alphaTeam[`p${i + 1}_name`], xp: Number(alphaTeam[`p${i + 1}_xp`]) })).filter(p => p.name && p.xp);
                const maxXP = players.length > 0 ? Math.max(...players.map(p => p.xp)) : 0;
                let totalXP = 0;

                getEl('alpha-univ').textContent = alphaTeam.university;
                getEl('alpha-circle').textContent = alphaTeam.circle;
                getEl('alpha-team-name').textContent = alphaTeam.teamName;

                for (let i = 0; i < 4; i++) {
                    const player = players[i];
                    const el = getEl(`alpha-member${i + 1}`);
                    if (player) {
                        el.textContent = formatPlayerName(player, maxXP, 'alpha');
                        applyXpHighlight(el, player.xp);
                        totalXP += player.xp;
                    } else {
                        el.textContent = '';
                    }
                }
                const avgXP = players.length > 0 ? (totalXP / players.length).toFixed(1) : '----';
                getEl('alpha-xp-avg').textContent = `平均XP：${avgXP}`;
                applyXpHighlight(getEl('alpha-xp-avg'), parseFloat(avgXP));
            }

            if (bravoTeam) {
                const players = [bravoTeam.p1, bravoTeam.p2, bravoTeam.p3, bravoTeam.p4].map((p, i) => ({ name: bravoTeam[`p${i + 1}_name`], xp: Number(bravoTeam[`p${i + 1}_xp`]) })).filter(p => p.name && p.xp);
                const maxXP = players.length > 0 ? Math.max(...players.map(p => p.xp)) : 0;
                let totalXP = 0;

                getEl('bravo-univ').textContent = bravoTeam.university;
                getEl('bravo-circle').textContent = bravoTeam.circle;
                getEl('bravo-team-name').textContent = bravoTeam.teamName;

                for (let i = 0; i < 4; i++) {
                    const player = players[i];
                    const el = getEl(`bravo-member${i + 1}`);
                    if (player) {
                        el.textContent = formatPlayerName(player, maxXP, 'bravo');
                        applyXpHighlight(el, player.xp);
                        totalXP += player.xp;
                    } else {
                        el.textContent = '';
                    }
                }
                const avgXP = players.length > 0 ? (totalXP / players.length).toFixed(1) : '----';
                getEl('bravo-xp-avg').textContent = `平均XP：${avgXP}`;
                applyXpHighlight(getEl('bravo-xp-avg'), parseFloat(avgXP));
            }

            const bestOf = state.bestOf || 'BO3';
            getEl('round').innerHTML = `${state.roundInfo || 'ラウンド情報'}<br>${bestOf}`;

            const stages = state.stages || [];
            const alphaScore = stages.filter(s => s.winner === 'alpha').length;
            const bravoScore = stages.filter(s => s.winner === 'bravo').length;
            getEl('alpha-points').textContent = alphaScore;
            getEl('bravo-points').textContent = bravoScore;

            const winEl = getEl('win');
            const matchPoint = bestOf === 'BO5' ? 3 : 2;
            winEl.className = 'progress';
            getEl('main-section').querySelector('.alpha').classList.remove('loser-team');
            getEl('main-section').querySelector('.bravo').classList.remove('loser-team');
            getEl('alpha-points').classList.remove('alpha-points-loser');
            getEl('bravo-points').classList.remove('bravo-points-loser');

            if (alphaScore >= matchPoint) {
                winEl.classList.add('alpha-win');
                getEl('main-section').querySelector('.bravo').classList.add('loser-team');
                getEl('bravo-points').classList.add('bravo-points-loser');
            } else if (bravoScore >= matchPoint) {
                winEl.classList.add('bravo-win');
                getEl('main-section').querySelector('.alpha').classList.add('loser-team');
                getEl('alpha-points').classList.add('alpha-points-loser');
            }

            const stageContainer = getEl('stage-section');
            stageContainer.innerHTML = '';
            const numGames = bestOf === 'BO5' ? 5 : 3;
            for (let i = 0; i < numGames; i++) {
                const game = stages[i] || { stage: '未決定', winner: null };
                const stageName = game.stage || '未決定';

                // ★変更点: ファイルパス修正
                let imgSrc = `../stage-image/${stageName}.png`;
                if (game.winner === 'alpha') {
                    imgSrc = `../stage-alph/${stageName}.png`;
                } else if (game.winner === 'bravo') {
                    imgSrc = `../stage-bravo/${stageName}.png`;
                }

                const imgElement = document.createElement('img');
                imgElement.className = 'stage';
                imgElement.src = imgSrc;
                imgElement.onerror = () => { imgElement.src = '../stage-image/未決定.png'; };
                stageContainer.appendChild(imgElement);
            }
        }

        sessionDocRef.onSnapshot((doc) => {
            if (doc.exists) {
                updateDisplay(doc.data());
            } else {
                console.log("No such document!");
            }
        }, (error) => {
            console.log("Error getting document:", error);
        });
    </script>
</body>

</html>